define("dashboard/dashboard",[],function(){function d(){var a=$(window).width(),e=$(window).height();$("body").hasClass("hide-sidebar")?t.css("width",a-64-20):t.css("width",a-280-20),1920<=a?t.css("overflow-x","hidden"):t.css("overflow-x","auto"),1080<=e?t.css("overflow-y","hidden"):t.css("overflow-y","auto")}var l,h,u,g,f,i=window.Util,p=$(".grid-stack"),s=!1,c=!1,m=$("#drawer"),t=$("#dashboard"),a=$("#dashboard-empty-card-area-message"),n=$("#dashboard-empty-card-area-grid"),v=window.MAIN_WINDOW,r=new window.CommonLoadingPanel,o=window.Session,b=window.kendo,w=window.I18N,C=$("<div/>").kendoCommonDialog().data("kendoCommonDialog"),y=m.find(".drawer-container"),k=$("#main"),e=$("#main-sidebar"),T=m.find(".btn-drawer"),D=m.find(".card"),O=$("#dashboard-card-template"),x=m.find(".content .ico").eq(0),A=e.outerWidth(),_=[],M=!0,I={scroll:!1,cursor:"move",handle:".dashboard-card-wrapper",appendTo:"#dashboard .grid-stack",revertDuration:!1,opacity:.7,cursorAt:{top:100,left:100},refreshPositions:!0,start:function(a,e){if(y.removeClass("overflow"),k.removeClass("no-drop"),$.ui.ddmanager.droppables.default[0].isover=!1,!s&&!c){s=!0;var d=e.helper;if(e.helper.data("multiple")){var t=e.helper.clone();t.css("opacity",1),t.removeClass("ui-draggable-dragging"),t.insertAfter(e.helper),t.draggable(I)}var r=d.data("width"),o=d.data("height");d.width(l.cellWidth()*r),d.height(l.cellHeight()*o),d.attr("data-gs-width",r),d.attr("data-gs-height",o),d.removeClass("card"),e.helper.find(".count").remove(),e.helper.find(".dashboard-card-drawer-category").remove(),d.addClass("dashboard-card-dragging")}},stop:function(a){k.removeClass("no-drop"),s=!1;var e=$(this);if(c){e.data("multiple")&&e.remove(),c=!1,e.removeClass("dashboard-card-dragging"),e.addClass("card"),e.css("width","50%"),e.css("height","210px");var d=e.find(".dashboard-card-body");d.empty();var t=$("<img/>").addClass("dashboard-card-drawer-category").attr("src",i.addBuildDateQuery("../../src/main/resources/static-dev/images/icon/ic_drawer_chart_"+e.data("view-type")+".png")),r=e.find(".dashboard-card-header"),o=$(this).data("width"),n=$(this).data("height");$("<div/>").addClass("count").data("role","cardCount").append($("<span/>").addClass("row").text(o)).append("X").append($("<span/>").addClass("col").text(n)).appendTo(r),t.appendTo(d),l.willItFit(0,0,o,n,!0)||(C.message(w.prop("DASHBOARD_NO_AREA_TO_ADD_CARD")),C.open())}l.batchUpdate(),l.commit(),y.addClass("overflow"),F("stop")},revert:function(){return c=!!this.hasClass("ui-draggable-dragging")},drag:function(a,e){E(a,e),F("drag")}},E=function(a,e){var d=e.helper;d.index();d.index();var t=d.outerWidth(),r=d.outerHeight(),o=k.offset(),n=p.offset(),i=e.offset.left-A-o.left-0,s=e.offset.top-n.top-0,c=m.offset().left-A-o.left-100;console.info(d),console.info(i),console.info(c),i<u||s<h||g<i+t||f<s+r?k.addClass("no-drop"):k.removeClass("no-drop"),i<c&&m.addClass("close")},H={width:10,height:12,cellHeight:70,verticalMargin:14,disableResize:!0,disableOneColumnMode:!0,acceptWidgets:".dashboard-card-item",float:!0,draggable:{cursor:"move",handle:".dashboard-card-header",opacity:.7,scroll:!1}},N=function(){var a,e=v.getMenuConfig(),d=e.alarmlog;d&&d.subMenu&&d.subMenu.alarm&&d.subMenu.alarm.isHiddenMenu&&$(".dashboard-card-item[data-type='alarmLog']").remove();var t=e.facility;if(_=[],t&&t.subMenu&&t.subMenu.device){var r,o,n=t.subMenu.device.tabs,i=n.length;for(a=!0,r=0;r<i;r++)(o=n[r]).enabled?a=!1:(_.push(o.name),"AirConditioner.Indoor"==o.name&&($(".dashboard-card-item[data-type='deviceStatusOff']").remove(),$(".dashboard-card-item[data-type='deviceStatusOn']").remove()))}a&&$(".dashboard-card-item[data-type='facilityOperation']").remove()},R=function(){p.find(".dashboard-card-item").each(function(){var a=$(this).data("kendoCard");void 0===a.options.refreshOption&&a.refresh()})},S=function(){T.on("click",function(){var a;a="close",m.toggleClass(a)}),x.on("click",function(){m.addClass("close")}),$("#main-sidebar-menu").find(".btn-util").on("click",".btn",function(a){d()}),m.on("click",".ic-dashboard-drawer-arrow",function(){var a=$(this),e=a.closest(".card-category").next(".card-box");a.hasClass("down")?(a.removeClass("down"),e.slideDown(300)):(a.addClass("down"),e.slideUp(300))}),M?(m.on("click",".card",B),D.draggable(I),p.on("change",function(a,e){if(e){var d,t,r,o=e.length;for(r=0;r<o;r++)(t=e[r].el).hasClass("dashboard-card-dragging")?(t.removeClass("dashboard-card-dragging"),d=t.kendoCard({drawerElement:m,cardDraggableOptions:I}).data("kendoCard"),W(d),L(e[r].el,$(e[r].el).data("kendoCard"))):t.hasClass("dashboard-card-addClicking")?(t.removeClass("dashboard-card-addClicking"),W($(t).data("kendoCard")),L(e[r].el,$(e[r].el).data("kendoCard"))):j(e[r].el,$(e[r].el).data("kendoCard"))}F("change")}),p.on("dropactivate",function(a){}),p.on("dropover",function(a){}),p.on("dragstop",function(a){k.removeClass("no-drop"),F("stop")}),p.on("drag",".dashboard-card-item",function(a,e){!function(a){var e=a.helper,d=a.position.left,t=a.position.top;console.info(a.helper);var r=e.outerWidth(),o=e.outerHeight();d<u||t<h||g<d+r||f<t+o?k.addClass("no-drop"):k.removeClass("no-drop")}(e),F("drag")}),p.on("stop",".dashboard-card-item",function(a){k.removeClass("no-drop")})):m.on("mousedown",".card",function(){C.message(w.prop("COMMON_NOT_AUTHORIZED")),C.open()})};function U(a){var e=a.data("type"),d=a.data("width"),t=a.data("height"),r=a.attr("data-gs-x"),o=a.attr("data-gs-y"),n=a.attr("data-time");n||(n=(new Date).getTime(),a.attr("data-time",n));var i=a.data("view-type"),s=a.data("category"),c=a.find(".title").text(),l=a.hasClass("dashboard-card-lock"),h=!!a.data("multiple"),u=a.attr("data-message");return{id:e=h?e+"."+d+"."+t+"."+n:e+"."+d+"."+t,width:d,height:t,coordinate:[r,o],stores:[{key:"viewType",value:i},{key:"category",value:s},{key:"title",value:c},{key:"pinned",value:l},{key:"multiple",value:h},{key:"message",value:u=u||""},{key:"createdTime",value:n}]}}var W=function(a){a.bind("onClose",function(a){z(a.sender.element,a.sender)}),a.bind("onPin",function(a){j(a.sender.element,a.sender)}),a.bind("onChange",function(a){z(a.sender.element,a.sender)}),a.bind("onChanged",function(a){L(a.sender.element,a.sender)})},P=function(e){!function(a){var e,d,t,r,o=a.coordinate;if(a.x=o[0],a.y=o[1],a.stores)for(r=(t=a.stores).length,d=0;d<r;d++)a[t[d].key]=t[d].value;a.message||(a.message=""),a.createdTime||(a.createdTime=""),a.multiple,e=a.id.split("."),a.id=e[0]}(e);var a=b.template(O.html())(e),d=window.GlobalSettings.getLocale();D.each(function(){var a=$(this);return!!a.data("multiple")||(a.data("type")==e.id&&a.data("width")==e.width&&a.data("height")==e.height?(a.remove(),!1):void 0)}),"ko"!==d&&"energyPeak"==e.id||p.append(a)},L=function(a){var e=U(a),d=o.getUserId();$.ajax({url:"/ums/users/"+d+"/dashboardCards",method:"POST",data:e}).done(function(){}).fail(function(){}).always(function(){})},j=function(a){var e=U(a),d=e.id;delete e.id;var t=o.getUserId();$.ajax({url:"/ums/users/"+t+"/dashboardCards/"+d,method:"PATCH",data:e}).done(function(){}).fail(function(){}).always(function(){})},z=function(a){var e=U(a),d=e.id;delete e.id;var t=o.getUserId();return $.ajax({url:"/ums/users/"+t+"/dashboardCards/"+d,method:"DELETE"}).done(function(){}).fail(function(){}).always(function(){})},B=function(a){var e,d,t=a.currentTarget.dataset.type,r=a.currentTarget.dataset.width,o=a.currentTarget.dataset.height,n=a.currentTarget.dataset.category,i=a.currentTarget.dataset.multiple,s=a.currentTarget.dataset.viewType,c=b.template(O.html())({type:t,width:r,height:o,category:n,multiple:i,viewType:s,createdTime:(new Date).getTime(),x:0,y:0,id:t,title:"",message:"",pinned:!1});(d=$(c)).addClass("dashboard-card-addClicking"),l.willItFit(0,0,r,o,!0)?(p.append(d),e=d.kendoCard({drawerElement:m,cardDraggableOptions:I}).data("kendoCard"),l.addWidget(e.element,0,0,r,o,!0),i||(D=m.find(".card")).each(function(a,e){var d=$(e);d.data("type")==t&&d.data("width")==r&&d.data("height")==o&&d.remove()})):(C.message(w.prop("DASHBOARD_NO_AREA_TO_ADD_CARD")),C.open())},F=function(a){var e=$(".dashboard-grid-wrapper").find(".grid-stack-item").length;"init"==a?0<e?J():G():"drag"==a?(J(),Q()):"stop"==a?(0==e&&G(),X()):"change"==a&&(0<e?J():G())},q=function(a,e,d){var t,r,o;for(t=0;t<d;t++)r=$("<div></div>").addClass("dashboard-empty-card-area-wrapper"),(o=$("<div></div>").addClass("dashboard-empty-card-area-inner")).css({width:a+"px",height:e+"px"}),r.append(o),n.append(r)},G=function(){a.css({display:"block"})},J=function(){a.css({display:"none"})},Q=function(){n.css({display:"block"})},X=function(){n.css({display:"none"})};return function(){$("body").css({overflow:"hidden","background-color":"#fbfbfb"}),$(window).on("resize",d),d(),q(304,322,15);var a=$("#dashboard").width();u=h=-25,g=a+25,f=1115;var e=o.getUserId();r.open(),$.ajax({url:"/ums/users/"+e+"/dashboardCards"}).done(function(a){var e,d=a.length;for(e=0;e<d;e++)P(a[e]);l=p.gridstack(H).data("gridstack")}).fail(function(a){93==a.responseJSON.code&&(M=!1)}).always(function(){N(),p.find(".dashboard-card-item").each(function(){var a=$(this).kendoCard({drawerElement:m,cardDraggableOptions:I}).data("kendoCard");W(a)}),S(),setInterval(R,6e4),$(window).trigger("resize"),F("init"),r.close()})}(),{getDisableTypeList:function(){return _},editCard:j}});