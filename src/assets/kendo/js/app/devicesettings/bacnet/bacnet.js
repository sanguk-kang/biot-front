define("devicesettings/bacnet/bacnet-client/bacnet-client",["devicesettings/core"],function(){var l,u,p,m=new window.CommonLoadingPanel,r=window.Util,c=window.I18N,t=window.MAIN_WINDOW,v=window.kendo,a=c.prop("BACNET_DEVICE_NAME"),o=c.prop("BACNET_DEVICE_ID"),i=c.prop("SETTINGS_NETWORK_ID"),d=c.prop("BACNET_MATCHED_OBJECTS"),s=c.prop("BACNET_NUMBER_OF_OBJECTS"),b=c.prop("SETTINGS_BTN_DETAIL"),f=$("#device-setting-bacnet-tab"),_=$("#popup-sac-bacnet-device-confirm"),k=$("#popup-sac-bacnet-device-message"),N="/bacnet/client/",h=$(".sac-bacnet-contents.client").find(".content").find(".detail").find("input[data-role=bacnetclientportnumber]"),g=$(".sac-bacnet-contents.client").find(".content").find(".detail").find("input[data-role=bacnetclientdeviceidlow]"),E=$(".sac-bacnet-contents.client").find(".content").find(".detail").find("input[data-role=bacnetclientdeviceidhigh]"),T=$(".sac-bacnet-contents.client").find(".content").find("button[data-event=bacnetclientdiscover]"),C=$(".sac-bacnet-contents.client").find(".sac-bacnet-category.connectionlist").find("button[data-event=bacnetclientupdateall]"),x=!1,I=$(".sac-bacnet-contents.client").find(".sac-bacnet-category.connectionlist").find("button[data-event=bacnetclientconnectionlistdelete]"),y=$("#popup-sac-bacnet-client"),O=y.find(".popup-detail-connectionlist-grid"),S=[],A=[],P=$(".sac-bacnet-contents.client").find(".sac-bacnet-category").find(".sac-bacnet-grid-connectionlist"),D=[],w=[],B=null,M={priorities:{optionsLabel:"Priority",data:function(){for(var e=[],t=0;t<16;t++){var n={value:null,text:null};n.value=t+1,n.text="Out "+(t+1),e.push(n)}return e}},dms_devices_mappedType:{optionsLabel:"Type",data:function(){return[{value:"ControlPoint",text:c.prop("SETTINGS_MENUCONFIGURE_POINT")},{value:"Light",text:c.prop("SETTINGS_MENUCONFIGURE_LIGHT")},{value:"Sensor.Temperature",text:c.prop("SETTINGS_TEMPERATURE_SENSOR")},{value:"Meter.WattHour",text:c.prop("SETTINGS_ENERGY_METER")},{value:"Sensor.Humidity",text:c.prop("SETTINGS_HUMIDITY_SENSOR")},{value:"Sensor.Motion",text:c.prop("SETTINGS_MENUCONFIGURE_MOTION")}]}},dms_devices_type:{optionsLabel:"I/O type",data:function(){return[{value:"ControlPoint.AI",text:"AI"},{value:"ControlPoint.AO",text:"AO"},{value:"ControlPoint.AV",text:"AO"},{value:"ControlPoint.BI",text:"DI"},{value:"ControlPoint.BO",text:"DO"},{value:"ControlPoint.BV",text:"DO"},{value:"ControlPoint.MI",text:"AI"},{value:"ControlPoint.MO",text:"AO"},{value:"ControlPoint.MV",text:"AO"}]}},managePoint_unit:{data:function(){return[{value:"Celsius",text:"\xb0C"},{value:"Fahrenheit",text:"\xb0F"},{value:"kilowattHour",text:"Kwh"},{value:"Percent",text:"%"}]}}},V={bacNetClientPopupGridIoType:{"ControlPoint.AI":{value:"ControlPoint.AI",text:"AI"},"ControlPoint.AO":{value:"ControlPoint.AO",text:"AO"},"ControlPoint.AV":{value:"ControlPoint.AV",text:"AO"},"ControlPoint.BI":{value:"ControlPoint.DI",text:"DI"},"ControlPoint.BO":{value:"ControlPoint.DO",text:"DO"},"ControlPoint.BV":{value:"ControlPoint.DO",text:"DO"},"ControlPoint.MI":{value:"ControlPoint.AI",text:"AI"},"ControlPoint.MO":{value:"ControlPoint.AO",text:"AO"},"ControlPoint.MV":{value:"ControlPoint.AO",text:"AO"}},bacNetMappedType:{ControlPoint:c.prop("SETTINGS_MENUCONFIGURE_POINT"),Light:c.prop("SETTINGS_MENUCONFIGURE_LIGHT"),"Sensor.Temperature":c.prop("SETTINGS_TEMPERATURE_SENSOR"),"Sensor.Humidity":c.prop("SETTINGS_HUMIDITY_SENSOR"),"Sensor.Motion":c.prop("SETTINGS_MENUCONFIGURE_MOTION"),"Meter.WattHour":c.prop("SETTINGS_ENERGY_METER")}},R=window.CommonWebSocket,e=function(){var n,e;t.disableFloorNav(!0),f.data("kendoCommonTabStrip")||f.kendoCommonTabStrip(),l=_.kendoCommonDialog({type:"confirm"}).data("kendoCommonDialog"),u=k.kendoCommonDialog().data("kendoCommonDialog"),T.kendoButton({enable:!0}),C.kendoButton(),I.kendoButton({enable:!1}),P.kendoGrid({dataSource:[],columns:(e=[{field:"checkbox",title:"",sortable:!(n=[])},{field:"name",title:a,sortable:!1},{field:"id",title:o,sortable:!1},{field:"networkId",title:i,sortable:!1},{field:"numberOfObjects",title:s,sortable:!1},{field:"numberOfMappedDevices",title:d,sortable:!1},{field:"detail",title:b,sortable:!1}],$.each(e,function(e,t){"checkbox"==t.field?n.push({headerTemplate:"<input type='checkbox' class='k-checkbox' data-event='devicecheckall' id='bacnet-connection-list-check-all'><label class='k-checkbox-label' for='bacnet-connection-list-check-all'></label>",template:function(e){return"<input type='checkbox' data-event='devicecheck' class='k-checkbox' id='bacnet-connection-list-check-"+e.id+"'/><label class='k-checkbox-label' for='bacnet-connection-list-check-"+e.id+"'></label>"},width:100,sortable:t.sortable}):"detail"==t.field?n.push({title:t.title,template:function(e){return"<span class='ic ic-info' data-event='devicedetailico' data-for='"+e.id+"'></span>"},sortable:t.sortable}):n.push({field:t.field,title:t.title,template:function(e){return function(e,t){var n;return e[t.field]=r.getValueFilteredForXSS(e[t.field]),n=e[t.field]?e[t.field]:"-","<span class='sac-bacnet-connectionlist-grid-"+t.field+"'>"+n+"</span>"}(e,t)},sortable:t.sortable})}),n),height:"100%",scrollable:!0}),(D=new v.data.DataSource({data:[]})).read(),P.data("kendoGrid").setDataSource(D),h.kendoCommonValidator({type:"onlyNumber"}),g.kendoCommonValidator({type:"onlyNumber",rules:{maxNumber:function(e){return!(4194303<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<0)}},messages:{maxNumber:c.prop("COMMON_INVALID_VALUE"),minNumber:c.prop("COMMON_INVALID_VALUE")}}),E.kendoCommonValidator({type:"onlyNumber",rules:{maxNumber:function(e){return!(4194303<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<0)}},messages:{maxNumber:c.prop("COMMON_INVALID_VALUE"),minNumber:c.prop("COMMON_INVALID_VALUE")}}),R.on("receive",function(e){(function(e){function t(e){this.id=e.id?e.id:null,this.name=e.name?e.name:null,this.networkId=e.networkId?e.networkId:null,this.numberOfObjects=e.numberOfObjects?e.numberOfObjects:null,this.numberOfMappedDevices=e.numberOfMappedDevices?e.numberOfMappedDevices:null,0==e.numberOfObjects&&(this.numberOfObjects=0),0==e.numberOfMappedDevices&&(this.numberOfMappedDevices=0)}function n(e){this.id=e.id?e.id:null,this.name=e.name?e.name:null,this.type=e.type?e.type:null,this.description=e.description?e.description:null,this.priorities=e.priorities?e.priorities:null,this.dms_devices_type=e.dms_devices_type?e.dms_devices_type:null,this.dms_devices_mappedType=e.dms_devices_mappedType?e.dms_devices_mappedType:null,this.dms_devices_controlPoint_tagName=e.dms_devices_controlPoint_tagName?e.dms_devices_controlPoint_tagName:null,this.dms_devices_controlPoint_value=e.dms_devices_controlPoint_value?e.dms_devices_controlPoint_value:null}var a,o,i,l,d,r,c="/bacnet/client/devices/",s=y.data("kendoPopupSingleWindow").options.visible;if("AsyncUpdate"==e.type)if(-1!=e.url.indexOf(c)&&e.url.length>c.length){if(s){var u=e.url.split("/"),p=u[u.length-1],m=y.attr("device-id");if(a=O.data("kendoGrid").tbody,m==p)for(i=0;i<e.body.length;i++){o=e.body[i];var v=new n(o),b=S.get(v.id);if(b)for(l in d=a.find("tr[data-uid="+b.uid+"]"),v){b[l]=v[l];var f=(r=d.find(".sac-bacnet-connectionlist-grid-cell[data-field="+l+"]")).attr("data-type");if("string"==f)if("priorities"==l)for(var _=0;_<v[l].length;_++){if(1==v[l][_]){r.text("Out "+String(_+1));break}r.text("-");break}else"dms_devices_type"==l?V.bacNetClientPopupGridIoType[v[l]]?r.text(V.bacNetClientPopupGridIoType[v[l]].text):r.text("-"):r.text(v[l]);else"input"==f?r.val(v[l]):"dropdownlist"==f&&(r.data("kendoDropDownList").value(v[l]),v[l]&&r.data("kendoDropDownList").enable(!0))}else!b&&v.id&&S.add(v)}}}else if(e.url==c)for(a=P.data("kendoGrid").tbody,i=0;i<e.body.length;i++){o=e.body[i];var k=new t(o),N=D.get(o.id)?D.get(o.id):null;if(N)for(l in d=a.find("tr[data-uid="+N.uid+"]"),k)"numberOfMappedDevices"!=l&&(N[l]=k[l],(r=d.find(".sac-bacnet-connectionlist-grid-"+l)).text(k[l]));else k.id&&D.add(k)}})(e)})},n=function(){h.on("keyup",function(){for(var e=$(this).val(),t=T.data("kendoButton"),n=$(this).closest(".sac-bacnet-category").find("input"),a=""==e,o=!0,i=0;i<n.length;i++){if(!n.eq(i).data("kendoCommonValidator").validate()){o=!1;break}o=!0}t.enable(!a&&o&&!0)}),g.on("keyup",function(){var e=$(this).val(),t=T.data("kendoButton"),n=h.val(),a=E.val(),o=$(this).closest(".sac-bacnet-category").find("input"),i=""==n,l=!0,d=!0;e&&a&&(d=Number(e)<=Number(a));for(var r=0;r<o.length;r++){if(!o.eq(r).data("kendoCommonValidator").validate()){l=!1;break}l=!0}t.enable(!i&&l&&d)}),E.on("keyup",function(){var e=$(this).val(),t=T.data("kendoButton"),n=h.val(),a=g.val(),o=$(this).closest(".sac-bacnet-category").find("input"),i=""==n,l=!0,d=!0;e&&a&&(d=Number(e)>=Number(a));for(var r=0;r<o.length;r++){if(!o.eq(r).data("kendoCommonValidator").validate()){l=!1;break}l=!0}t.enable(!i&&l&&d)}),T.on("click",function(e){var t=h.val(),n=g.val(),a=E.val(),o=[],i=N+"devices?portNumber="+t;o=""==n&&""==a?[0,4194303]:""==n?(i=i+"&idHigh="+a,[0,a]):""==a?(i=i+"&idLow="+n,[n,4194303]):(i=i+"&idLow="+n+"&idHigh="+a,[n,a]),m.open(),$.ajax({url:i}).done(function(e){e.length<1&&(u.message(c.prop("BACNET_MESSAGE_CLIENT_NOT_DISCOVERED")),u.open());for(var t=e.length-1;0<=t;t--)e[t].id||e.splice(t,1);(D=new v.data.DataSource({data:e})).read(),P.data("kendoGrid").setDataSource(D),w=[],g.val(o[0]),E.val(o[1])}).fail(function(){u.message(c.prop("BACNET_MESSAGE_CLIENT_NOT_DISCOVERED")),u.open()}).always(function(){m.close()})}),C.on("click",function(){var t,e=N+"devices?ids=",n=D.data(),a=[];for(t=0;t<n.length;t++)a.push(n[t].id);e+=a.toString(),x&&(e=N+"devices?ids=",x=!1),m.open(),$.ajax({url:e}).done(function(e){for(t=e.length-1;0<=t;t--)e[t].id||e.splice(t,1);(D=new v.data.DataSource({data:e})).read(),P.data("kendoGrid").setDataSource(D),w=[]}).fail(function(e){u.message(e.responseText),u.open()}).always(function(){m.close()})}),I.on("click",function(){var e,t,n=[],a=N+"devices",o=w.length;for(t=0;t<o;t++){var i=D.data()[w[t]].id;n.push(i)}e=n.toString(),o<=D.data().length&&(a=a+"?ids="+e),l.message(c.prop("BACNET_CONFIRM_DELETE_DEVICE")),l.setConfirmActions({yes:function(e){m.open(),$.ajax({url:a,method:"DELETE"}).done(function(){for(t=o-1;0<=t;t--){var e=D.at(w[t]);D.remove(e)}u.message(c.prop("BACNET_MESSAGE_SELECTED_DEVICE_DELETED")),w=[]}).fail(function(e){u.message(e.responseText)}).always(function(){u.open(),m.close()})},no:function(e){}}),l.open()})},L=function(){P.on("click","input[data-event=devicecheckall]",function(e){var t=$(this),n=t.closest(".k-grid").find("input[data-event=devicecheck]");w=[],t.is(":checked")?n.each(function(e,t){t.checked=!0,w.push(e)}):n.each(function(e,t){t.checked=!1,w=[]}),j()}),P.on("click","input[data-event=devicecheck]",function(e){var t=$(this),n=t.closest(".k-grid").find("input[data-event=devicecheck]"),a=t.closest(".k-grid").find("input[data-event=devicecheckall]"),o=n.index(this);t.is(":checked")?(B=o,w.push(o)):(n.checked=!1,w=$.grep(w,function(e){return e!=o})),w.sort(function(e,t){return e-t}),j(),w.length<D.data().length?a.prop("checked",!1):w.length==D.data().length&&a.prop("checked",!0)}),P.data("kendoGrid").bind("dataBound",function(){P.find("input[data-event=devicecheckall]").prop("checked",!1),I.data("kendoButton").enable(!1)}),P.on("click","span[data-event=devicedetailico]",function(e){var a,t,n,o,i,l,d,r,c=$(e.target),s=c.closest("tbody").find("tr").index(c.closest("tr"));t=B=s,n=(a=y).data("kendoPopupSingleWindow"),o=D.data()[t].id,i={},l=a.find(".popup-header-info").find(".device-name"),d=a.find(".popup-container").find(".popup-detail-row").find("span[data-role=bacnetid]"),r=a.find(".popup-container").find(".popup-detail-row").find("span[data-role=networkid]"),a.attr("device-id",o),n.openWindowPopup(),A=[],m.open(a),$.ajax({url:N+"devices/"+o}).done(function(e){i=e;for(var t=0;t<i.objects.length;t++){var n=i.objects[t];"Meter"==n.dms_devices_mappedType&&(n.dms_devices_mappedType="Meter.WattHour")}(S=new v.data.DataSource({data:i.objects})).read(),p.setDataSource(S),p.content[0].scrollTop=0,l.text(i.name),d.text(i.id),d.attr("data-value",i.id),r.attr("data-value",i.networkId),r.text(i.networkId),a.find(".k-button[data-event=save]").data("kendoButton").enable(!1)}).fail(function(e){u.message(e.responseText),u.open()}).always(function(){m.close(a)})})},G=function(){function n(e,t){var n,a,o,i;if(n=t.field,"string"==(a=t.type)&&(e[n]=r.getValueFilteredForXSS(e[n])),null===e[t.field]||void 0===e[t.field]||""==e[t.field]||"NONE"==e[t.field])o="priorities"==t.field?"-":"dms_devices_controlPoint_value"==t.field?"0.0"==e[t.field]?"0.0":"0"==e[t.field]?"0":"-":"-";else if("priorities"==n)for(var l=0;l<e[t.field].length;l++){if(1==e[t.field][l]){o="Out "+String(l+1);break}o="-"}else if("dms_devices_type"==n){var d=e.type;o=e.type?e.type:"-",-1<d.indexOf("AI")||-1<d.indexOf("MI")?o="AI":-1<d.indexOf("AO")||-1<d.indexOf("AV")||-1<d.indexOf("MO")||-1<d.indexOf("MV")?o="AO":-1<d.indexOf("DI")||-1<d.indexOf("BI")?o="DI":(-1<d.indexOf("BO")||-1<d.indexOf("BO")||-1<d.indexOf("BV"))&&(o="DO")}else o="dms_devices_controlPoint_value"==n?e[t.field].toFixed(1):e[t.field];return"string"==a?i="<span class='sac-bacnet-connectionlist-grid-cell' data-field='"+n+"' data-type='string' data-value='"+o+"'>"+o+"</span>":"input"==a?i="<input class='k-input sac-bacnet-connectionlist-grid-cell' data-field='"+n+"' data-type='input' data-value='"+o+"'/>":"dropdownlist"==a&&(i="<input class='sac-bacnet-connectionlist-grid-cell' data-field='"+n+"' data-type='dropdownlist' data-value='"+o+"'/>"),i}var a,o,e,t;y.kendoPopupSingleWindow({title:c.prop("COMMON_BTN_DETAIL"),width:1500,height:800}),p=O.kendoGrid({dataSource:[],columns:(a=[],o=[],e=[{field:"type",title:c.prop("BACNET_OBJECT_IO_TYPE"),sortable:!1,type:"string"},{field:"name",title:c.prop("BACNET_OBJECT_NAME"),sortable:!1,type:"string"},{field:"dms_devices_controlPoint_value",title:c.prop("BACNET_PRESENT_VALUE"),sortable:!1,type:"string"},{field:"priorities",title:c.prop("BACNET_PRIORITY_ARRAY"),sortable:!1,type:"string"},{field:"description",title:c.prop("SETTINGS_DEVICE_DESCRIPTION"),sortable:!1,type:"string"}],t=[{field:"dms_devices_mappedType",title:c.prop("SETTINGS_DEVICE_TYPE"),sortable:!1,type:"dropdownlist"},{field:"dms_devices_type",title:c.prop("BACNET_IO_TYPE"),sortable:!1,type:"string"},{field:"dms_devices_controlPoint_tagName",title:c.prop("BACNET_DEVICE_NAME"),sortable:!1,type:"input"}],$.each(e,function(e,t){a.push({field:t.field,title:t.title,template:function(e){return n(e,t)},sortable:t.sortable})}),$.each(t,function(e,t){o.push({field:t.field,title:t.title,template:function(e){return n(e,t)},sortable:t.sortable})}),a.push({title:c.prop("BACNET_MATCHED_IO"),columns:o}),a),height:550,scrollable:!0}).data("kendoGrid")},U=function(){var s=y.find(".popup-container").find(".popup-detail-row").find("input[data-role=networkid]");s.on("keyup",function(){$(this).val()!=$(this).attr("data-value")?y.find(".k-button[data-event=save]").data("kendoButton").enable(!0):y.find(".k-button[data-event=save]").data("kendoButton").enable(!1)}),y.on("click",".k-button[data-event=creatematchedio]",function(){for(var e=p.tbody.find("tr"),t=0;t<e.length;t++){var n=e.eq(t),a=n.find("input[data-field=dms_devices_mappedType]").data("kendoDropDownList"),o=n.find("input[data-field=dms_devices_controlPoint_tagName]"),i=n.find("span[data-field=name]"),l=a.value(),d=o.val();a.text(c.prop("SETTINGS_MENUCONFIGURE_POINT")),a.enable(!0),o.val(i.text()),a.value()!=l&&W(a.element,A),o.val()!=d&&W(o,A)}0<A.length?y.find(".k-button[data-event=save]").data("kendoButton").enable(!0):y.find(".k-button[data-event=save]").data("kendoButton").enable(!1)}),y.on("click",".k-button[data-event=save]",function(e){var t={},n=y.attr("device-id"),a=s.val(),o=s.attr("data-value"),i=A.length;if(a!=o&&(t.networkId=a),0<i){t.objects=[];for(var l=0;l<i;l++){var d=A[l],r=p.table.find("tr[data-uid="+d+"]"),c={id:p.dataSource.getByUid(r.data("uid")).id,dms_devices_mappedType:r.find("input[data-field=dms_devices_mappedType]").data("kendoDropDownList").value(),dms_devices_controlPoint_tagName:r.find("input[data-field=dms_devices_controlPoint_tagName]").val()};t.objects.push(c)}}m.open(y),$.ajax({url:N+"devices/"+n,method:"PATCH",data:t}).done(function(){var e,t,n,a,o,i,l,d,r;m.close(y),e=y,t=B,n="SAVE",a=D.data()[t].id,o={},i=e.find(".popup-header-info").find(".device-name"),l=e.find(".popup-container").find(".popup-detail-row").find("span[data-role=bacnetid]"),d=e.find(".popup-container").find(".popup-detail-row").find("input[data-role=networkid]"),r=e.find(".popup-footer").find(".k-button[data-event=save]"),m.open(e),$.ajax({url:N+"devices/"+a}).done(function(e){o=e;for(var t=0;t<o.objects.length;t++){var n=o.objects[t];"Meter"==n.dms_devices_mappedType&&(n.dms_devices_mappedType="Meter.WattHour")}(S=new v.data.DataSource({data:o.objects})).read(),p.setDataSource(S),i.text(o.name),l.text(g.val()+" ~ "+E.val()),d.val(o.networkId),A=[]}).fail(function(e){u.message(e.responseText),u.open()}).always(function(){m.close(e),"SAVE"==n&&r.data("kendoButton").enable(!1)})}).fail(function(e){m.close(y),u.message(e.responseText),u.open()})}),y.on("click",".k-button[data-event=close]",function(){})},F=function(){p.bind("dataBound",function(){!function(){for(var e=O.find(".k-grid-content").find("tbody").find("tr"),t=0;t<e.length;t++)for(var n=e.eq(t).find("td"),a=0;a<n.length;a++){var o=n.eq(a).find("[data-type]"),i=o.attr("data-type"),l=o.attr("data-value"),d=o.attr("data-field");"input"==i?(o.val(l),o.on("keyup",function(e){$(this).val()!=$(this).attr("data-value")&&(W($(this),A),y.find(".k-button[data-event=save]").data("kendoButton").enable(!0))})):"dropdownlist"==i&&(o.kendoDropDownList({optionsLabel:M[d].optionsLabel,dataSource:M[d].data(),dataTextField:"text",dataValueField:"value",change:function(e){var t=$(this.element),n=this.value();t.attr("data-value")!=n&&W(t,A),y.find(".k-button[data-event=save]").data("kendoButton").enable(!0)}}),"-"!=l&&"NONE"!=l&&""!=l&&l?(o.data("kendoDropDownList").value(l),o.data("kendoDropDownList").trigger("change")):(o.data("kendoDropDownList").text("-"),o.data("kendoDropDownList").enable(!1)))}}()})};function j(){0==w.length?I.data("kendoButton").enable(!1):I.data("kendoButton").enable(!0)}function W(e,t){var n=!1,a=$(e).closest("tr").attr("data-uid");if(0==t.length)t.push(a);else{for(var o=0;o<t.length;o++){if(t[o]==a){n=!0;break}n=!1}n||t.push(a)}}return function(){e(),G(),L(),U(),F(),n(),h.val(47808),T.data("kendoButton").enable(!0)}}),define("devicesettings/bacnet/bacnet-server/bacnet-server",["devicesettings/core"],function(){function s(){this.dms_devices_id=null,this.checked=!1,this.show=!1,this.type=null,this.dms_devices_controlPoint_tagName=null,this.name=null,this.dms_devices_mappedType=null,this.dms_devices_controlPoint_value=null,this.instanceNumber=null,this.calcInstanceNumber=null,this.displaydeviceTypeText=null,this.unit=null,this.writable=!1,this.priorities=[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],this.hasInstanceNumber=!1}var k,d,r,c,u,p,m,v,b=new window.CommonLoadingPanel,f=window.Util,_=window.I18N,N=window.kendo,h=_.prop("BACNET_SERVER_RUNNING"),g=_.prop("BACNET_SERVER_STOP"),E=_.prop("BACNET_MESSAGE_CANNOT_USE_SAME_INSTANCE_NUMBER"),i="no-unit-highlight",a=$("#popup-sac-bacnet-device-confirm"),o=$("#popup-sac-bacnet-device-message"),l=$("#device-setting-bacnet-tab"),T=null,C=null,e=$(".sac-bacnet-contents.server"),x="/bacnet/server/",t=e.find(".sac-bacnet-category.objectid"),I=e.find(".sac-bacnet-category.apdu"),n=e.find(".sac-bacnet-category.pointlist"),y=I.find(".sub-detail"),O=t.find("input[data-role=bacnetserverobjectid]"),S=y.find("#bacnet-apdu-timeout"),A=y.find("#bacnet-apdu-retries"),P=y.find("#bacnet-apdu-maxlength"),D=y.find("#bacnet-apdu-segmenttimeout"),w=y.find("input[data-role=bacnetapdusegmentsupported]"),B=y.find(".k-button[data-event=bacnetserverstart]"),M=y.find(".k-button[data-event=bacnetserverstop]"),V=n.find(".k-button[data-event=managepoints]"),R=n.find(".k-button[data-event=pointlistdelete]"),L=y.find("span[data-role=bacnetserverstatus]"),G=n.find(".sac-bacnet-grid-pointlist"),U=null,F=$("#popup-sac-bacnet-server"),j=F.find(".popup-detail-pointlist-grid"),W=null,H=null,q=null,Y=!1,K={priorities:{optionsLabel:"Priority",data:function(){for(var e=[],t=0;t<16;t++){var n={value:null,text:null};n.value=t+1,n.text="Out "+(t+1),e.push(n)}return e}},dms_devices_mappedType:{optionsLabel:"Type",data:function(){return[{value:"ControlPoint",text:_.prop("SETTINGS_MENUCONFIGURE_POINT")},{value:"Light",text:_.prop("SETTINGS_MENUCONFIGURE_LIGHT")},{value:"Sensor.Temperature",text:_.prop("SETTINGS_TEMPERATURE_SENSOR")},{value:"Meter",text:_.prop("SETTINGS_ENERGY_METER")},{value:"Sensor.Humidity",text:_.prop("SETTINGS_HUMIDITY_SENSOR")}]}},dms_devices_type:{optionsLabel:"I/O type",data:function(){return[{value:"ControlPoint.AI",text:"AI"},{value:"ControlPoint.AO",text:"AO"},{value:"ControlPoint.AV",text:"AO"},{value:"ControlPoint.BI",text:"DI"},{value:"ControlPoint.BO",text:"DO"},{value:"ControlPoint.BV",text:"DO"},{value:"ControlPoint.MI",text:"AI"},{value:"ControlPoint.MO",text:"AO"},{value:"ControlPoint.MV",text:"AO"}]}},managePoint_unit:{data:function(){return[{value:null,text:_.prop("COMMON_NO_SELECT")},{value:"Celsius",text:"\xb0C"},{value:"Fahrenheit",text:"\xb0F"},{value:"KilowattHour",text:"kWh"},{value:"Percent",text:"%"}]},textValue:{Celsius:"\xb0C",Fahrenheit:"\xb0F",KilowattHour:"kWh",Percent:"%"}}},z={bacNetServerPopupGridDeviceType:{"ControlPoint.AI":{value:"AI",text:"AI"},"ControlPoint.AO":{value:"AO",text:"AO"},"ControlPoint.AV":{value:"AO",text:"AO"},"ControlPoint.DI":{value:"BI",text:"DI"},"ControlPoint.DO":{value:"BO",text:"DO"},"ControlPoint.DV":{value:"BO",text:"DO"},"ControlPoint.BI":{value:"BI",text:"DI"},"ControlPoint.BO":{value:"BO",text:"DO"},"ControlPoint.BV":{value:"BO",text:"DO"},"ControlPoint.MI":{value:"AI",text:"AI"},"ControlPoint.MO":{value:"AO",text:"AO"},"ControlPoint.MV":{value:"AO",text:"AO"}},bacNetMappedType:{ControlPoint:_.prop("SETTINGS_MENUCONFIGURE_POINT"),Light:_.prop("SETTINGS_MENUCONFIGURE_LIGHT"),"Sensor.Temperature":_.prop("SETTINGS_TEMPERATURE_SENSOR"),"Sensor.Humidity":_.prop("SETTINGS_HUMIDITY_SENSOR"),"Sensor.Motion":_.prop("SETTINGS_MENUCONFIGURE_MOTION"),"Meter.WattHour":_.prop("SETTINGS_ENERGY_METER")}},J={AI:0,AO:1,AV:2,BI:3,BO:4,BV:5,DI:3,DO:4,DV:5,CA:6,CM:7,DE:8,MI:13,MO:14,MV:19},Q=N.template('<span title="" style="width: 113px;" class="k-widget k-dropdown k-header common-grid-dropdown sac-indoor-dropdownlist"unselectable="on" role="listbox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-owns="" aria-disabled="false" aria-busy="false"aria-activedescendant="80142285-e564-4717-88fa-3dd3d64ad025" data-field="#=field#"><span unselectable="on" class="k-dropdown-wrap #if(disabled){#k-state-disabled#}else{#k-state-default#}#"><span unselectable="on" class="k-input">#=text#</span><span unselectable="on" class="k-select" aria-label="select"><span class="k-icon k-i-arrow-60-down"></span></span></span><input class="sac-indoor-dropdownlist current-limit" data-value="#=value#" style="display: none;"></span>'),X=function(){T=(T=l.data("kendoCommonTabStrip"))||l.kendoCommonTabStrip().data("kendoCommonTabStrip"),C=T.tabGroup.find("li[data-role=servertab]"),a.data("kendoCommonDialog")||a.kendoCommonDialog({type:"confirm",title:"Notification"}).data("kendoCommonDialog"),k=(k=o.data("kendoCommonDialog"))||o.kendoCommonDialog().data("kendoCommonDialog");var n,e,t=[{value:"NoSegmentation",text:_.prop("BACNET_NO_SEGMENTATION")},{value:"SegmentedReceive",text:_.prop("BACNET_SEGMENTATION")},{value:"SegmentedTransmit",text:_.prop("BACNET_SEGMENTED_SEND")},{value:"SegmentedBoth",text:_.prop("BACNET_SEGMENTED")}];B.kendoButton(),M.kendoButton(),V.kendoButton(),R.kendoButton().data("kendoButton").enable(!1),d=S.kendoCustomNumericBox({unit:"ms",placeholder:"",format:"#",enable:!0,blockKeyEvent:!1,min:100,max:6e4,showValueWhenDisabled:!0}).data("kendoCustomNumericBox"),r=A.kendoCustomNumericBox({unit:"",placeholder:"",format:"#",enable:!0,blockKeyEvent:!1,min:0,max:10,showValueWhenDisabled:!0}).data("kendoCustomNumericBox"),c=P.kendoCustomNumericBox({unit:"bytes",placeholder:"",format:"#",enable:!0,blockKeyEvent:!1,min:100,max:1476,showValueWhenDisabled:!0}).data("kendoCustomNumericBox"),u=D.kendoCustomNumericBox({unit:"ms",placeholder:"",format:"#",enable:!0,blockKeyEvent:!1,min:100,max:6e4,showValueWhenDisabled:!0}).data("kendoCustomNumericBox"),p=w.kendoDropDownList({dataSource:t,dataValueField:"value",dataTextField:"text"}).data("kendoDropDownList"),O.kendoCommonValidator({type:"onlyNumber",rules:{maxNumber:function(e){return!(4194303<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<0)}},messages:{maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}),S.kendoCommonValidator({type:"onlyNumber",minLength:1,maxLength:5,rules:{required:function(e){return!(""==e.val())},maxNumber:function(e){return!(6e4<Number(e.val()))},minNumber:function(e){return""==e.val()||!(Number(e.val())<100)}},messages:{required:_.prop("COMMON_REQUIRED_INFORMATION"),maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}),A.kendoCommonValidator({type:"onlyNumber",minLength:1,maxLength:2,rules:{required:function(e){return!(""==e.val())},maxNumber:function(e){return!(10<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<0)}},messages:{required:_.prop("COMMON_REQUIRED_INFORMATION"),maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}),P.kendoCommonValidator({type:"onlyNumber",minLength:1,maxLength:5,rules:{required:function(e){return!(""==e.val())},maxNumber:function(e){return!(1476<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<100)}},messages:{required:_.prop("COMMON_REQUIRED_INFORMATION"),maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}),D.kendoCommonValidator({type:"onlyNumber",minLength:1,maxLength:5,rules:{required:function(e){return!(""==e.val())},maxNumber:function(e){return!(6e4<Number(e.val()))},minNumber:function(e){return!(Number(e.val())<100)}},messages:{required:_.prop("COMMON_REQUIRED_INFORMATION"),maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}),m=G.kendoGrid({dataSource:[],columns:(n=[],e=[{field:"type",title:_.prop("SETTINGS_DEVICE_TYPE"),sortable:!1},{field:"name",title:_.prop("BACNET_DEVICE_NAME"),sortable:!1},{field:"calcInstanceNumber",title:_.prop("BACNET_DEVICE_ID"),sortable:!1},{field:"writable",title:_.prop("BACNET_READ_WRITE"),sortable:!1},{field:"dms_devices_controlPoint_value",title:_.prop("BACNET_PRESENT_VALUE"),sortable:!1},{field:"priorities",title:_.prop("BACNET_PRIORITY_ARRAY"),sortable:!1}],$.each(e,function(e,t){"checkbox"==t.field?n.push({headerTemplate:"<input type='checkbox' class='k-checkbox' data-event='devicecheckall' id='bacnet-point-list-check-all'><label class='k-checkbox-label' for='bacnet-point-list-check-all'></label>",template:function(e){return"<input type='checkbox' data-event='devicecheck' class='k-checkbox' id='bacnet-point-list-check-"+e.dms_devices_id+"'/><label class='k-checkbox-label' for='bacnet-point-list-check-"+e.dms_devices_id+"'></label>"},width:100,sortable:t.sortable}):n.push({field:t.field,title:t.title,template:function(e){return function(e,t){var n;if(e[t.field]=f.getValueFilteredForXSS(e[t.field]),void 0!==(n=e[t.field])&&null!==n)if("priorities"==t.field)if(0<e[t.field].length){n="";for(var a=!1,o=0;o<e[t.field].length;o++)1==e[t.field][o]&&(a?n+=","+String(o+1):(n+=String(o+1),a=!0));a||(n="-")}else n="-";else if("type"==t.field)n=z.bacNetServerPopupGridDeviceType[n].text;else if("calcInstanceNumber"==t.field){var i,l=parseInt(se(n).value22Bit,2),d=parseInt(se(n).value10Bit,2);for(var r in J)if(J[r]==d){i=r;break}n=i+""+l}else"dms_devices_controlPoint_value"==t.field?n=n.toFixed(1):"writable"==t.field?n=1==n||"true"==n?_.prop("BACNET_WRITABLE_WRITE"):_.prop("BACNET_WRITABLE_READ"):"dms_devices_controlPoint_value"==t.field&&0==e[t.field]&&(n=e[t.field].toFixed(1));else n="-";return"<span class='sac-bacnet-point-grid-"+t.field+"'>"+n+"</span>"}(e,t)},sortable:t.sortable})}),n),scrollable:{virtual:!0},height:"100%",hasCheckedModel:!0,setCheckedAttribute:!0}).data("kendoGrid")},Z=function(){b.open(),$.ajax({url:x}).done(function(e){b.close();var t=!1,n="";e.hasOwnProperty("enabled")?t=e.enabled:e.hasOwnProperty("isActive")&&(t=e.isActive),n=t?h:g,L.text(n),de(t),O.val(e.deviceId?e.deviceId:null),O.data("kendoCommonValidator").validate(),d.value(e.timeout?e.timeout:null),c.value(e.maxLength?e.maxLength:null),u.value(e.segmentTimeout?e.segmentTimeout:null),p.value(e.segmentationSupported?e.segmentationSupported:null),null===e.retries||void 0===e.retries?r.value(null):r.value(e.retries);var a=[];e.objects||(e.objects=[]);for(var o=0;o<e.objects.length;o++){var i=e.objects[o],l=new s;l.checked=!0,l.show=!0,l.dms_devices_id=i.dms_devices_id?i.dms_devices_id:null,l.type=i.type?"ControlPoint."+i.type:null,l.name=i.name?i.name:null,l.dms_devices_controlPoint_tagName=i.dms_devices_controlPoint_tagName?i.dms_devices_controlPoint_tagName:null,l.dms_devices_mappedType=i.dms_devices_mappedType?i.dms_devices_mappedType:null,i.dms_devices_controlPoint_value?l.dms_devices_controlPoint_value=i.dms_devices_controlPoint_value:0==i.dms_devices_controlPoint_value&&(l.dms_devices_controlPoint_value=i.dms_devices_controlPoint_value),l.hasInstanceNumber=!0,l.calcInstanceNumber=i.id?i.id:null,l.instanceNumber=parseInt(se(i.id).value22Bit,2),l.unit=i.unit?i.unit:null,"boolean"==typeof i.writable?l.writable=i.writable:l.writable=!!i.writable&&i.writable,l.priorities=i.priorities?i.priorities:null,a.push(l)}(U=new N.data.DataSource({data:a,pageSize:30})).read(),b.open(),$.ajax({url:"/dms/devices?types=ControlPoint.A*,ControlPoint.D*&attributes=id,type,name,mappedType,controlPoint-origin,controlPoint-tagName,controlPoint-value"}).done(function(e){b.close();for(var t=e,n=[],a=0;a<U.data().length;a++)for(var o=U.data()[a],i=0;i<t.length;i++){var l=t[i];o.dms_devices_id==l.id&&(o.name=l.name,n.push(o))}(U=new N.data.DataSource({data:n,pageSize:30})).read(),m.setDataSource(U),m.uncheckAll()}).fail(function(e){b.close(),k.message(e.status),k.open(),de(!1)}).always(function(){le()})}).fail(function(e){b.close(),(U=new N.data.DataSource({data:[]})).read(),m.setDataSource(U),m.uncheckAll(),k.message(e.responseText),k.open(),L.text(g),de(!1)}).always(function(){d.value()&&null!==r.value()&&void 0!==r.value()&&c.value()&&u.value()||B.data("kendoButton").enable(!1),le()})},ee=function(){C.on("click",Z),B.on("click",function(){for(var e,t={deviceId:Number(O.val()),maxLength:Number(c.element.val()),timeout:Number(d.element.val()),retries:Number(r.element.val()),segmentTimeout:Number(u.element.val()),segmentationSupported:p.value(),objects:[]},n=0;n<U.data().length;n++){var a,o=U.data()[n],i={id:o.calcInstanceNumber,type:z.bacNetServerPopupGridDeviceType[o.type].value,writable:o.writable,unit:o.unit,priorities:o.priorities,dms_devices_id:o.dms_devices_id,dms_devices_mappedType:o.dms_devices_mappedType,dms_devices_controlPoint_tagName:o.dms_devices_controlPoint_tagName,dms_devices_controlPoint_value:Number(o.dms_devices_controlPoint_value)};for(e in"AI"!=(a=z.bacNetServerPopupGridDeviceType[o.type].value)&&"BI"!=a&&"MI"!=a||(delete i.writable,delete i.priorities),i)i[e]||0!=i[e]&&delete i[e];t.objects.push(i)}for(e in t)""!==t[e]&&null!==t[e]&&void 0!==t[e]||delete t[e];b.open(),$.ajax({url:x+"start",method:"PUT",data:t}).done(function(){k.message(h),L.text(h),de(!0)}).fail(function(e){var t=f.parseFailResponse(e);k.message(t),L.text(g),B.data("kendoButton").enable(!1),M.data("kendoButton").enable(!0),O.prop("disabled",!0)}).always(function(){k.open(),b.close()})}),M.on("click",function(){b.open(),$.ajax({url:x+"stop",method:"PUT"}).done(function(){k.message(g),L.text(g),de(!1)}).fail(function(e){var t=f.parseFailResponse(e);k.message(t),L.text(g),B.data("kendoButton").enable(!0),M.data("kendoButton").enable(!1),O.prop("disabled",!1)}).always(function(){k.open(),b.close()})}),I.on("click",".k-numerictextbox .control-custom-box .k-link",function(){var e=$(this),t=e.closest(".k-numeric-wrap"),n=t.find("input.bacnet-apdu-numeric-box.k-formatted-value"),a=$(this).closest(".detail").find("input.common-validator"),o=!0,i=O.val();e.hasClass("k-state-disabled")||t.hasClass("k-state-disabled")||(n.blur(),a.each(function(e,t){""!=$(t).val()?$(t).data("kendoCommonValidator").validate()||(o=!1):o=!1}),o&&""!=i&&O.data("kendoCommonValidator").validate()?B.data("kendoButton").enable(!0):B.data("kendoButton").enable(!1))}),O.on("keyup",function(e){var t=O.data("kendoCommonValidator").validate(),n=$(this).val(),a=I.find("input.bacnet-apdu-numeric-box.common-validator"),o=!0;a.each(function(e,t){null!==$(t).data("kendoCustomNumericBox").value()&&$(t).data("kendoCommonValidator").validate()||(o=!1)}),o&&t&&""!=n?B.data("kendoButton").enable(!0):B.data("kendoButton").enable(!1),t&&""!=n?V.data("kendoButton").enable(!0):V.data("kendoButton").enable(!1)}),O.on("focusout",function(e){var t,n=$(this),a=n.val(),o=I.find("input.bacnet-apdu-numeric-box.common-validator"),i=!0;a<0?n.val(0):4194303<a&&n.val(4194303),t=n.data("kendoCommonValidator").validate(),o.each(function(e,t){null!==$(t).data("kendoCustomNumericBox").value()&&$(t).data("kendoCommonValidator").validate()||(i=!1)}),i&&t&&""!=a?B.data("kendoButton").enable(!0):B.data("kendoButton").enable(!1),t&&""!=a?V.data("kendoButton").enable(!0):V.data("kendoButton").enable(!1)}),I.on("keyup","input.bacnet-apdu-numeric-box",function(e){var t=$(this),n=!0,a=$(this).closest(".detail").find("input.common-validator"),o=O.val(),i=$(this).val(),l=$(this).data("kendoCustomNumericBox"),d=l.min(),r=l.max(),c=l.wrapper.find(".k-link.k-link-increase"),s=l.wrapper.find(".k-link.k-link-decrease"),u=e.shiftKey,p=t[0].selectionStart,m=t[0].selectionEnd;a.each(function(e,t){""!=$(t).val()?$(t).data("kendoCommonValidator").validate()||(n=!1):n=!1}),n&&""!=o&&O.data("kendoCommonValidator").validate()?B.data("kendoButton").enable(!0):B.data("kendoButton").enable(!1),!u&&0!==Number(i[0])&&i<r&&d<i&&(c.removeClass("k-state-disabled"),s.removeClass("k-state-disabled"),$(this).focusout()),Number(i)<=d&&(c.removeClass("k-state-disabled"),s.addClass("k-state-disabled")),Number(i)>=r&&(c.addClass("k-state-disabled"),s.removeClass("k-state-disabled")),l.focus(),function(e,t,n){var a=e[0];void 0===n&&(n=t);e.each(function(){if("selectionStart"in a)a.selectionStart=t,a.selectionEnd=n;else if(a.setSelectionRange)a.setSelectionRange(t,n);else if(a.createTextRange){a.createTextRange();a.collapse(!0),a.moveEnd("character",n),a.moveStart("character",t),a.select()}})}(t,p,m)}),I.on("focusout","input.bacnet-apdu-numeric-box[data-role=customnumericbox]",function(e){var t=$(this),n=t.data("kendoCustomNumericBox"),a=n.min(),o=n.max(),i=t.val(),l=O.data("kendoCommonValidator").validate(),d=!0,r=""==i||null===i;I.find("input.bacnet-apdu-numeric-box.common-validator").each(function(e,t){null!==$(t).data("kendoCustomNumericBox").value()&&$(t).data("kendoCommonValidator").validate()||(d=!1)}),!r&&l&&d?B.data("kendoButton").enable(!0):B.data("kendoButton").enable(!1),n.enable(!1),n.enable(!0),n.min(a),n.max(o),""==i&&(i=a),n.value(i)}),V.on("click",function(){var e;(e=F).data("kendoPopupSingleWindow").openWindowPopup(),e.find("button[data-event=save]").data("kendoButton").enable(!1),Y=!1,b.open(e),$.ajax({url:"/dms/devices?types=ControlPoint.A*,ControlPoint.D*&attributes=id,type,name,mappedType,controlPoint-origin,controlPoint-tagName,controlPoint-value"}).done(function(e){var t;for(t=e.length-1;0<=t;t--){var n=e[t];n.controlPoint&&"BACnet"==n.controlPoint.origin&&e.splice(t,1)}(q=new N.data.DataSource({data:e})).read();var a,o,i=q.data(),l=U.data(),d=[];for(t=0;t<i.length;t++){var r=new s;"ControlPoint.AI"!=(a=i[t]).type&&"ControlPoint.DI"!=a.type||(r.priorities=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),r.dms_devices_id=a.id?a.id:null,r.type=a.type?a.type:null,r.dms_devices_mappedType=a.mappedType?a.mappedType:null,r.name=a.name?a.name:null,r.hasNoRequiredUnit=!1,a.controlPoint?(r.dms_devices_controlPoint_tagName=a.controlPoint.tagName?a.controlPoint.tagName:null,null===r.dms_devices_controlPoint_tagName&&(r.dms_devices_controlPoint_tagName=a.name),a.controlPoint.value?r.dms_devices_controlPoint_value=a.controlPoint.value:0==a.controlPoint.value&&(r.dms_devices_controlPoint_value=0)):(r.dms_devices_controlPoint_tagName=null,r.dms_devices_controlPoint_val=null),r.instanceNumber=t+1,r.displaydeviceTypeText=z.bacNetServerPopupGridDeviceType[r.type].text,r.calcInstanceNumber=ce(Number(r.instanceNumber),Number(J[r.displaydeviceTypeText])).result;for(var c=0;c<l.length;c++)o=l[c],a.id==o.dms_devices_id&&(r.hasInstanceNumber=o.hasInstanceNumber,r.instanceNumber=o.instanceNumber?o.instanceNumber:null,r.calcInstanceNumber=o.calcInstanceNumber,r.priorities=o.priorities?o.priorities:null,"boolean"==typeof o.writable?r.writable=o.writable:r.writable=o.writable?o.writable:null,r.unit=o.unit?o.unit:null,r.show=!0,r.checked=!0);d.push(r)}(W=new N.data.DataSource({data:d,pageSize:40})).read()}).fail(function(e){(W=new N.data.DataSource({data:[],pageSize:40})).read(),k.message(e.responseText),k.open()}).always(function(){b.close(e),W.read(),v.setDataSource(W),v.wrapper.find(".k-scrollbar").scrollTop(0)})}),R.on("click",function(){var e=m.dataSource,t=$.extend(!0,[],e._pristineData),n=0;for(n=t.length-1;0<=n;n--)t[n].checked&&t.splice(n,1);(U=new N.data.DataSource({data:t,pageSize:30})).read(),m.setDataSource(U),le()})},te=function(){var n,e;F.kendoPopupSingleWindow({title:_.prop("BACNET_MANAGE_POINTS"),width:1650,height:800}),v=j.kendoGrid({dataSource:[],columnDropDownList:!0,columns:(n=[],e=[{field:"type",title:_.prop("SETTINGS_DEVICE_TYPE"),sortable:!1,type:"string",width:""},{field:"name",title:_.prop("BACNET_DEVICE_NAME"),sortable:!1,type:"string",width:""},{field:"dms_devices_mappedType",title:_.prop("BACNET_PROPERTY"),sortable:!1,type:"string",width:""},{field:"dms_devices_controlPoint_value",title:_.prop("BACNET_VALUE"),sortable:!1,type:"string",width:"5%"},{field:"instanceNumber",title:_.prop("BACNET_INSTANCE_NUMBER"),sortable:!1,type:"input",width:""},{field:"unit",title:_.prop("BACNET_UNIT"),sortable:!1,type:"dropdownlist",width:"8%",dropDownOptions:{dataValueField:"value",dataTextField:"text",dataSource:K.managePoint_unit.data(),change:function(e){e.item.unit=e.value,ue(e.item),re()},dropDownListCss:"common-grid-dropdownlist-control-point-management"}},{field:"writable",title:_.prop("BACNET_WRITABLE"),sortable:!1,type:"singlecheckbox",width:"5%"},{field:"priorities",title:_.prop("BACNET_PRIORITY_ARRAY"),sortable:!1,type:"multiplecheckbox",width:"30%"}],$.each(e,function(e,t){n.push({field:t.field,title:t.title,template:function(e){return function(e,t){var n,a,o,i,l,d=[];if("string"==t.type&&(e[t.field]=f.getValueFilteredForXSS(e[t.field])),n=t.field,a=t.type,o=""==(l=e[t.field])||null==l||"None"==l?0==l||0==l?l:"-":l,"singlecheckbox"==a){var r=!1;i=(r=0!=o&&0!=o)?"<input type='checkbox' class='k-checkbox' data-value='"+r+"' data-type='"+a+"' data-field='"+n+"' data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+n+"-"+e.dms_devices_id+"' checked/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+n+"-"+e.dms_devices_id+"'></label>":"<input type='checkbox' class='k-checkbox' data-value='"+r+"' data-type='"+a+"' data-field='"+n+"' data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+n+"-"+e.dms_devices_id+"'/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+n+"-"+e.dms_devices_id+"'></label>","writable"==n&&("ControlPoint.AI"!=e.type&&"ControlPoint.DI"!=e.type||(i="<span data-value='"+r+"' data-type='"+a+"' data-field='"+n+"' data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+n+"-"+e.dms_devices_id+"'>-</span>"))}else if("dropdownlist"==a){if("unit"==n)if("ControlPoint.DO"==e.type||"ControlPoint.DI"==e.type)i="<span class='sac-bacnet-pointlist-grid-cell' data-field='"+n+"' data-type='string' data-value='"+o+"'>"+o+"</span>";else{var c=$("<div/>"),s=null;s="-"!=o&&o?K.managePoint_unit.textValue[o]:(o=K.managePoint_unit.data()[0].value,K.managePoint_unit.data()[0].text),$(Q({value:o,text:s,disabled:!1,field:"unit"})).appendTo(c),i=c.html()}}else if("multiplecheckbox"==a){if("priorities"==n){"-"==(d=o)&&(d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(var u="",p=0;p<d.length;p++){var m=d[p],v="",b=!1;1==m&&(b=!0),v=b?"ControlPoint.DI"==e.type||"ControlPoint.AI"==e.type?"<li><input type='checkbox' class='k-checkbox' data-value='"+b+"' data-index='"+p+"'data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"' checked disabled/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"'>"+(p+1)+"</label></li>":"<li><input type='checkbox' class='k-checkbox' data-value='"+b+"' data-index='"+p+"'data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"' checked/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"'>"+(p+1)+"</label></li>":"ControlPoint.DI"==e.type||"ControlPoint.AI"==e.type?"<li><input type='checkbox' class='k-checkbox' data-value='"+b+"' data-index='"+p+"'data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"' disabled/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"'>"+(p+1)+"</label></li>":"<li><input type='checkbox' class='k-checkbox' data-value='"+b+"' data-index='"+p+"'data-event='"+n+"check' id='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"'/><label class='k-checkbox-label' for='bacnet-popup-pointlist-check-"+e.dms_devices_id+"-"+p+"'>"+(p+1)+"</label></li>",u+=v}i="<ul class='sac-bacnet-pointlist-grid-cell' data-field='"+n+"'>"+u+"</ul>"}}else"string"==a?("type"==n?o=z.bacNetServerPopupGridDeviceType[o].text:"dms_devices_mappedType"==n?o=z.bacNetMappedType[o]:"dms_devices_controlPoint_value"==n&&"-"!=o&&(o=o.toFixed(1)),i="<span class='sac-bacnet-pointlist-grid-cell' data-field='"+n+"' data-type='string' data-value='"+o+"'>"+o+"</span>"):"input"==a&&(i="instanceNumber"==t.field?(o=o,e.hasInstanceNumber?"<input type='text' class='k-input sac-bacnet-pointlist-grid-cell' value='"+o+"'data-field='"+n+"' data-type='input' data-value='"+o+"' required hasinstancenumber>":"<input type='text' class='k-input sac-bacnet-pointlist-grid-cell' value='"+o+"'data-field='"+n+"' data-type='input' data-value='"+o+"' required>"):"<input type='text' class='k-input sac-bacnet-pointlist-grid-cell' data-field='"+n+"' data-type='input' data-value='"+o+"'>");return i}(e,t)},width:t.width,sortable:t.sortable,dropDownOptions:t.dropDownOptions?t.dropDownOptions:null})}),n),height:650,scrollable:{virtual:!0},hasCheckedModel:!0,setCheckedAttribute:!0}).data("kendoGrid");var t='<span style="position: absolute; top: 10px; left: 35px;">'+_.prop("BACNET_SHOW")+"</span>";j.find("[role=columnheader][data-field=checked]").append(t),H=ne(v)},ne=function(e){var t=e.wrapper.find(".k-grid-content").data("kendoVirtualScrollable");return t=t||null},ae=function(){m.bind("checked",function(){console.info("DATABOUND::"),le()})},oe=function(){F.on("click","button[data-event=save]",function(){var e,t,n=[],a=v.dataSource,o=null,i=a.data().length,l=function(e){var t=e.data(),n=0,a=t.length;for(n=0;n<a;n++)if(t[n].hasNoRequiredUnit)return n;return!1}(a);if(!1!==l&&H)return--l<0&&(l=0),void H.verticalScrollbar.scrollTop(84*l);for(t=0;t<i;t++)(o=a.data()[t]).checked&&(o.hasInstanceNumber=!0,null===o.calcInstanceNumber&&(e=z.bacNetServerPopupGridDeviceType[o.type].text,o.calcInstanceNumber=ce(Number(o.instanceNumber),Number(J[e])).result),n.push(o));$(this).data("kendoButton").enable(!1),Y=!0,(U=new N.data.DataSource({data:n,pageSize:30})).read(),m.setDataSource(U),m.uncheckAll(),le()}),F.closest(".popup-window").on("click","span.pop-window-btn-close",function(){Y||W.cancelChanges()}),F.on("click","button[data-event=close]",function(e){Y||W.cancelChanges()})},ie=function(){j.on("click","[data-field=priorities] .k-checkbox",function(){var e=$(this),t=e.closest("tr").attr("data-uid"),n=W.getByUid(t),a=e.closest("ul"),o=n.get("priorities"),i=a.find("li").index(e.closest("li"));e.prop("checked")?o[i]=1:o[i]=0,re(),n.priorities=o}),v.bind("checked",function(e){var t=e.item,n=null;t&&(n=t.checked,t.show=n,ue(t)),re()}),j.on("click","input[data-field=writable]",function(){var e=$(this),t=e.closest("tr").attr("data-uid"),n=W.getByUid(t);re(),e.prop("checked")?n.writable=!0:n.writable=!1}),j.on("keyup","input[data-field=instanceNumber]",function(){var e,t,n=$(this),a=n.closest("tr"),o=a.attr("data-uid"),i=W.getByUid(o),l=a.find(".sac-bacnet-pointlist-grid-cell[data-field=type]").attr("data-value"),d=J[l],r=n.val(),c=ce(Number(r),Number(d)).result,s=null,u=!0,p=!0,m=!0,v=0,b=null,f=W.data(),_=f.length;for(k.message(E),i.instanceNumber=r,v=0;v<_;v++)b=f[v],t=Number(c),e=b.calcInstanceNumber,s=b.insNumValidator,b.uid!=o&&e==t&&(k.open(),p=!1),s&&!s.validate()&&(m=!1);u=!(!p||!m)&&(i.calcInstanceNumber=t,!0),F.find("button[data-event=save]").data("kendoButton").enable(u)}),v.bind("dataBound",function(){var e,t,n=0,a=v.dataSource,o=null,i=j.find(".sac-bacnet-pointlist-grid-cell[data-field=instanceNumber]");for(n=0;n<i.length;n++)t=(e=i.eq(n)).closest("tr"),(o=a.getByUid(t.attr("data-uid"))).tr=t,o.insNumValidator=e.kendoCommonValidator({type:"onlyNumber",minLength:1,maxLength:7,rules:{maxNumber:function(e){var t=e.val();return!(4194303<Number(t))},minNumber:function(e){var t=e.val(),n=Number(t);return!(n<0||0==n)}},messages:{maxNumber:_.prop("COMMON_INVALID_VALUE"),minNumber:_.prop("COMMON_INVALID_VALUE")}}).data("kendoCommonValidator"),o.insNumValidator.validate(),ue(o)})};function le(){0==m.getCheckedData()?R.data("kendoButton").enable(!1):R.data("kendoButton").enable(!0)}function de(e){e?(V.data("kendoButton").enable(!1),M.data("kendoButton").enable(!0),B.data("kendoButton").enable(!1),d.enable(!1),r.enable(!1),c.enable(!1),u.enable(!1),p.enable(!1),O.prop("disabled",!0)):(V.data("kendoButton").enable(!0),M.data("kendoButton").enable(!1),B.data("kendoButton").enable(!0),d.enable(!0),r.enable(!0),c.enable(!0),u.enable(!0),p.enable(!0),O.prop("disabled",!1))}function re(){var e,t=F.find("button[data-event=save]").data("kendoButton"),n=v.dataSource.data(),a=n.length,o=null,i=!0;for(e=0;e<a;e++)if((o=n[e]).checked){if(z.bacNetServerPopupGridDeviceType[o.type].text,o.insNumValidator&&!o.insNumValidator.validate()){i=!1;break}if(o.hasNoRequiredUnit){i=!1;break}}return t.enable(i),i}function ce(e,t){var n,a,o,i,l="",d=[],r=[];for(a=e.toString(2),o=t.toString(2),i=0;i<22-a.length;i++)d.push(0);for(i=0;i<10-o.length;i++)r.push(0);for(d=d.concat(a),n=(r=r.concat(o)).concat(d),i=0;i<n.length;i++)l+=String(n[i]);return{result:l=parseInt(l,2),value10Bit:se(l).value10Bit,value22Bit:se(l).value22Bit}}function se(e){var t,n,a,o,i=e.toString(2),l=i.split(""),d=[],r="";for(o=0;o<32-i.length;o++)d.push(0);for(a=d.concat(l),o=0;o<a.length;o++)r+=String(a[o]);return t=r.substring(0,10),n=r.substring(10,32),{value:r,value10Bit:t,value22Bit:n}}function ue(e){var t=e.displaydeviceTypeText,n=e.unit,a=e.checked,o=e.tr;e.hasNoRequiredUnit=!1,"AI"!==t&&"AO"!==t||(a?n?o.removeClass(i):(o.addClass(i),e.hasNoRequiredUnit=!0):o.removeClass(i))}return function(){X(),te(),ae(),oe(),ie(),ee(),Z()}}),define("devicesettings/bacnet/bacnet",["devicesettings/bacnet/bacnet-client/bacnet-client","devicesettings/bacnet/bacnet-server/bacnet-server"],function(e,t){var n=$("#device-setting-bacnet-tab"),a=null,o=function(){a.tabGroup.find("li[data-role=servertab]").one("click",function(){t()})};(function(){a=(a=n.data("kendoCommonTabStrip"))||n.kendoCommonTabStrip().data("kendoCommonTabStrip")})(),o(),e()});