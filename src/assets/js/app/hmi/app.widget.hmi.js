!function(m){"use strict";function e(e){var t=window.I18N,a="";return"create"==e?a='<button class="k-button edit-btn">'+t.prop("COMMON_BTN_EDIT")+"</button>":"delete"==e&&(a='<button class="k-button delete-btn">'+t.prop("COMMON_BTN_DELETE")+"</button>"),a}function i(e){var t=!e.isFolder,a="";if(t||e.isFolder&&e.hasChildren){var i=e._isNew&&t?"new":"",n=t&&i?"NEW":"",r=1==e.treeDepth?"root":"";return a=t?"<span class='ic ic-info'></span>":"","<span class='file-badge "+i+" "+r+" '>"+n+"</span>"+"<span class='file-name "+r+"' title='"+e.name+"'>"+e.name+"</span>"+a}return"<div class='new-folder'><span class='k-icon k-i-expand'></span><span class='file-name' title='"+e.name+"'>"+e.name+"</span></div>"}var o=window.kendo,n=o.ui.Widget,p="New Folder",c="New File";function s(e){return"<span class=search-highlight>"+e+"</span>"}var t=n.extend({options:{name:"HmiFileList",dataSource:null,searchable:!0,creatable:!0,editable:!0,deletable:!0,treeListOptions:{isOnlyChildrenSelectable:!1,editable:{mode:"inline",move:!0}},searchGridOptions:{}},events:["change","create","delete","detail","edit"],init:function(e,t){var a=this,i=window.I18N;n.fn.init.call(this,e,t),t=a.options,c=i.prop("HMI_NEW_FILE"),p=i.prop("HMI_NEW_FOLDER"),a._createWrapper(),a._createFileTreeList(),t.creatable&&a._createCreateButton(),t.searchable&&a._createSearch(),t.editable&&a._createEditButton(),t.deletable&&a._createDeleteButton(),t.creatable||t.searchable||a.topWrapper.hide(),t.editable||t.deletable||a.bottomWrapper.hide(),a._calculateListHeight(),a._attachEvt()},_createWrapper:function(){var e=this;e.element.html('<div class="hmi-file-list-wrapper"><div class="hmi-file-list-top"></div><div class="hmi-file-list-tree"></div><div class="hmi-file-list-search-list" style="display:none;"></div><div class="hmi-file-list-bottom"></div></div>'),e.parentWrapper=e.element.find(".hmi-file-list-wrapper"),e.topWrapper=e.element.find(".hmi-file-list-top"),e.treeWrapper=e.element.find(".hmi-file-list-tree"),e.listWrapper=e.element.find(".hmi-file-list-search-list"),e.bottomWrapper=e.element.find(".hmi-file-list-bottom")},_calculateListHeight:function(){var e=this,t=(e.topWrapper.is(":visible")?e.topWrapper.outerHeight():0)+(e.bottomWrapper.is(":visible")?e.bottomWrapper.outerHeight():0)+0+"px";e.treeWrapper.css("height","calc(100% - "+t+" )"),e.listWrapper.css("height","calc(100% - "+t+" )")},_attachEvt:function(){var t=this,e=t.options,a=t._selectionChangeEvt.bind(t);t.treeList.bind("change",a),t.treeList.bind("dragstart",t._dragStartEvt.bind(t)),t.treeList.bind("drag",t._dragEvt.bind(t)),t.treeList.bind("dragend",t._dragEndEvt.bind(t)),t.treeList.bind("expand",t._expandEvt.bind(t)),t.treeList.bind("collapse",t._collapseEvt.bind(t)),t.treeList.element.on("click",".k-grid-content tr[role='row']",t._fileRowClickEvt.bind(t)),e.editable&&t.treeList.bind("save",t._saveEvt.bind(t)),e.searchable&&t.searchList.bind("change",a),t.element.on("click","tr > td .ic.ic-info",t._detailEvt.bind(t)),t.element.on("keydown","tr.k-grid-edit-row .k-input",function(e){13==e.keyCode&&t.saveRow(),27==e.keyCode&&t.cancelRow()})},_detailEvt:function(e){var t=m(e.target).closest("tr").data("id"),a=this.treeList.dataSource.get(t);this.trigger("detail",{item:a})},_dragStartEvt:function(e){var t=e.source;this.trigger("dragstart",{item:t})},_dragEvt:function(e){var t=this,a=e.target,i=e.source,n=a.closest("tr[role='row']");t._draggedRow&&t._draggedRow!=n&&t._draggedRow.removeClass("dragging"),t._draggedRow=n,t._draggedRow.addClass("dragging");var r=n.data("id"),l=t.treeList.dataSource.get(r);l&&(i.isFolder&&!l.isFolder?(e.setStatus("k-i-cancel"),t._draggedRow.removeClass("dragging"),e.preventDefault()):(i.isFolder||!l.isFolder||l.expanded||(l.set("expanded",!0),t._expandEvt({model:l})),t.trigger("drag",{source:i,target:l})))},_dragEndEvt:function(e){var t=this,a=e.source,i=e.destination;t._draggedRow&&(t._draggedRow.removeClass("dragging"),t._draggedRow=null);var n,r,l=[];if(i)a.isFolder&&i.isFolder?(r=t._getLastOrderInFolder(i.id),a.set("sortOrder",r+1),l=t._reOrderFromSource(a)):!a.isFolder&&i.isFolder?(i.id==a.parent_id?(n=t._getFirstOrderInFolder(i.id),a.set("sortOrder",n-1)):(r=t._getLastOrderInFolder(i.id),a.set("parent_id",i.id),a.set("sortOrder",r+1)),a.treeDepth=2,a.set("_isNew",!1),l=t._reOrderFromSource(a)):a.isFolder||i.isFolder||(a.parent_id!=i.parent_id&&(a.set("parent_id",i.parent_id),i.parent_id?a.treeDepth=2:a.treeDepth=1),a.set("sortOrder",i.sortOrder+1),l=t._reOrderFromSource(a));else{var s=e.originalEvent.clientY,d=t.treeList.element.find(".k-grid-content tr[role='row']:first-child"),o=t.treeList.element.find(".k-grid-content tr[role='row']:last-child"),p=d.offset().top,c=o.offset().top;a.set("parent_id",null),a.treeDepth=1,s<p?(a.set("sortOrder",1),l=t._reOrderFromSource(a)):c<s&&(r=t._getLastOrder(),a.set("sortOrder",r+1))}t.trigger("dragend",{source:a,target:i,orderedItems:l}),t.treeList.dataSource.fetch()},_getLastOrderInFolder:function(e){var t=this.treeList,a=t.dataSource.data(),i=new o.data.Query(a).filter({field:"parent_id",eq:"eq",value:e}).sort({field:"sortOrder",dir:"asc"}).toArray(),n=i[i.length-1];return n?n.sortOrder:t.dataSource.get(e).sortOrder},_getFirstOrderInFolder:function(e){var t=this.treeList,a=t.dataSource.data(),i=new o.data.Query(a).filter({field:"parent_id",eq:"eq",value:e}).sort({field:"sortOrder",dir:"asc"}).toArray()[0];return i?i.sortOrder:t.dataSource.get(e).sortOrder},_getLastOrder:function(){var e=this.treeList.dataSource.data(),t=new o.data.Query(e).sort({field:"sortOrder",dir:"asc"}).toArray(),a=t[t.length-1];return a?a.sortOrder:0},_reOrderFromSource:function(e){var t,a=this.treeList.dataSource.data(),i=new o.data.Query(a).sort([{field:"sortOrder",dir:"asc"}]).filter({logic:"and",filters:[{field:"sortOrder",operator:"gte",value:e.sortOrder},{field:"id",operator:"neq",value:e.id}]}).toArray(),n=i.length,r=e.sortOrder;for(t=0;t<n;t++)i[t].set("sortOrder",r+(t+1));return i},reOrderAllItems:function(){var e,t=this.treeList.dataSource.view(),a=t.length;for(e=0;e<a;e++)t[e].sortOrder=e+1;return t},_selectionChangeEvt:function(e){var t=this,a=e.isSelectFunction,i=t.getSelectedData(),n=!!i;if(t._updateButtonStateFromSelectedData(),n&&!i.isFolder&&!a){var r,l=t._getNewFiles(),s=l.length;for(r=0;r<s;r++)l[0].set("_isNew",!1)}!n||i._isNew||i.isFolder||(t._recentSelectedFile=i),t.trigger("change",e)},_fileRowClickEvt:function(e){var t=this,a=t.treeList.dataSource,i=t.options,n=m(e.target).closest("tr[role='row']").data("id"),r=a.get(n);if(r.isFolder){var l=i.treeListOptions;if(l&&l.isOnlyChildrenSelectable)r.expanded?r.set("expanded",!1):r.set("expanded",!0),t._expandEvt({model:r});else if(r.expanded)r.selected&&r.expanded&&(r.set("expanded",!1),t._collapseEvt({model:r}));else{r.set("expanded",!0),t._expandEvt({model:r});var s=t.getSelectedData();r.selected||(r.set("selected",!0),s.set("selected",!1))}}},_updateButtonStateFromSelectedData:function(){var e=this.options,t=!!this.getSelectedData();e.editable&&this.editButton.prop("disabled",!t),e.deletable&&this.deleteButton.prop("disabled",!t)},_createCreateButton:function(){var e,a=this;a.topWrapper.append('<button class="k-button create-btn">'+window.I18N.prop("COMMON_BTN_CREATE")+"</button>"),a.createButton=a.topWrapper.find(".create-btn"),a.createButton.on("click",function(){var e=m(this).hasClass("active");a.visibleCreateTypeSelectBox(!e)}),a.parentWrapper.prepend('<div class="create-type" style="display:none;"><ul><li data-type="folder">'+(e=window.I18N).prop("HMI_NEW_FOLDER")+'</li><li data-type="file">'+e.prop("HMI_NEW_FILE")+"</li></ul></div>"),a.createType=a.parentWrapper.find(".create-type"),a.createType.on("click","ul > li",function(){a._isSearching&&a.clearSearchResult();var e,t=m(this).data("type");e="folder"==t?a.addFolder():a.addFile(null),a.trigger("create",{type:t,item:e}),a.visibleCreateTypeSelectBox(!1)})},visibleCreateTypeSelectBox:function(e){var t=this;if(e){t.createButton.addClass("active"),t._closeCreateTypeSelectBox||(t._closeCreateTypeSelectBox=function(e){m(e.target).hasClass("create-btn")||t.visibleCreateTypeSelectBox(!1)});var a=t.createButton.offset();t.createType.show();a.top=a.top+-2,a.left=a.left-t.createType.width()-15,t.createType.offset(a),m(document).on("click",t._closeCreateTypeSelectBox)}else t.createButton.removeClass("active"),m(document).off("click",t._closeCreateTypeSelectBox),t.createType.hide()},getNewName:function(a){var i=this,e=i.treeList.dataSource.data(),t="file"==a?c:p;if(0==new o.data.Query(e).filter({field:"name",operator:"eq",value:t}).toArray().length)return t;var n,r,l=new o.data.Query(e),s=1,d=(e=(l=(l=(l=l.filter({field:"name",operator:"contains",value:t})).filter({field:"name",operator:function(e,t){return 0!=i.isAutoCreatedName(e,a)},value:t})).sort({field:"name",dir:"asc",compare:function(e,t){return e=e.name,t=t.name,i.isAutoCreatedName(e,a)-i.isAutoCreatedName(t,a)}})).toArray()).length;for(r=0;r<d;r++)n=e[r].name,i.isAutoCreatedName(n,a)==s&&s++;return n=t+" "+s},isAutoCreatedName:function(e,t){if(!e)return!1;var a="file"==t?c:p,i=e.split(a);return 1<i.length&&!isNaN(Number(i[1]))?Number(i[1]):0},_createNewFile:function(e,t){var a,i;e=e||this.getNewName("file"),i=t?(a=this._getLastOrderInFolder(t),2):(a=this._getLastOrder(),t=null,1);var n=a+1;return{_isNew:!0,isFolder:!1,id:o.guid(),name:e,sortOrder:n,treeDepth:i,parent_id:t,parentId:t,createdDate:"-"}},addFile:function(e){var t,a=this,i=a.getSelectedData();i&&(i.isFolder?t=i.id:i.parent_id&&(t=i.parent_id));var n=a._createNewFile(e,t);return a.editDataSourceWithTransport("add",a.treeList.dataSource,n),a.treeList.dataSource.get(n.id)},_createNewFolder:function(e){e=e||this.getNewName("folder");var t=this._getLastOrder();return{isFolder:!0,_isNew:!0,id:o.guid(),name:e,sortOrder:t+1,treeDepth:1,parent_id:null,parentId:null,createdDate:"-"}},addFolder:function(e){var t=this._createNewFolder(e);return this.editDataSourceWithTransport("add",this.treeList.dataSource,t),this.treeList.dataSource.get(t.id)},_createSearch:function(){var t=this;t.topWrapper.append('<span class="search-field-wrapper"><input type="text" class="k-input search-field" placeholder="'+window.I18N.prop("HMI_FILE_NAME")+'"/><button class="ic ic-bt-input-search"></button></span>'),t.searchWrapper=t.topWrapper.find(".search-field-wrapper"),t.searchField=t.topWrapper.find(".search-field"),t.searchButton=t.topWrapper.find(".ic-bt-input-search");var e=t.search.bind(t);t.searchField.on("keyup",e),t.searchButton.on("click",function(e){t._isSearching&&t.searchField.val(""),t.search({keyCode:o.keys.ENTER})}),t._createSearchList()},search:function(e){var t,a=this;t=a.searchField.val(),e.keyCode&&e.keyCode==o.keys.ENTER?a.enableSearchList(t):a.searchWrapper.hasClass("searching")&&(a._isSearching=!1,a.searchWrapper.removeClass("searching"))},clearSearchResult:function(){this.searchField.val(""),this.search({keyCode:o.keys.ENTER})},enableSearchList:function(e){var t=this;if(e){if(t.searchWrapper.addClass("searching"),t._isSearching=!0,t.treeWrapper.hide(),t.searchList.setDataSource(t._getSearchListDataSource()),e){var a={logic:"and",filters:[{field:"isFolder",operator:"eq",value:!1},{field:"name",operator:"contains",value:e}]};t.searchList.dataSource.filter(a)}t.createButton.prop("disabled",!0),t.listWrapper.show()}else t.searchWrapper.removeClass("searching"),t._isSearching=!1,t.listWrapper.hide(),t.searchList.setDataSource(t._getSearchListDataSource([])),t.treeList.dataSource.fetch(),t.createButton.prop("disabled",!1),t.treeWrapper.show();t._updateButtonStateFromSelectedData()},_createSearchList:function(){var e=this,t=e.options.searchGridOptions;t.selectable="row",t.hasSelectedModel=t.hasDoubleClickEvt=!0,t.dataSource||(t.dataSource=e._getSearchListDataSource()),t.columns||(t.columns=[{field:"name",template:i}]),e.searchList=e.listWrapper.kendoGrid(t).data("kendoGrid"),e.listWrapper.find(".k-grid-header").hide(),e.searchList.bind("dataBound",e.highlightSearchResult.bind(e))},highlightSearchResult:function(){var e=this.searchField.val();if(e){var t,a,i,n=this.searchList.items(),r=n.length,l=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");for(i=0;i<r;i++)t=(t=(a=(a=m(n[i])).find(".file-name")).html()).replace(l,s),a.html(t)}},_getSearchListDataSource:function(e){var t=this.treeList.dataSource;e=e||(t?t.data():[]);var a=new o.data.DataSource({data:e});return a.read(),a},_createFileTreeList:function(){var e=this,t=e.options.treeListOptions;t.selectable="row",t.customDragEndEvent=!0,t.hasSelectedModel=t.hasDoubleClickEvt=t.isOnlySelection=!0;var a=window.I18N;t.messages={noRows:a.prop("HMI_NO_GRAPHICS")},t.dataSource||(t.dataSource=new o.data.TreeListDataSource({data:[],schema:{model:{id:"id",expanded:!0}}}),e._applyDefaultSort(t.dataSource)),t.columns||(t.columns=[{field:"name",template:i,editable:function(e){return e.isFolder}}]),e.treeList=e.treeWrapper.kendoTreeList(t).data("kendoTreeList"),e.treeWrapper.find(".k-grid-header").hide()},_tooltip:function(){var e=this.element,t=e.data("kendoTooltip");t?t.refresh():e.kendoTooltip({filter:".hmi-file-list-tree .k-grid-content tbody > tr",wrapperCssClass:"hmi-palette-tooltip",content:function(e){var t=m(e.target);return 0<t.find("> td span.file-name").length?t.find("> td span.file-name").attr("title"):null},position:"left"}).data("kendoToolTip")},setDataSource:function(e){var t=this;if(t.treeList){t._applyDefaultSort(e);var a=t._getNewFiles();t.treeList.setDataSource(e),t._applyNewFiles(a)}},_applyNewFiles:function(e){var t=this.treeList.dataSource;if(t){var a,i,n=e.length;for(i=0;i<n;i++)(a=t.get(e[i].id))&&a.set("_isNew",e[i]._isNew)}},_getNewFiles:function(){var e=this.treeList.dataSource;if(e){var t=e.data();return new o.data.Query(t).filter({logic:"and",filters:[{field:"isFolder",operator:"eq",value:!1},{field:"_isNew",operator:"eq",value:!0}]}).toArray()}},_applyDefaultSort:function(e){e instanceof o.data.DataSource&&e.sort(this._getDefaultSort())},_getDefaultSort:function(){return[{field:"sortOrder",dir:"asc"}]},_createEditButton:function(){var a=this;a.bottomWrapper.append(e("create")),a.editButton=a.bottomWrapper.find(".edit-btn"),a.editButton.prop("disabled",!0),a.editButton.on("click",function(e){var t=a.getSelectedData();if(t.isFolder)return a.editRow(t),!1;a.trigger("edit",{event:e,item:t})})},editRow:function(e){var t=this;if(t._editingRow)return!1;var a=e.id,i=t.treeWrapper.find("tr[data-id='"+a+"']");if(t._saveRowEvt||(t._saveRowEvt=t.saveRow.bind(t)),t.treeList.editRow(i),t.treeList.editor){i=t.treeWrapper.find("tr[data-id='"+a+"']"),t._editingRow=i,t._editingData=e;var n=t._editingRow.find(".k-input");t._editingValidator=n.kendoCommonValidator({type:"hmiGraphicName",required:!0}).data("kendoCommonValidator"),m(document).on("click",t._saveRowEvt)}},saveRow:function(e){var t=this;if(e&&e.target&&0<m(e.target).closest(".k-grid-edit-row").length)return!1;if(t._editingRow&&t._editingValidator.validate()){t._folderEditSucess||(t._folderEditSuccess=t._folderEditSuccessCallback.bind(t)),t._folderEditFail||(t._folderEditFail=t._folderEditFailCallback.bind(t));var a=t._editingValidator.element.val(),i=t._editingData.toJSON();i.name=a,t._editedValue=a,t.trigger("edit",{item:i,success:t._folderEditSuccess,fail:t._folderEditFail}),m(document).off("click",t._saveRowEvt)}},cancelRow:function(){var e=this;e._editingRow&&(e.treeList.cancelRow(),e._editingData.set("selected",!0),e._editingRow=null,e._editingData=null,e._editingValidator=null),m(document).off("click",e._saveRowEvt)},_saveEvt:function(e){},_folderEditSuccessCallback:function(){var e=this;e._editingData.set("name",e._editedValue),e.treeList.saveRow(e._editingRow),e._editedValue=null,e._editingRow=null,e._editingData=null,e._editingValidator=null},_folderEditFailCallback:function(){this.cancelRow()},_createDeleteButton:function(){var a=this;a.bottomWrapper.append(e("delete")),a.deleteButton=a.bottomWrapper.find(".delete-btn"),a.deleteButton.prop("disabled",!0),a.deleteButton.on("click",function(e){var t=a.getSelectedData();a.trigger("delete",{event:e,item:t})})},getSelectedData:function(){return(this._isSearching?this.searchList.getSelectedData(!0):this.treeList.getSelectedData())[0]},selectById:function(e,t){var a=this,i=a.treeList.getSelectedData(),n=a.treeList.dataSource,r=n.get(e);if(void 0===t&&(t=!0),t){var l,s=i.length;for(l=0;l<s;l++)i[l].selected=!1}if(r){if(r.set("selected",t),t&&r.parent_id){var d=n.get(r.parent_id);d&&(d.set("expanded",!0),a._expandEvt({model:d}))}!t||r._isNew||r.isFolder||(a._recentSelectedFile=r),a._updateButtonStateFromSelectedData()}},select:function(e,t,a){var i,n=this.treeList.dataSource;if(e instanceof o.data.ObservableObject?i=e:"string"!=typeof e&&"number"!=typeof e||(i=n.get(e)),i){var r=i.selected;if(i.set("selected",t),t&&i.parent_id){var l=n.get(i.parent_id);l&&(l.set("expanded",!0),this._expandEvt({model:l}))}a||r==t?!t||i._isNew||i.isFolder||(this._recentSelectedFile=i):this._selectionChangeEvt({item:i,isSelectFunction:!0})}},getFiles:function(){var e=this.treeList.dataSource.data();return new o.data.Query(e).filter({field:"isFolder",operator:"eq",value:!1}).toArray()},getFolders:function(){var e=this.treeList.dataSource.data();return new o.data.Query(e).filter({field:"isFolder",operator:"eq",value:!0}).toArray()},destroy:function(){n.fn.destroy.apply(this,arguments)},apiPatchReOredredFiles:function(){var e=window.HmiApi,t=this.reOrderAllItems();return e.patchFiles(t)},apiPostFile:function(i,e){var n=this,r=n.treeList.dataSource,t=window.HmiApi,l=(window.Util,window.I18N,new m.Deferred);return t.postFile(i,e).done(function(e){var t=i.id,a=r.get(t);a&&(n.editDataSourceWithTransport("remove",r,a),a.id=e,n.editDataSourceWithTransport("add",r,a.toJSON()),a=r.get(a.id),n.apiPatchReOredredFiles().done(function(){l.resolve(a)}).fail(function(e){l.reject(e)}))}).fail(function(e){l.reject(e)}),l.promise()},apiPutFile:function(e,t){var a=this.treeList.dataSource,i=window.HmiApi,n=(window.Util,window.I18N,new m.Deferred),r=a.get(e.id);return e.name&&r.set("name",e.name),i.putFile(r,t).done(function(e){n.resolve(r)}).fail(function(e){n.reject(e)}),n.promise()},apiDeleteFile:function(r,l){var s,d=this,o=d.treeList.dataSource,p=new m.Deferred,c=window.HmiApi,u=window.Util,v=window.I18N;return c.deleteFile(r.id).done(function(){var e,t=[],a=o.get(r.id);if(a.isFolder){var i,n;if(s=v.prop("HMI_FOLDER_DELETE_CONFIRM_POPUP"),e=o.childNodes(a),d.editDataSourceWithTransport("remove",o,a),l)for(n=e.length,i=0;i<n;i++)(a=o.get(e[i].id))&&(a.set("parent_id",null),a.set("treeDepth",1));else{for(n=e.length,i=0;i<n;i++)(a=o.get(e[i].id))&&d.editDataSourceWithTransport("remove",o,a);t.push(c.deleteFiles(e))}t.push(d.apiPatchReOredredFiles())}else s=v.prop("HMI_FILE_DELETE_CONFIRM_POPUP"),d._recentSelectedFile&&d._recentSelectedFile.id==a.id&&(d._recentSelectedFile=null),d.editDataSourceWithTransport("remove",o,a),t.push(d.apiPatchReOredredFiles());m.when.apply(this,t).done(function(){p.resolve(s)}).fail(function(e){s=u.parseFailResponse(e),p.reject(s)})}).fail(function(e){s=u.parseFailResponse(e),p.reject(s)}),p.promise()},_expandEvt:function(e){var t,a=e.model,i=this.getExpandedData(),n=i.length;for(t=0;t<n;t++)i[t].id==a.id&&(i[t].expanded=!0);this.trigger("expand",{id:a.id,expandedData:i})},_collapseEvt:function(e){var t,a=e.model,i=this.getExpandedData(),n=i.length;for(t=0;t<n;t++)i[t].id==a.id&&(i[t].expanded=!1);this.trigger("collapse",{id:a.id,expandedData:i})},getExpandedData:function(){var e,t,a=this.treeList.dataSource.data(),i=new o.data.Query(a).filter({logic:"and",filters:[{field:"isFolder",operator:"eq",value:!0}]}).toArray(),n=i.length,r=[];for(e=0;e<n;e++)t={id:i[e].id,expanded:!!i[e].expanded&&i[e].expanded},r.push(t);return r},setExpandedData:function(e){var t,a,i,n,r,l=this.treeList.dataSource,s=e.length;for(r=0;r<s;r++)a=(n=e[r]).id,i=n.expanded,(t=l.get(a))&&null!=i&&t.set("expanded",i)},getRecentSelectedFile:function(){return this._recentSelectedFile},editDataSourceWithTransport:function(e,t,a){var i=t.transport.data;if("add"==e)t.pushCreate(a),i.push(a);else if("remove"==e){t.pushDestroy(a);var n,r=i.length;for(n=0;n<r;n++)if(i[n].id==a.id){i.splice(n,1);break}}}});o.ui.plugin(t)}(jQuery),function(g){"use strict";var e=window.kendo.ui,a=e.CommonTabStrip,f=g("#hmi-monitoring-tab-template"),b=g("#hmi-create-tab-template"),_="monitoring",d="empty-",t=a.extend({options:{name:"HmiTabStrip",type:_,maximum:10},events:["orderChanged","beforeActivate","add","added","delete","deleted"],init:function(e,t){a.fn.init.call(this,e,t),t=this.options,this.setCurrentTabCanvasInfo({id:d+"1",name:window.I18N.prop("HMI_EMPTY_TAB"),zoomLevel:100}),this.initSortable(),this._attachEvt()},initTooltip:function(){var e=this.element;e.data("kendoTooltip")||e.kendoTooltip({filter:"li.k-item",wrapperCssClass:"hmi-tab-tooltip",content:function(e){return e.target.find(".tab-name").attr("title")},position:"bottom"}).data("kendoTooltip")},initSortable:function(){var i=this,e=g(i.scrollbar.scrollArea[0]),t=i._tabAddButton=g("<span/>").addClass("add-btn").addClass("ic").addClass("ic-plus");e.append(t),e.find(".top-tab-menu").css("position","relative");var a=i.options.type,n="ul.k-tabstrip-items";a==_?n="#hmi-tab "+n:"create"==a&&(n="#hmi-create-tab "+n),e.find(".k-tabstrip-items").kendoSortable({filter:"li.k-item",axis:"x",container:n,autoScroll:!0,hint:function(e){var t=1==i.contentElements.length?"no-hint":"hint";return g("<div id='"+t+"' class='common-tab-strip k-tabstrip'><ul class='top-tab-menu k-tabstrip-items k-reset' style='position: relative; left: 0;'><li class='k-item k-state-active k-tab-on-top'>"+e.html()+"</li></ul></div>")},start:function(e){i.activateTab(e.item),1==i.contentElements.length&&e.preventDefault()},change:function(e){var t=i,a=t.tabGroup.children().eq(e.newIndex);e.oldIndex<e.newIndex?t.insertAfter(e.item,a):t.insertBefore(e.item,a),i.trigger("orderChanged")}})},_attachEvt:function(){var e=this,t=g(e.scrollbar.scrollArea[0]).find(".ic-close"),a=e._tabAddButton;t.on("click",e.removeTabEvt.bind(e)),a.bind("click",e.addTab.bind(e))},activateTab:function(e){var t=this.getCurrentTabCanvasInfo();this.trigger("beforeActivate",t),a.fn.activateTab.call(this,e)},removeTabEvt:function(e){var t=this,a=g(e.currentTarget).closest("li"),i=a.index(),n=t.getCurrentTabIndex(),r=a.data("id");if(e.id=r,e.isCurrentTab=i==n,e.index=i,!t.trigger("delete",e)){var l=n==i;l&&(0==i?t.select(1):i==t.contentElements.length-1?t.select(i-1):t.select(i+1)),t.remove(i),t._tabAddButton.show(),t.trigger("deleted",r,l)}e.stopPropagation()},getCurrentTabCanvasInfo:function(){var e=this.getCurrentTabIndex();if(-1==e)return{id:void 0,name:void 0};var t=this.getTabLiByIndex(e);return{id:t.data("id"),name:t.data("name"),zoomLevel:t.data("zoomLevel")}},setCurrentTabCanvasInfo:function(e){var t=this.getCurrentTabIndex();return-1!=t&&(this.changeTabInfo(t,e),!0)},getCurrentTabIndex:function(){var e=this.wrapper.find("[aria-expanded=true]").attr("id");if(!e)return-1;var t=e.split("-"),a=t[t.length-1];return a=a?Number(a)-1:-1},getCurrentOpenedTabInfo:function(){var e={},t=this.getTabLiByIndex(),a=this.getCurrentTabCanvasInfo(),i=a.id;"string"==typeof i&&-1!=i.indexOf(d)?e.activeTab={}:e.activeTab=a;var n,r,l,s=e.openedTab=[];return t.each(function(e,t){t=g(t),n=t.data("id"),r=t.data("name"),l=t.data("zoomLevel")||100,void 0===n||"string"==typeof n&&-1!=n.indexOf(d)||s.push({id:n,name:r,zoomLevel:l})}),e},addTab:function(e,t,a){var i=this,n=i.getTabLiByIndex(),r=i.options,l=r.maximum;if(n.length>=l)return!1;if(i.trigger("add"))return!1;var s=r.type,d=e;"string"!=typeof d&&(s==_?d=e=window.I18N.prop("HMI_EMPTY_TAB"):"create"==s&&(d=e=i.getNewFileName())),t=void 0!==t?t:i.getEmptyId(),a=a||100;var o="<span class='tab-name' title='"+e+"'>"+d+"</span>",p=r.type===_?f:b;i.append({text:o,encoded:!1,content:p.html()});var c=g(i.scrollbar.scrollArea[0]),u=i.contentElements.length-1,v={id:t,name:e,zoomLevel:a};u==l-1&&i._tabAddButton.hide();var m=c.find("li").eq(u),h=g("<i/>").addClass("ic").addClass("ic-close");return h.on("click",i.removeTabEvt.bind(i)),m.find(".k-link").append(h),i.activateTab(m),i.changeTabInfo(u,v),i.trigger("added",v),!0},changeTabInfo:function(e,t){this.changeTabId(e,t.id),this.changeTabName(e,t.name),this.changeTabZoomLevel(e,t.zoomLevel)},changeTabName:function(e,t){var a=this.getTabLiByIndex(e),i=a.find(".tab-name"),n=this.getDisplayName(t);i.attr("title",t),i.html(n),a.data("name",t);var r=this.element;r.data("kendoTooltip")&&r.data("kendoTooltip").refresh()},changeTabId:function(e,t){this.getTabLiByIndex(e).data("id",t)},changeTabZoomLevel:function(e,t){this.getTabLiByIndex(e).data("zoomLevel",t)},getDisplayName:function(e){var t=e;return t},getTabLiByIndex:function(e){var t=this.scrollbar.scrollArea[0],a=g(t).find("li");return"number"==typeof e?a.eq(e):a},getTabLiById:function(a){var e=this.scrollbar.scrollArea[0],t=g(e).find("li"),i=null;return t.each(function(e,t){g(t).data("id")==a&&(i=t)}),i},getNewFileName:function(){var a,e=this.getTabLiByIndex(),i=0,n=0,r=window.I18N.prop("HMI_NEW_FILE")+" ";return e.each(function(e,t){"string"==typeof(a=g(t).data("name"))&&-1!=a.indexOf(r)&&(i=a.split(r)[1],i=Number(i),n<i&&(n=i))}),r+(n+1)},getEmptyId:function(){var a,e=this.getTabLiByIndex(),i=0,n=0,r=d;return e.each(function(e,t){"string"==typeof(a=g(t).data("id"))&&-1!=a.indexOf(r)&&(i=a.split(r)[1],i=Number(i),n<i&&(n=i))}),r+(n+1)},selectById:function(a){var e=this.getTabLiByIndex(),i=-1;e.each(function(e,t){g(t).data("id")==a&&(i=e)}),-1!=i&&this.select(i)},selectByIndex:function(e){var t=this.getTabLiByIndex(e);t&&this.activateTab(t)},length:function(){return this.getTabLiByIndex().length}});e.plugin(t)}(jQuery),function(a,r){"use strict";r.extend;var e=a.kendo,i=a.Util,n=e.ui.PanelBar,t=n.extend({options:{name:"HmiPalette",expandMode:"single",findCanvasWrapper:null,tooltip:!0,template:function(e){var t=e.item;return t.hasChildren?t.text:"<div class='hmi-palette-item' data-value='"+t.value+"' title='"+t.text+"'><span class='hmi-palette-image' style='background-image:url("+i.addBuildDateQuery(t.imageUrl)+");'></span><span class='hmi-palette-text'>"+t.text+"</span></div>"},dataImageUrlField:"addBuildDateQueryUrl",addBuildDateQueryUrl:null},events:["drop","dragstart","drag","dragend","dblclick","click"],init:function(e,t){r(e).addClass("hmi-palette-widget"),n.fn.init.call(this,e,t),this._attachEvent()},_attachEvent:function(){var e=this;e.bind("select",e._selectEvt.bind(e)),e.bind("activate",e._activateEvt.bind(e)),e.bind("expand",e._expandEvt.bind(e)),e.bind("collapse",e._collapseEvt.bind(e)),e.bind("complete",e._animationCompleteEvt.bind(e)),e.bind("dataBound",e._dataBoundEvt.bind(e)),e.element.on("dblclick",".k-group .k-item",e._doubleClickEvt.bind(e)),e.element.on("click",".k-group .k-item",e._clickEvt.bind(e))},_clickEvt:function(e){var t=this.dataSource,a=r(e.target).closest(".k-item").data("uid"),i=t.getByUid(a);e.item=i,this.trigger("click",e)},_doubleClickEvt:function(e){var t=this.dataSource,a=r(e.target).closest(".k-item").data("uid"),i=t.getByUid(a);e.item=i,this.trigger("dblclick",e)},_dataBoundEvt:function(e){this._draggable();var t=this._findCurrentCanvasWrapper();this._droppable(t);var a=this.element.find("> .k-item.k-state-active");a.length&&"false"==a.attr("aria-expanded")&&(a.attr("aria-expanded",!0),this._activateEvt())},_findCurrentCanvasWrapper:function(e){var t=this.options.findCanvasWrapper;return t&&r.isFunction(t)?t.call(this,this.element):this.element.closest(".hmi-create-panel-wrapper").siblings(".k-tabstrip-wrapper").find(".k-content.k-state-active[role='tabpanel']").find(".hmi-create-content-graphic-view-canvas")},updateDroppableCanvas:function(){this._draggable();var e=this._findCurrentCanvasWrapper();this._droppable(e)},_selectEvt:function(e){var t=this;r(e.item).is(".k-state-active")&&a.setTimeout(function(){t.collapse(e.item)},1)},_activateEvt:function(){var e=this.element.find("> li.k-state-active");if(!(e.length<1)){var t=e.height()-e.find(".k-link.k-header").outerHeight(),a=e.find(".k-group");a.height(t),a.css("overflow-y","auto");var i=this.element.data("kendoTooltip");i&&i.hide()}},_expandEvt:function(e){this._expanded=!0},_collapseEvt:function(){this._expanded=!1;var e=this.element.data("kendoTooltip");e&&e.hide()},_animationCompleteEvt:function(){var e=this.element.data("kendoTooltip");!this._expanded&&e&&(e.hide(),setTimeout(function(){e.hide()},10))},_tooltip:function(){var e=this.element;e.data("kendoTooltip")||e.kendoTooltip({filter:".k-group > li.k-item",wrapperCssClass:"hmi-palette-tooltip",content:function(e){return e.target.find(".hmi-palette-item").attr("title")},position:"left"}).data("kendoToolTip")},_draggable:function(){var a=this;a.element.find(".k-group .k-item").each(function(){var e=r(this).data("uid"),t=a.dataSource.getByUid(e);t&&!t.clickable&&a._initDraggable(this)})},_droppable:function(e){var t=this;if(t._bindedDropEvt||(t._bindedDropEvt=t._dropEvt.bind(t)),e.data("uiDroppable"))return e.off("drop",t._bindedDropEvt),void e.on("drop",t._bindedDropEvt);e.droppable({accept:".k-item"}),e.on("drop",t._bindedDropEvt)},_dropEvt:function(e,t){var a=(e.ui=t).helper,i=this.dataSource,n=a.data("uid"),r=i.getByUid(n);r&&(e.item=r,this.trigger("drop",e))},_initDraggable:function(e){var n=this,t=r(e);t.data("uiDraggable")||t.draggable({appendTo:"body",revert:function(e){var t=r(this);return t.hasClass("is-revert")?(t.removeClass("is-revert"),!0):!e},revertDuration:200,helper:"clone",zIndex:100,cursor:"move",start:function(e,t){var a=t.helper;a.addClass("hmi-palette-item-draggable");var i=r("body");n._helper=a,this._bodyHeight=i.outerHeight(),this._bodyWidth=i.outerWidth(),this._helperHeight=a.outerHeight(),this._helperWidth=a.outerWidth()},drag:function(e,t){var a=t.offset,i=a.top+this._helperHeight,n=a.left+this._helperWidth;return!(i>this._bodyHeight)&&(!(n>this._bodyWidth)&&void 0)},stop:function(e){n._helper=null}})}});e.ui.plugin(t)}(window,jQuery),function(p,h){"use strict";var g=p.kendo,c=g.ui,u=(g.keys,h.extend),a=(h.proxy,h.each,h.isArray),o=(g.template,c.Widget,g.data.HierarchicalDataSource),v=".k-link",m=".k-item",f="k-state-active",b="k-state-disabled",s="k-state-selected",d="k-state-highlight",_="aria-expanded",y="aria-selected",x={aria:function(e){var t="";return(e.items||e.content||e.contentUrl||e.expanded)&&(t+=_+"='"+(e.expanded?"true":"false")+"' "),!1===e.enabled&&(t+="aria-disabled='true'"),t},wrapperCssClass:function(e,t){var a="k-item",i=t.index;return!1===t.enabled?a+=" "+b:!0===t.expanded?a+=" "+f:a+=" k-state-default",0===i&&(a+=" k-first"),i==e.length-1&&(a+=" k-last"),t.cssClass&&(a+=" "+t.cssClass),a},textClass:function(e,t){var a="k-link";return t.firstLevel&&(a+=" k-header"),e.selected&&(a+=" "+s),a},textAttributes:function(e){return e?" href='"+e+"'":""},arrowClass:function(e){var t="k-icon";return t+=e.expanded?" k-panelbar-collapse k-i-arrow-n":" k-panelbar-expand k-i-arrow-s"},text:function(e){return!1===e.encoded?e.text:g.htmlEncode(e.text)},groupAttributes:function(e){return!0!==e.expanded?" style='display:none'":""},groupCssClass:function(){return"k-group k-panel"},contentAttributes:function(e){return!0!==e.item.expanded?" style='display:none'":""},content:function(e){return(e.content?e.content:e.contentUrl)?"":"&nbsp;"},contentUrl:function(e){return e.contentUrl?'href="'+e.contentUrl+'"':""}};function I(e){return"<span class=search-highlight>"+e+"</span>"}g.isScrollable=function(e){if(e&&e.className&&"string"==typeof e.className&&-1<e.className.indexOf("k-auto-scrollable"))return!0;var t=g.getComputedStyles(e,["overflow"]).overflow;return"auto"==t||"scroll"==t||t&&(-1!==t.indexOf("auto")||-1!==t.indexOf("scroll"))};function e(e){var t=p.I18N,a="";return"create"==e?a='<button class="k-button edit-btn">'+t.prop("COMMON_BTN_EDIT")+"</button>":"delete"==e&&(a='<button class="k-button delete-btn">'+t.prop("COMMON_BTN_DELETE")+"</button>"),a}function k(e){var t=p.I18N;return e.name?'<div class="text-left image-wrapper" data-id="'+e.id+'"><img class="image" src="'+e.image+'"/><span class="image-file-name">'+e.name+'</span><i class="ic ic-close" data-id="'+e.id+'"></i></div>':'<div class="text-left image-wrapper" data-id="'+e.id+'"><i class="ic ic-btn-add-sm"></i>'+t.prop("HMI_LIBRARY_ADD_IMAGE")+"</div>"}function C(e){return'<span class="list-range-validator min" data-type="numeric" data-required="true"><input data-id="'+e.id+'" type="text" class="k-input min" required style="width:120px;" value="'+e.min+'"/></span><span class="divider">~</span><span class="list-range-validator max" data-type="numeric" data-required="true"><input data-id="'+e.id+'" type="text" class="k-input max" required style="width:120px;" value="'+e.max+'"/></span>'}function T(e){return'<div class="text-center"><span class="ic ic-btn-remove-lg" data-id="'+e.id+'"></span></div>'}var S={height:"100%",scrollable:!1,sortable:!1,filterable:!1,pageable:!1,rowHeaders:!0},n=-2147483648,r=2147483647,l=g.ui.HmiPalette;g.data.binders.hmiLibraryPopupTypeVisible=g.data.Binder.extend({refresh:function(){var e=this.bindings.hmiLibraryPopupTypeVisible.get(),t=h(this.element);t.data("type")==e?t.show():t.hide()}});var t=l.extend({options:{name:"HmiLibraryPalette",creatable:!0,searchable:!0,editable:!0,deletable:!0,template:function(e){var t=e.item;if(t.hasChildren)return t.name;var a="";return t.thumbnailImage?a=t.thumbnailImage:t.images&&t.images[0]&&(a=t.images[0].image),"<div class='hmi-palette-item' data-id='"+t.id+"' title='"+t.name+"'><span class='hmi-palette-image' style='background-image:url("+a+");'></span><span class='hmi-palette-text'>"+t.name+"</span></div>"},events:["save"]},init:function(e,t){var a=this;h(e).addClass("hmi-library-palette-widget"),a._wrapper=h("<div class='hmi-library-palette-widget-wrapper'/>");var i=h(e).parent();a._wrapper.append(e),i.append(a._wrapper),l.fn.init.call(this,e,t),a.wrapper=a._wrapper,delete a._wrapper,((t=a.options).creatable||t.searchable)&&(a._createSearchWrapper(),t.creatable&&a._createCreateButton(),t.searchable&&a._createSearch()),(t.editable||t.deletable)&&(a._createbuttonWrapper(),t.editable&&a._createEditButton(),t.deletable&&a._createDeleteButton()),a._initLibraryPopup();var n=p.CommonLoadingPanel;a.loadingPanel=new n},_hasChildren:function(e){var t,a=this.dataSource._pristineData,i=a.length,n=!0;for(t=0;t<i;t++)if(a[t].id==e.id){a[t].items.length<1&&(n=!1);break}return n},_click:function(e){var t,a,i,n=this,r=n.element;if(!e.parents("li."+b).length&&e.closest(".k-widget")[0]==r[0]){var l=e.closest(v),s=l.closest(m);n._updateSelected(l);var d=s.children(".k-group,.k-content"),o=this.dataItem(s);if(n._hasChildren(o)){if(!d.length&&(n.options.loadOnDemand&&o&&o.hasChildren||this._hasChildItems(s)||s.content||s.contentUrl)&&(d=n._addGroupElement(s)),a=s.find("> .k-panel").add(s.find("> .k-content")),t=!(!((i=l.attr("href"))&&("#"==i.charAt(i.length-1)||-1!=i.indexOf("#"+n.element[0].id+"-")))&&!a.length),a.data("animating"))return t;if(n._triggerEvent("select",s)&&(t=!0),!1!==t){if("single"==n.options.expandMode&&n._collapseAllExpanded(s))return t;if(a.length){var p=a.is(":visible");n._triggerEvent(p?"collapse":"expand",s)||(t=n._toggleItem(s,p))}return t}}}},_attachEvent:function(){l.fn._attachEvent.call(this),this.bind("change",this._selectionChangeEvt.bind(this))},_selectionChangeEvt:function(e){this._updateButtonStateFromSelectedData(e.item)},_dataBoundEvt:function(e){l.fn._dataBoundEvt.call(this,e),this.highlightSearchResult(),this._sortable()},highlightSearchResult:function(){var e=this.searchField.val();if(e){var t,a,i,n=this.items(),r=n.length,l=new RegExp(e,"gi");for(i=0;i<r;i++)(a=h(n[i])).hasClass("k-header")||(t=(t=(a=a.find(".hmi-palette-text")).html()).replace(l,I),a.html(t))}},_activateEvt:function(e){this._updateButtonStateFromSelectedData(),l.fn._activateEvt.call(this,e)},_updateButtonStateFromSelectedData:function(t){var e=this,a=e.options;if(t){var i,n,r=e.dataSource.data(),l=r.length;for(n=0;n<l;n++)if((i=r[n]).expanded){i.children.data().forEach(function(e){e.id!=t.id&&(e.selected=!1)});break}}var s=!!e.getSelectedData();a.editable&&e.editButton.prop("disabled",!s),a.deletable&&e.deleteButton.prop("disabled",!s)},_initLibraryPopup:function(){var v=this,m=p.I18N,e=v._onSavePopup.bind(v),t=v._onCancelPopup.bind(v);v.popup=h("<div class='hmi-library-palette-dialog'/>").kendoDetailDialog({title:m.prop("HMI_ADD_LIBRARY"),width:800,height:826,buttonsIndex:{CANCEL:0,SAVE:1},isCustomActions:!0,enableSaveBtnCondition:v._validatePopup,actions:[{text:m.prop("COMMON_BTN_CANCEL"),visible:!1,action:t},{text:m.prop("COMMON_BTN_SAVE"),visible:!1,action:e}],onTypeChange:function(e){var t=e.sender,a=e.sender.BTN;t.setEditable(!0),t.setActions(a.SAVE,{visible:!0}),t.setActions(a.CLOSE,{visible:!0});var i,n=t.element,r=t.getSelectedData(),l=r.images,s=l.length;for(i=0;i<s;i++)l[i].index=i+1;var d={Controlled:[{id:g.guid(),name:null,status:"OFF"},{id:g.guid(),name:null,status:"ON"}],Toggle:[{id:g.guid(),name:null,status:"OFF"},{id:g.guid(),name:null,status:"ON"}],Multi:[{id:g.guid(),index:1,name:null,min:0,max:100}]};d[r.type]=l;var o=h.extend({},!0,S);o.columns=[{field:"status",title:m.prop("COMMON_STATUS"),width:128},{field:"name",title:m.prop("HMI_IMAGE"),template:k}];var p=n.find(".image-list.controlled-type"),c=n.find(".image-list.toggle-type"),u=n.find(".image-list.multi-type");p.data("kendoGrid")||(o.dataSource=d.Controlled,t.controlledTypeImageList=p.kendoGrid(o).data("kendoGrid"),t.controlledTypeImageList.bind("dataBound",v._dataBoundEvtOtherImageList.bind(v))),c.data("kendoGrid")||(o.dataSource=d.Toggle,t.toggleTypeImageList=c.kendoGrid(o).data("kendoGrid"),t.toggleTypeImageList.bind("dataBound",v._dataBoundEvtOtherImageList.bind(v))),o.columns=[{field:"index",title:m.prop("HMI_LIBRARY_MULTI_STEPS"),width:55},{field:"range",title:m.prop("HMI_LIBRARY_MULTI_RANGE"),width:375,template:C},{field:"name",title:m.prop("HMI_IMAGE"),template:k},{field:"delete",title:m.prop("COMMON_BTN_DELETE"),template:T,width:64}],u.data("kendoGrid")||(o.dataSource=d.Multi,o.scrollable=!0,o.dataBound=function(e){var t=e.sender,a=t.element,i=t.dataSource.data();i.length<=1?a.find("tbody > tr:eq(0) .ic.ic-btn-remove-lg").addClass("disabled"):a.find("tbody > tr:eq(0) .ic.ic-btn-remove-lg").removeClass("disabled");var n=a.closest("div.multi-type").find(".image-list-add .ic-btn-add-lg");21<=i.length?n.addClass("disabled"):n.removeClass("disabled")},t.multiTypeImageList=u.kendoGrid(o).data("kendoGrid"),t.multiTypeImageList.bind("dataBound",v._dataBoundEvtMultiImageList.bind(v)),t.multiTypeImageList.refresh())},contentTemplate:'<div class="detail-dialog-content device-dialog-content"><div class="detail-dialog-detail-content"></div></div>',detailContentTemplate:'<div class="hmi-palette-library-popup-detail"><div class="field-row"><span class="field-col"><span class="field-name">'+m.prop("COMMON_NAME")+'</span></span><span class="field-col"><span class="field-value"><span class="library-name" data-role="commonvalidator" data-type="hmiLibraryName" data-bind="events:{validate:events.onNameValidate} data-required="true"><input type="text" class="k-input"  data-bind="value: name" placeholder="'+m.prop("COMMON_NAME")+'" required style="width:100%;"/></span></span></span></div><div class="field-row"><span class="field-col"><span class="field-name top">'+m.prop("HMI_TYPE")+'</span></span><span class="field-col"><span class="field-value"><p><input type="radio" class="k-radio" name="library-type" id="library-type_control" value="Controlled" data-bind="checked:type, events:{change:events.onChangeType}"/><label class="k-radio-label" for="library-type_control">'+m.prop("HMI_CONTROLLED_TYPE")+'</label></p><p><input type="radio" class="k-radio" name="library-type" id="library-type_toggle" value="Toggle" data-bind="checked:type, events:{change:events.onChangeType}"/><label class="k-radio-label" for="library-type_toggle">'+m.prop("HMI_TOGGLE_TYPE")+'</label></p><p><input type="radio" class="k-radio" name="library-type" id="library-type_multi" value="Multi" data-bind="checked:type, events:{change:events.onChangeType}"/><label class="k-radio-label" for="library-type_multi">'+m.prop("HMI_MULTI_TYPE")+'</label></p></span></span></div><div class="controlled-type" data-type="Controlled" data-bind="hmiLibraryPopupTypeVisible:type"><div class="field-row"><span class="field-col"><span class="field-name">'+m.prop("HMI_TAB_CONTROL")+'</span></span><span class="field-col"><span class="field-value"><input class="hmi-library-control-type" data-role="dropdownlist"data-text-field="text" data-value-field="id" data-bind="value: controlType, source: controlTypes, events:{change:events.onChangeControlType}"/></span></span></div><div class="field-row"><span class="field-name">'+m.prop("HMI_LIBRARY_LIST")+' (<span>2</span>)</span><div class="field-row"><table class="image-list controlled-type"></table></div></div></div><div class="toggle-type" data-type="Toggle" data-bind="hmiLibraryPopupTypeVisible:type"><div class="field-row"><span class="field-name">'+m.prop("HMI_LIBRARY_LIST")+' (<span>2</span>)</span><div class="field-row"><table class="image-list toggle-type"></table></div></div></div><div class="multi-type" data-type="Multi" data-bind="hmiLibraryPopupTypeVisible:type"><div class="field-row>"<span class="field-col"><span class="field-name">'+m.prop("HMI_VALUE")+'</span></span><span class="field-col"><span class="field-value"><p><span class="field-col"><span class="label">'+m.prop("HMI_LIBRARY_MULTI_MINIMUM")+'</span><span class="field min total" data-role="commonvalidator" data-type="hmiTotalMinMax" data-min="'+n+'" data-max="'+r+'" data-bind="events:{validate:events.onMinValidate}" data-required="true"><input type="text" class="k-input min total" data-bind="value: min, events:{change:events.onMinMaxChange}" required style="width:120px;"/></span></span><span class="field-col"><span class="divider">~</span></span><span class="field-col"><span class="label">'+m.prop("HMI_LIBARRY_MULTI_MAXIMUM")+'</span><span class="field max total" data-role="commonvalidator" data-type="hmiTotalMinMax" data-min="'+n+'" data-max="'+r+'" data-bind="events:{validate:events.onMaxValidate}," data-required="true"><input type="text" class="k-input max total" data-bind="value: max, events:{change:events.onMinMaxChange}" required style="width:120px;"/></span></span></p></span></span></div><div class="field-row list"><span class="field-name">'+m.prop("HMI_LIBRARY_LIST")+' (<span class="field" data-bind="text: step"></span>)</span><div class="field-row"><table class="image-list multi-type"></table><div class="image-list-add"><span class="ic ic-btn-add-lg"></span></div></div></div></div></div>',contentViewModel:{controlTypes:[{id:"Push",text:m.prop("HMI_PUSH")},{id:"Toggle",text:m.prop("HMI_TOGGLE")},{id:"Momentary",text:m.prop("HMI_MOMENTARY")}],controlType:"Push",min:0,max:100,step:1,events:{onNameValidate:function(e){if(e.valid){var t=e.sender.element.find("input").val();v.popup.contentViewModel.set("name",t),v.popup.enableSaveBtn()}else v.popup.disableSaveBtn()},onChangeType:function(e){v.popup.hasChanged=!0,v._validatePopup.call(v.popup)&&v.popup.enableSaveBtn()},onChangeControlType:function(e){v.popup.hasChanged=!0,v._validatePopup.call(v.popup)&&v.popup.enableSaveBtn()},onMinMaxChange:function(e){var t=h(e.target),a=v.popup.element,i=(t.hasClass("min")?a.find("span.max.total"):a.find("span.min.total")).data("kendoCommonValidator");i&&i.validate()},onMinValidate:function(e){var t=v.popup;v._validateImageList(),e.valid?t.enableSaveBtn():t.disableSaveBtn()},onMaxValidate:function(e){var t=v.popup;v._validateImageList(),e.valid?t.enableSaveBtn():t.disableSaveBtn()}}}}).data("kendoDetailDialog");var a=v.popup.element,i=v._addImageInPopupImageList.bind(v);a.on("click",".image-list tr td .ic.ic-close",v._deleteImageInPopupImageList.bind(v)),a.on("click",".image-list tr td .ic.ic-btn-add-sm",i),a.on("click",".image-list tr td .image-file-name",i),a.on("click",".image-list.multi-type tr td .ic.ic-btn-remove-lg",v._deleteRowInPopupImageList.bind(v)),a.on("click","div.multi-type .ic.ic-btn-add-lg",v._addRowInPopupImageList.bind(v)),a.on("keydown","input[type='text']",v._keydownInputInPopup.bind(v)),a.on("keyup","input[type='text']",v._keyupInputInPopup.bind(v)),v.popup.setCloseAction(t)},_keydownInputInPopup:function(e){var t=h(e.target),a=e.which?e.which:event.keyCode;if((t.hasClass("min")||t.hasClass("max"))&&(190==a||a==g.keys.NUMPAD_DOT))return!1},_keyupInputInPopup:function(e){this.popup.hasChanged=!0},_onCancelPopup:function(e){var t=p.I18N,a=e.sender;return a.hasChanged?(a.confirmDialog.message(t.prop("COMMON_CONFIRM_DIALOG_EDIT_CANEL")),a.confirmDialog.setConfirmActions({yes:function(){a.setEditable(!1),a.hideInvalidMessage(),a.hideRemoveBtn(),a.close()}}),a.confirmDialog.open()):(a.setEditable(!1),a.hideInvalidMessage(),a.hideRemoveBtn(),a.close()),!1},_onSavePopup:function(e){var t,a=this,i=a.popup,n=i.getSelectedData(),r=i.contentViewModel,l={id:r.id,type:r.type,name:r.name};"Controlled"==l.type?(t=i.controlledTypeImageList,l.controlType=r.controlType):t="Toggle"==l.type?i.toggleTypeImageList:(l.min=r.min,l.max=r.max,i.multiTypeImageList);var s=t.dataSource.data();l.images=s;var d=a.getParentInfo(l);return a._isNewItem(l)?(l._isNew=!0,l.sortOrder=a._getLastSortOrderInParent(d.to)+1):(l.oldImages=n._oldImages,s[0]&&s[0].image&&(l.thumbnailImage=s[0].image),n.type!=l.type?l.sortOrder=a._getLastSortOrderInParent(d.to)+1:l.sortOrder=n.sortOrder),a.trigger("save",{item:l}),!1},_getLastOrder:function(){var e,t,a=this.dataSource.data(),i=a.length,n=[];for(e=0;e<i;e++)(t=a[e].items)&&t.toJSON&&(t=t.toJSON()),n=n.concat(t);var r=new g.data.Query(n).sort({field:"sortOrder",dir:"asc"}).toArray(),l=r[r.length-1];return l?l.sortOrder:1},_getLastSortOrderInParent:function(e){var t=this.dataSource.get(e);if(t){var a=t.children,i=new g.data.Query(a.data()).sort({field:"sortOrder",dir:"asc"}).toArray,n=i[i.length-1];if(n)return n.sortOrder}return this._getLastOrder()},getTotalSize:function(){var e,t=this.dataSource.data(),a=t.length,i=0;for(e=0;e<a;e++)i+=t[e].items.length;return i},updateParent:function(e){var t=this.getParentInfo(e);return this.assignParent(e,t.from,t.to),t},assignParent:function(e,t,a){var i,n=this;n.dataSource;t!==a&&(t&&(t.load(),i=t.children,n.editDataSourceWithTransport("remove",i,e),n.dataSource.pushUpdate({id:t.id,items:t.items})),a&&(a.load(),i=a.children,n.editDataSourceWithTransport("add",i,e),n.dataSource.pushUpdate({id:a.id,items:a.items})))},getParent:function(e){var t,a=this.dataSource.data(),i=a.length;for(t=0;t<i;t++)if(a[t].children.get(e.id))return a[t];return null},getParentDs:function(e){var t,a=this.dataSource.data(),i=a.length;for(t=0;t<i;t++)if(a[t].children.get(e.id))return a[t].children;return null},getParentInfo:function(e){var t,a,i=this.dataSource.data(),n=i.length,r=null,l=null;for(a=0;a<n;a++)(t=i[a]).id==e.type&&(l=t),t.children.get(e.id)&&(r=t);return{from:r,to:l}},_isNewItem:function(e){var t=e.id;return isNaN(Number(t))},_validatePopup:function(e){var t,i=!0,a=this,n=a.contentViewModel.type,r=".common-validator.library-name";if("Controlled"==n?t=a.controlledTypeImageList:"Toggle"==n?t=a.toggleTypeImageList:"Multi"==n&&(t=a.multiTypeImageList,r+=",div.multi-type .common-validator"),a.element.find(r).each(function(e,t){var a=h(t).data("kendoCommonValidator");if(!(i=a.validate(null,null,!0)))return!1}),!i)return a.disableSaveBtn(),i;if(t){var l,s=t.dataSource.data(),d=s.length;for(l=0;l<d;l++)if(null===s[l].name){i=!1;break}if(!i)return a.disableSaveBtn(),i}return a.hasChanged||(a.disableSaveBtn(),i=!1),i},_dataBoundEvtOtherImageList:function(e){this._validatePopup.call(this.popup)&&this.popup.enableSaveBtn()},_dataBoundEvtMultiImageList:function(e){var t=this,a=e.sender,i=t._onValidateImageList.bind(t);a.element.find(".list-range-validator").each(function(e,t){(t=h(t)).kendoCommonValidator({type:"hmiImageListMinMax",required:!0,validate:i}).data("kendoCommonValidator").validate()}),t._validatePopup.call(t.popup)&&t.popup.enableSaveBtn()},_onChangeImageListRange:function(e){var t=h(e.target).data("id");this._validateImageList(t)},_onValidateImageList:function(e){var t=this.popup.multiTypeImageList,a=e.sender.element,i=a.hasClass("min"),n=a.find(".k-input"),r=n.data("id"),l=t.dataSource.get(r),s=n.val();l&&(i?l.min=Number(s):l.max=Number(s)),this._validateImageList(r,i,!0)},_validateImageList:function(r,l,s){this.popup.multiTypeImageList.element.find(".common-validator").each(function(e,t){var a,i=(t=h(t)).find(".k-input");if(r&&r==i.data("id")){var n=i.closest("td[role='gridcell']");return(a=l?n.find(".list-range-validator.max").data("kendoCommonValidator"):n.find(".list-range-validator.min").data("kendoCommonValidator"))&&a.validate(null,null,s),!0}(a=t.data("kendoCommonValidator"))&&a.validate(null,null,s)}),this._validatePopup.call(this.popup)&&this.popup.enableSaveBtn()},_addRowInPopupImageList:function(e){var t=h(e.target);if(!t.hasClass("disabled")){var a,i=t.closest("div.multi-type").find("table.image-list").data("kendoGrid"),n=i.dataSource,r=n.data(),l=r.length,s=this.popup.contentViewModel,d=s.max,o=s.min;for(a=0;a<l;a++)r[a].index=a+1,o<r[a].max&&(o=r[a].max>=d?d:r[a].max+1);n.pushCreate({id:g.guid(),index:l+1,name:null,min:o,max:d}),s.set("step",r.length),this.popup.hasChanged=!0;var p=i.element.closest(".k-auto-scrollable");if(0<p.length){var c=p.get(0).scrollHeight;p.scrollTop(c)}}},_deleteRowInPopupImageList:function(e){var t=h(e.target);if(!t.hasClass("disabled")){var a,i=t.closest("table.image-list").data("kendoGrid").dataSource,n=i.data(),r=t.data("id"),l=i.get(r),s=n.length,d=1;for(a=0;a<s;a++)n[a]!==l&&(n[a].index=d,d++);i.remove(l),this.popup.contentViewModel.set("step",n.length),this.popup.hasChanged=!0}},_addImageInPopupImageList:function(e){var i=this,n=p.HmiModel,t=p.HmiCommon,a=h(e.target);if(!a.hasClass("disabled")){var r=a.closest(".image-wrapper").data("id"),l=a.closest("table.image-list").data("kendoGrid").dataSource,s=l.get(r),d=l.indexOf(s)+1;p.HmiUtil.getImageInfoFromFile("hmi-library-image",t.LIBRARY_IMAGE_FILE_MAX_SIZE).done(function(e){var t=e.file,a=e.dataUrl;i.popup.hasChanged=!0,s.image=a,s.file=t,s.set("id",n.addComponentNumber(d,t.name)),s.set("name",t.name)}).fail(function(e){i.popup.msgDialog.message(e),i.popup.msgDialog.open()}).always(function(){})}},_deleteImageInPopupImageList:function(e){var t=h(e.target);if(!t.hasClass("disabled")){var a=t.closest("table.image-list").data("kendoGrid").dataSource,i=t.data("id"),n=a.get(i);n.image=null,n.file=null,n.set("name",null),n.set("id",g.guid()),this.popup.hasChanged=!0}},_createCreateButton:function(){var t=this;t.searchWrapper.append('<button class="k-button create-btn">'+p.I18N.prop("COMMON_BTN_CREATE")+"</button>"),t.createButton=t.searchWrapper.find(".create-btn"),t.createButton.on("click",function(){var e=p.I18N;t.popup.title(e.prop("HMI_ADD_LIBRARY")),t.popup.setDataSource({id:g.guid(),name:"",type:"Controlled",controlType:"Push",images:[{id:g.guid(),name:null,status:"OFF"},{id:g.guid(),name:null,status:"ON"}]}),t.popup.dialogType="add",t.popup.open()})},_createSearchWrapper:function(){this.searchWrapper=h("<div class='search-wrapper'/>"),this.wrapper.prepend(this.searchWrapper),this.wrapper.addClass("enable-search")},_createSearch:function(){var t=this;t.searchWrapper.append('<span class="search-field-wrapper"><input type="text" class="k-input search-field" placeholder="'+p.I18N.prop("HMI_LIBRARY_SEARCH_PLACEHOLDER")+'"/><button class="ic ic-bt-input-search"></button></span>'),t.searchFieldWrapper=t.searchWrapper.find(".search-field-wrapper"),t.searchField=t.searchWrapper.find(".search-field"),t.searchButton=t.searchWrapper.find(".ic-bt-input-search");var e=t.search.bind(t);t.searchField.on("keyup",e),t.searchButton.on("click",function(e){t._isSearching&&t.searchField.val(""),t.search({keyCode:g.keys.ENTER})})},search:function(e){var t=this,a=t.searchField.val();e.keyCode&&e.keyCode==g.keys.ENTER?t.enableSearchList(a):t.searchFieldWrapper.hasClass("searching")&&(t._isSearching=!1,t.searchFieldWrapper.removeClass("searching"))},clearSearchResult:function(){this.searchField.val(""),this.search({keyCode:g.keys.ENTER})},enableSearchList:function(e){var t=this;t.dataSource;if(e){if(t.searchFieldWrapper.addClass("searching"),t._isSearching=!0,e){var a={logic:"or",filters:[{field:"name",operator:"contains",value:e}]};t.filterChildren(a)}t.createButton.prop("disabled",!0)}else t.filterChildren([]),t.searchFieldWrapper.removeClass("searching"),t._isSearching=!1,t.createButton.prop("disabled",!1);t._updateButtonStateFromSelectedData()},filterChildren:function(e){var t,a,i=this.dataSource,n=i.data(),r=n.length;for(a=0;a<r;a++)(t=n[a].children)&&t.filter(e);i.fetch()},_updateSelected:function(e,t){var a=this,i=a.element,n=e.parent(m),r=a._selected,l=a.dataItem(n);r&&r.removeAttr(y),a._selected=n.attr(y,!0),i.find("> li > .k-state-selected, .k-panel > li > .k-state-selected").removeClass(s),i.find("> ."+d+", .k-panel > ."+d).removeClass(d),e.addClass(s),e.parentsUntil(i,m).filter(":has(.k-header)").addClass(d),a._current(n[0]?n:null),l&&l.set("selected",!0),t||a.trigger("change",{item:l})},getSelectedData:function(){var e=this.dataSource.data(),t=new g.data.Query(e).filter({field:"expanded",operator:"eq",value:!0}).toArray();if(t[0]){var a=(t=t[0]).items;return new g.data.Query(a).filter({field:"selected",operator:"eq",value:!0}).toArray()[0]}return null},_createbuttonWrapper:function(){this.buttonWrapper=h("<div class='button-wrapper'/>"),this.wrapper.append(this.buttonWrapper),this.wrapper.addClass("enable-button")},_createEditButton:function(){var n=this,r=p.HmiApi;n.buttonWrapper.append(e("create")),n.editButton=n.wrapper.find(".edit-btn"),n.editButton.prop("disabled",!0),n.editButton.on("click",function(e){var t=n.getSelectedData(),a=p.I18N;n.loadingPanel.open();var i=t.id;r.getComponent(i).done(function(e){n.popup.title(a.prop("HMI_EDIT_LIBRARY")),(t=(t=h.extend(t,e)).toJSON())._oldImages=t.images,n.popup.setDataSource(t),n.popup.dialogType="edit",n.popup.open()}).fail(function(e){}).always(function(){n.loadingPanel.close()})})},_createDeleteButton:function(){var a=this;a.buttonWrapper.append(e("delete")),a.deleteButton=a.wrapper.find(".delete-btn"),a.deleteButton.prop("disabled",!0),a.deleteButton.on("click",function(e){var t=a.getSelectedData();a.trigger("delete",{event:e,item:t,success:a._deleteSuccessCallback.bind(a,{item:t}),fail:a._deleteFailCallback.bind(a,{item:t})})})},apiPostComponent:function(l){var s=this,d=new h.Deferred,o=s.dataSource,e=p.HmiApi;p.Util,p.I18N;return e.postComponent(l).done(function(e){l.id=e;var t=s.updateParent(l);if(t.from!==t.to&&t.to&&t.to.id!==l.type){var a,i=new g.data.Query(o.data()).filter({field:"expanded",operator:"eq",value:!0}).toArray(),n=i.length;if(0<n)for(a=0;a<n;a++)i[a].set("expanded",!1);var r=o.get(t.to.id);r&&r.set("expanded",!0)}l=o.get(l.id),d.resolve(l)}).fail(function(e){o.fetch(),d.reject(e)}),d.promise()},apiPutComponent:function(n){var r=this,l=new h.Deferred,s=r.dataSource,e=p.HmiApi;p.Util,p.I18N;return e.putComponent(n).done(function(e){r.getParentDs(n).pushUpdate(n);var t=r.updateParent(n);if(t.from!==t.to&&t.to){var a=s.get(t.from.id);a&&a.set("expanded",!1);var i=s.get(t.to.id);i&&i.set("expanded",!0)}n=s.get(n.id),l.resolve(n)}).fail(function(e){s.fetch(),l.reject(e)}),l.promise()},_deleteSuccessCallback:function(e){var t=e.item,a=this.getParent(t),i=a.children;this.editDataSourceWithTransport("remove",i,t),this.dataSource.pushUpdate({id:a.id,items:a.items.toJSON()}),a.items.length<1&&(a.set("expanded",!1),this.dataSource.fetch())},_deleteFailCallback:function(e){this.dataSource.fetch()},_saveExpandedItem:function(){var e=this.dataSource.data(),t=new g.data.Query(e).filter({field:"expanded",operator:"eq",value:!0}).toArray();if(t[0]){t=t[0],this._lastExpandedItemId=t.id;var a=t.items,i=new g.data.Query(a).filter({field:"selected",operator:"eq",value:!0}).toArray();i[0]&&(this._lastSelectedItemId=i.id)}},_restoreExpandedItem:function(){var e=this.dataSource;if(this._lastExpandedItemId){var t=e.get(this._lastExpandedItemId);t&&t.set("expanded",!0)}if(this._lastSelectedItemId){var a,i,n=e.data(),r=n.length;for(i=0;i<r;i++)(a=n[i].children.get(this._lastSelectedItemId))&&a.set("selected",!0)}},setDataSource:function(e){this._saveExpandedItem(),l.fn.setDataSource.call(this,e),this._restoreExpandedItem()},_dataSource:function(){var e=this,t=e.options.dataSource;t&&(t=a(t)?{data:t}:t,e._unbindDataSource(),t.fields||(t.fields=[{field:"text"},{field:"url"},{field:"spriteCssClass"},{field:"imageUrl"}]),e.dataSource=o.create(t),e.dataSource.read(),e._applyDefaultSort(e.dataSource),e._bindDataSource())},_applyDefaultSort:function(e){if(e instanceof g.data.HierarchicalDataSource){var t,a=e.data(),i=a.length;for(t=0;t<i;t++){a[t].children.sort(this._getDefaultSort())}}},_getDefaultSort:function(){return[{field:"sortOrder",dir:"asc"}]},_sortable:function(){var v=this;v.element.find("> .k-item").each(function(){var e=h(this);if(e.data("kendoSortable"))return!0;e.kendoSortable({autoScroll:!0,container:e,filter:".k-group > .k-item",hint:function(e){return v._helper},start:function(e){var t=v.element.data("kendoTooltip");t&&t.hide()},end:function(e){var t=e.draggableEvent;if(v.isDropInCanvas(t.clientX,t.clientY))return e.preventDefault(),!1},change:function(e){var t,a,i,n=v.dataSource,r=e.newIndex,l=v.dataItem(e.item),s=n.data(),d=s.length,o=[];for(i=0;i<d;i++)(a=s[i].children).get(l.id)&&(t=s[i]),(a=a.data()).forEach(function(e){o.push(e)});t||console.error("there is no parent this sorted item.");var p=t.children;if((a=p.view())[(l.index=r)-1]){var c=a[r-1];l.set("sortOrder",c.sortOrder+1)}else if(a[r+1]){var u=a[r+1];l.set("sortOrder",u.sortOrder-1)}p.pushUpdate({id:l.id,sortOrder:l.sortOrder}),v.reOrderChildren(l,o),v.trigger("sort",{item:l,reOrderedItems:o,success:v._sortSuccessCallback.bind(v,{item:l,reOrderedItems:o}),fail:v._sortFailCallback.bind(v,{item:l,reOrderedItems:o})})}})})},_sortSuccessCallback:function(e){this.getParent(e.item);this.dataSource.data().length},_sortFailCallback:function(e){this.dataSource.fetch()},reOrderChildren:function(e,t){var a=new g.data.Query(t).sort(this._getDefaultSort()).filter({logic:"and",filters:[{field:"sortOrder",operator:"gte",value:e.sortOrder},{field:"id",operator:"neq",value:e.id}]}).toArray(),i=this.getParentDs(e);i&&i.pushUpdate({id:e.id,sortOrder:e.sortOrder});var n,r,l=a.length,s=e.sortOrder;for(n=0;n<l;n++)(r=a[n]).set("sortOrder",s+(n+1)),(i=this.getParentDs(r))&&i.pushUpdate({id:r.id,sortOrder:r.sortOrder})},reOrderChildrenIndex:function(e,t){var a=new g.data.Query(t).sort(this._getDefaultSort()).filter({logic:"and",filters:[{field:"index",operator:"gte",value:e.index},{field:"id",operator:"neq",value:e.id}]}).toArray(),i=this.getParentDs(e);i&&(i.pushUpdate({id:e.id,index:e.index}),i.pushInsert(e.index,e));var n,r,l=a.length,s=e.index;for(n=0;n<l;n++)(r=a[n]).index=s+(n+1),(i=this.getParentDs(r))&&i.pushUpdate({id:r.id,index:r.index})},_convertToPaletteItem:function(e){var t=new h.Deferred;delete(e=e.toJSON()).index;var a,i,n=e.images,r=n.length,l="/dms/hmi/components/{id}/images/{name}".replace("{id}",e.id);for(i=0;i<r;i++)delete(s=n[i]).image,a=s.id,s.image=l.replace("{name}",a);var s,d={categoryName:"Custom",className:"CustomComponent",groupName:"CustomComponent",value:e.id,text:e.name,imageUrl:n[0].image},o={binding:{custom:e}};return(s=new Image).src=d.imageUrl,s.onload=function(){d.imageWidth=this.width,d.imageHeight=this.height,t.resolve(d,o)},s.onerror=function(){d.imageWidth=50,d.imageHeight=50,t.resolve(d,o)},t.promise()},_clickEvt:function(a){var i=this,e=this.dataSource,t=h(a.target).closest(".hmi-palette-item");t.length<1&&(t=h(a.target).find(".hmi-palette-item"));var n=t.data("id"),r=e.get(n);r?i._convertToPaletteItem(r).done(function(e,t){a.item=e,a.options=t,i.trigger("click",a)}):console.error("there is no item in datasource.")},_doubleClickEvt:function(a){var i=this,e=this.dataSource,t=h(a.target).closest(".hmi-palette-item");t.length<1&&(t=h(a.target).find(".hmi-palette-item"));var n=t.data("id"),r=e.get(n);r?i._convertToPaletteItem(r).done(function(e,t){a.item=e,a.options=t,i.trigger("dblclick",a)}):console.error("there is no item in datasource.")},isDropInCanvas:function(e,t){var a,i,n=document.elementsFromPoint(e,t),r=n.length;for(i=0;i<r;i++)if(a=n[i],h(a).hasClass("hmi-create-content-graphic-view-canvas"))return!0;return!1},_dropEvt:function(a,e){var i=this,t=e.helper,n=i.dataSource,r=t.find(".hmi-palette-item").data("id"),l=n.get(r);l&&i._convertToPaletteItem(l).done(function(e,t){a.item=e,a.options=t,i.trigger("drop",a)})},_tooltip:function(){var e=this.element,t=e.data("kendoTooltip");t?t.refresh():e.kendoTooltip({filter:".k-group > li.k-item",wrapperCssClass:"hmi-palette-tooltip",content:function(e){return e.target.find(".hmi-palette-item").attr("title")},position:"left"}).data("kendoToolTip")},refresh:function(e){var t=this.options,a=e.node,i=e.action,n=e.items,r=this.wrapper,l=t.loadOnDemand,s=e.field;if(s){if(!n[0])return;if("expanded"!=s||!n[0][s])return this._updateItems(n,e.field);var d=(a=n[0]).children;r=this.findByUid(a.uid);var o=d.view(),p=h(r).find("> ul[role='group'] > li[role='menuitem']");0<o.length&&p.length<1&&this._refreshChildren(a,r)}if(a&&(r=this.findByUid(a.uid),this._progress(r,!1)),"add"==i?this._appendItems(e.index,n,r):"remove"==i?this.remove(this.findByUid(n[0].uid)):"itemchange"==i?this._updateItems(n):"itemloaded"==i?this._refreshChildren(a,r):this._refreshRoot(n),"remove"!=i)for(var c=0;c<n.length;c++)if(!l||n[c].expanded){var u=n[c];this._hasChildItems(u)&&u.load()}this.trigger("dataBound",{node:a?r:void 0})},_insert:function(e,t,a){var i,n,r=this,l=h.isPlainObject(e),s=t&&t[0];if(s||(a=r.element),n={firstLevel:a.hasClass("k-panelbar"),expanded:h(t).hasClass(f),length:a.children().length},s&&!a.length&&(a=h(r.renderGroup({group:n,options:r.options})).appendTo(t)),l||h.isArray(e)||e instanceof o){if(e instanceof o&&(e=e.view()),i=h.map(l?[e]:e,function(e,t){return h("string"==typeof e?e:r.renderItem({group:n,item:u(e,{index:t})}))}),s){var d=r.dataItem(t);d&&(d.hasChildren=!0),t.attr(_,!1)}}else i="string"==typeof e&&"<"!=e.charAt(0)?r.element.find(e):h(e),r._updateItemsClasses(i);return e.length||(e=[e]),r._angularCompileElements(i,e),{items:i,group:a}},_refreshChildren:function(e,t){var a,i,n;t.children(".k-group").empty();var r,l,s,d,o=e.children.data();if(o.length)for(this.append(e.children,t),this.options.loadOnDemand&&e.expanded&&this._toggleGroup(t.children(".k-group"),!1),i=t.children(".k-group").children("li"),a=0;a<i.length;a++)n=i.eq(a),this.trigger("itemChange",{item:n,data:this.dataItem(n),ns:c});else s=(l=r=t).children("ul"),d=l.children(".k-link").children(".k-icon"),r.hasClass("k-panelbar")||(!d.length&&s.length?d=h("<span class='k-icon' />").appendTo(l):s.length&&s.children().length||(d.remove(),s.remove())),i=t.children(".k-group").children("li"),this._angularCompileElements(i,o)},closePopup:function(){this.popup.close()},editDataSourceWithTransport:function(e,t,a){var i=t.transport.data.items;if("add"==e)t.pushCreate(a),i.push(a);else if("remove"==e){t.pushDestroy(a);var n,r=i.length;for(n=0;n<r;n++)if(i[n].id==a.id){i.splice(n,1);break}}},renderItem:function(e){var t=this;e=u({panelBar:t,group:{}},e);var a=t.templates.empty,i=e.item;return t.templates.item(u(e,{itemWrapper:t.templates.itemWrapper,renderContent:t.renderContent,arrow:t._hasChildItems(i)||i.content||i.contentUrl?t.templates.arrow:a,subGroup:!e.loadOnDemand||i.expanded?t.renderGroup:a},x))},_updateItems:function(e,t){var a,i,n,r,l=this,s={panelBar:l.options,item:r,group:{}},d="expanded"!=t;if("selected"==t)if(e[0][t]){var o=l.findByUid(e[0].uid);o.hasClass(b)||l.select(o,!0)}else l.clearSelection();else{var p=h.map(e,function(e){return l.findByUid(e.uid)});for(d&&l.angular("cleanup",function(){return{elements:p}}),a=0;a<e.length;a++)s.item=r=e[a],s.panelBar=l,i=(n=p[a]).parent(),d&&(s.group={firstLevel:i.hasClass("k-panelbar"),expanded:n.parent().hasClass(f),length:n.children().length},n.children(".k-link").remove(),n.prepend(l.templates.itemWrapper(u(s,{arrow:r.hasChildren||r.content||r.contentUrl?l.templates.arrow:l.templates.empty},x)))),"expanded"==t?l._toggleItem(n,!r[t],!r[t]||"true"):"enabled"==t&&(l.enable(n,r[t]),r[t]||r.selected&&r.set("selected",!1)),n.length&&this.trigger("itemChange",{item:n,data:r,ns:c});d&&l.angular("compile",function(){return{elements:p,data:h.map(e,function(e){return[{dataItem:e}]})}})}}});g.ui.plugin(t)}(window,jQuery),function(Y,b){"use strict";var I=Y.kendo,r=I.ui.Widget;function s(e){return"<span class=search-highlight>"+e+"</span>"}function j(e){return null!=e}function k(e){var t,a=Y.Util,i=e.length;for(t=0;t<i;t++)e[t].name=a.getDetailDisplayTypeDeviceI18N(e[t].id);return e}var i={height:"100%",scrollable:!1,sortable:!1,filterable:!1,pageable:!1,showGridHeader:!1,selectable:"row",hasSelectedModel:!0,setSelectedAttribute:!0},u=["BasicShape","Line","Zone","HyperLink","Table","Statistics","Label","Group","ImportImage"],U=["strokeDasharray","sourceMarker","targetMarker","strokeWidth"],v=["width","height","x","y","minValue","maxValue"],C="all";I.data.binders.hmiBindingFilterSelectedType=I.data.Binder.extend({refresh:function(){var e=this.bindings.hmiBindingFilterSelectedType.get(),t=b(this.element),a=t.closest(".title"),i=a.closest(".hmi-binding-filter-item").data("type"),n=t.attr("data-id");"device"==i?"null"===n||null===n||n&&1<n.split(",").length?a.removeClass("active"):a.addClass("active"):n==C?a.removeClass("active"):a.addClass("active"),t.text(e)}}),I.data.binders.hmiVisibleControlPoint=I.data.Binder.extend({refresh:function(){var e=Y.HmiUtil,t=this.bindings.hmiVisibleControlPoint.get(),a=b(this.element),i=a.closest(".hmi-binding-device-info").find("td.device-id-cell");!t||e.isControlPointType(t)?(i.attr("colspan",2),a.show()):(i.attr("colspan",1),a.hide())}}),I.data.binders.hmiInvisibleIndoor=I.data.Binder.extend({refresh:function(){var e=this.bindings.hmiInvisibleIndoor.get(),t=b(this.element),a=t.closest(".hmi-binding-device-info").find("td.device-id-cell");e?(a.attr("colspan",1),t.hide()):(a.attr("colspan",2),t.show())}});function m(e,t,a){var i,n=t.name,r=t.items,l="<div class='hmi-binding-property-category' data-key='"+e+"' data-bind='visible:properties."+e+".visible'><div class='category-title'><span class='ic' data-bind='css:{expand:properties."+e+".expanded}'></span><span class='title'>"+n+"</span></div><ul class='category-items' data-bind='visible:properties."+e+".expanded'>",s="";for(i in r)a&&-1==a.indexOf(i)||(s+="<li class='property' data-key='"+i+"' data-category='"+e+"' data-bind='visible:properties."+e+".items."+i+".visible'>"+d(i,r[i])+"</li>");return s?(l+=s,l+="</ul></div>"):s}function h(e,t){var a;-1!=(a=e.indexOf(t))&&e.splice(a,1)}function X(e,t){var a;t.sender?a=t.sender.element:t.target&&(a=b(t.target));var i=a.closest("li.property"),n=i.data("category"),r=i.data("key");this.trigger("property",{type:e,event:t,category:n,field:r})}function Q(e){var t,a,i,n,r,l=Y.I18N,s=e.length,d=[],o=1==s,p=X.bind(this,"change");for(t=0;t<s;t++)i="object"==typeof(n=e[t])?(a=n.text,n.value):a=n,(r={name:l.prop("HMI_ITEM")+(t+1),text:a,value:i,change:p}).removeBtnDisabled=o,d.push(r);return d}function g(e){var t,a,i=e.length,n=[];for(t=0;t<i;t++)a=e[t],n.push({text:a.text,value:a.value});return n}function f(e){var t,a=Y.HmiCommon.lineMarkerDataSource,i=a.length;for(t=0;t<i;t++)if(a[t].value==e)return{points:e,fill:a[t].fill};return{points:a[0].value,fill:a[0].fill}}function Z(e,t){var a,i,n=[],r=e.length;for(a=0;a<r;a++)i=e[a],i=b.extend(!0,{},i),n.push(i),t==i.value?i.selected=!0:i.selected=!1;return n}var d=function(e,t){Y.HmiCommon;var a=Y.I18N,i={propertyType:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.general.items.propertyType.value, source: properties.general.items.propertyType.dataSource, events:{change:events.change}, disabled:properties.general.items.propertyType.disabled'/></span>",buttonType:'<span class=\'name block\'>#:name#</span><span class=\'value\'><p class="block-wrapper"><input type="radio" class="k-radio" name="button-type" id="button-type_push" value="Push" data-bind="checked:properties.button.items.buttonType.value, events:{change:events.change}"/><label class="k-radio-label" for="button-type_push">'+a.prop("HMI_PUSH")+'</label></p><p class="block-wrapper"><input type="radio" class="k-radio" name="button-type" id="button-type_toggle" value="Toggle" data-bind="checked:properties.button.items.buttonType.value, events:{change:events.change}"/><label class="k-radio-label" for="button-type_toggle">'+a.prop("HMI_TOGGLE")+'</label></p><p class="block-wrapper"><input type="radio" class="k-radio" name="button-type" id="button-type_momentary" value="Momentary" data-bind="checked:properties.button.items.buttonType.value, events:{change:events.change}"/><label class="k-radio-label" for="button-type_momentary">'+a.prop("HMI_MOMENTARY")+"</label></p></span>",buttonToggleOnText:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-required='true'><input class='k-input' data-bind='value:properties.text.items.buttonToggleOnText.value' required/><i class='ic ic-btn-remove-sm'></i></span></span>",buttonToggleOffText:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-required='true'><input class='k-input' data-bind='value:properties.text.items.buttonToggleOffText.value' required/><i class='ic ic-btn-remove-sm'></i></span></span>",textLocation:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.text.items.textLocation.value, source: properties.text.items.textLocation.dataSource, events:{change:events.change}, disabled:properties.text.items.textLocation.disabled'/></span>",reverse:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.general.items.reverse.value, source: properties.general.items.reverse.dataSource, events:{change:events.change}, disabled:properties.general.items.reverse.disabled'/></span>",buttonColor:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.color.items.buttonColor.value, source: properties.color.items.buttonColor.dataSource, events:{change:events.change}, disabled:properties.color.items.buttonColor.disabled'/></span>",value:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-required='#:required#'><input class='k-input' data-bind='value:properties.text.items.value.value, disabled:properties.text.items.value.disabled' required/><i class='ic ic-btn-remove-sm'></i></span></span>",unit:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator'><input class='k-input' data-bind='value:properties.text.items.unit.value'/><i class='ic ic-btn-remove-sm'></i></span></span>",label:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-required='false' data-max-length='30' data-scroll-wrapper-class='hmi-binding-property-inner-wrapper'><input class='k-input' data-bind='value:properties.text.items.label.value, disabled:properties.text.items.label.disabled'/><i class='ic ic-btn-remove-sm'></i></span></span>",prefix:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-max-length='30'><input class='k-input' data-bind='value:properties.text.items.prefix.value'/><i class='ic ic-btn-remove-sm'></i></span></span>",suffix:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-max-length='30'><input class='k-input' data-bind='value:properties.text.items.suffix.value'/><i class='ic ic-btn-remove-sm'></i></span></span>",gauge:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.text.items.gauge.value, source: properties.text.items.gauge.dataSource, events:{change:events.change}, disabled:properties.text.items.gauge.disabled'/></span>",checkboxLabel:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-required='false' data-max-length='30' data-scroll-wrapper-class='hmi-binding-property-inner-wrapper'><input class='k-input' data-bind='value:properties.text.items.checkboxLabel.value'/><i class='ic ic-btn-remove-sm'></i></span></span>",x:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-bind='events:{validate:events.validate}' data-type='numeric' data-min='0' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' data-min='0' data-max='#:max#' data-format='\\#' data-bind='value: properties.location.items.x.value, events: {spin: events.change, change : events.change}, disabled: properties.location.items.x.disabled' required style='width:100%;'/></span></span>",y:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-bind='events:{validate:events.validate}' data-type='numeric' data-min='0' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' data-min='0' data-max='#:max#' data-format='\\#' data-bind='value:properties.location.items.y.value, events: {spin: events.change, change : events.change}, disabled: properties.location.items.y.disabled' required style='width:100%;'/></span></span>",width:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-bind='events:{validate:events.validate}' data-type='numeric' data-min='#:min#' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-bind='value:properties.size.items.width.value, events: {spin: events.change, change : events.change}, disabled: properties.size.items.width.disabled' required style='width:100%;'/></span></span>",height:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-bind='events:{validate:events.validate}' data-type='numeric' data-min='#:min#' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-bind='value:properties.size.items.height.value, events: {spin: events.change, change : events.change}, disabled: properties.size.items.height.disabled' required style='width:100%;'/></span></span>",fillColor:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-colorfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.fillColor.value}'></span></span><span class='ic ic-arrow'></span></div></span>",graphicColor:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.color.items.graphicColor.value, source: properties.color.items.graphicColor.dataSource, events:{change:events.change}, disabled:properties.color.items.graphicColor.disabled'/></span>",graphicColorOff:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-template='hmi-dropdownlist-disabled-template' data-text-field='text' data-value-field='value' data-bind='value:properties.color.items.graphicColorOff.value, source: properties.color.items.graphicColorOff.dataSource, events:{open:events.open, select:events.select, change:events.change}, disabled:properties.color.items.graphicColorOff.disabled'/></span>",graphicColorOn:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-template='hmi-dropdownlist-disabled-template' data-text-field='text' data-value-field='value' data-bind='value:properties.color.items.graphicColorOn.value, source: properties.color.items.graphicColorOn.dataSource, events:{open:events.open, select:events.select, change:events.change}, disabled:properties.color.items.graphicColorOn.disabled'/></span>",svgGraphicColorOff:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-colorfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.svgGraphicColorOff.value}'></span></span><span class='ic ic-arrow'></span></div></span>",svgGraphicColorOn:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-colorfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.svgGraphicColorOn.value}'></span></span><span class='ic ic-arrow'></span></div></span>",svgTextOff:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-value-field='svgTextColorOff' data-bind='events:{click:events.click}'><span class='ic ic-tool-textfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.text.items.svgTextOff.value.svgTextColorOff}'></span></span><span class='ic ic-arrow'></span></div></span><p class='block-wrapper' style='margin-bottom:10px;'><div data-role='commonvalidator' data-type='text' data-max-length=30 data-bind='events:{validate : events.validate}'><input class='k-input' data-bind='value: properties.text.items.svgTextOff.value.textOff' style='width:100%;'/></div></p>",svgTextOn:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-value-field='svgTextColorOn' data-bind='events:{click:events.click}'><span class='ic ic-tool-textfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.text.items.svgTextOn.value.svgTextColorOn}'></span></span><span class='ic ic-arrow'></span></div></span><p class='block-wrapper' style='margin-bottom:10px;'><div data-role='commonvalidator' data-type='text' data-max-length=30 data-bind='events:{validate : events.validate}'><input class='k-input' data-bind='value: properties.text.items.svgTextOn.value.textOn' style='width:100%;'/></div></p>",dataColor:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-colorfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.dataColor.value}'></span></span><span class='ic ic-arrow'></span></div></span>",timeRange:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.general.items.timeRange.value, source: properties.general.items.timeRange.dataSource, events:{change:events.change}, disabled:properties.general.items.timeRange.disabled'/></span>",fontSize:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-min='2' data-max='64' data-required='true' data-bind='events:{validate:events.validate}'><input data-role='numerictextbox' type='number' class='k-input spinner' min='2' max='64' data-format='\\#' data-bind='value: properties.font.items.fontSize.value, events: {spin: events.change, change : events.change}, disabled: disabled' required style='width:100%;'/></span></span>",strokeColor:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-linecolor'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.strokeColor.value}'></span></span><span class='ic ic-arrow'></span></div></span>",strokeWidth:"<span class='name'>#:name#</span><span class='value line'><input data-role='dropdownlist' data-popup-class='hmi-binding-line-width-dropdown-popup' data-template='hmi-binding-line-width-dropdownlist-template' data-value-template='hmi-binding-line-width-dropdownlist-value-template' data-text-field='name' data-value-field='id' data-bind='value:properties.line.items.strokeWidth.value, source: properties.line.items.strokeWidth.dataSource, events:{change:events.change}, disabled:properties.line.items.strokeWidth.disabled'/></span>",fontColor:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-textfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.font.items.fontColor.value}'></span></span><span class='ic ic-arrow'></span></div></span>",fontType:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-template='hmi-font-type-dropdownlist-template' data-text-field='text' data-value-field='value' data-bind='value:properties.font.items.fontType.value, source: properties.font.items.fontType.dataSource, events:{change:events.change}, disabled:properties.font.items.fontType.disabled'/></span>",fontStyle:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.font.items.fontStyle.value, source: properties.font.items.fontStyle.dataSource, events:{change:events.change}, disabled:properties.font.items.fontStyle.disabled'/></span>",minValue:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-type='hmiMinMax' data-min='#:min#' data-max='#:max#' data-required='true' data-bind='events:{validate:events.validate}' data-scroll-wrapper-class='hmi-binding-property-inner-wrapper'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-decimals='0' data-bind='value:properties.minMax.items.minValue.value, events: {spin: events.change, change : events.change}, disabled: properties.minMax.items.minValue.disabled' required style='width:100%;'/></span></span>",maxValue:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-type='hmiMinMax' data-min='#:min#' data-max='#:max#' data-required='true' data-bind='events:{validate:events.validate}' data-scroll-wrapper-class='hmi-binding-property-inner-wrapper'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-decimals='0' data-bind='value:properties.minMax.items.maxValue.value, events: {spin: events.change, change : events.change}, disabled: properties.minMax.items.maxValue.disabled' required style='width:100%;'/></span></span>",optionValues:"<div class='hmi-binding-option-values'><div class='hmi-binding-option-values-lits' data-template='hmi-binding-option-values-template' data-bind='source:properties.optionValues.items.optionValues.value'></div><div class='hmi-binding-option-values-add'><a class='ic ic-plus add-btn' data-bind='css:{disabled:properties.optionValues.items.optionValues.addBtnDisabled}'></a></div></div>",strokeDasharray:"<span class='name'>#:name#</span><span class='value line'><input data-role='dropdownlist' data-popup-class='hmi-binding-dash-dropdown-popup' data-template='hmi-dash-dropdownlist-template' data-value-template='hmi-dash-dropdownlist-value-template' data-text-field='text' data-value-field='value' data-bind='value:properties.line.items.strokeDasharray.value, source: properties.line.items.strokeDasharray.dataSource, events:{change:events.change}, disabled:properties.font.items.fontType.disabled'/></span>",sourceMarker:"<span class='name'>#:name#</span><span class='value line'><input data-role='dropdownlist' data-popup-class='hmi-binding-marker-dropdown-popup' data-template='hmi-marker-dropdownlist-template' data-value-template='hmi-marker-dropdownlist-value-template' data-text-field='text' data-value-field='value' data-bind='value:properties.line.items.sourceMarker.value, source: properties.line.items.sourceMarker.dataSource, events:{change:events.change}, disabled:properties.line.items.sourceMarker.disabled'/></span>",targetMarker:"<span class='name'>#:name#</span><span class='value line'><input data-role='dropdownlist' data-popup-class='hmi-binding-marker-dropdown-popup' data-template='hmi-marker-dropdownlist-template' data-value-template='hmi-marker-dropdownlist-value-template' data-text-field='text' data-value-field='value' data-bind='value:properties.line.items.targetMarker.value, source: properties.line.items.targetMarker.dataSource, events:{change:events.change}, disabled:properties.line.items.targetMarker.disabled'/></span>",file:"<span class='name' style='width:60px;'>#:name#</span><span class='value'><span class='file-name' data-bind='text: properties.hyperLink.items.file.value.name, events:{click:events.click}'></span></span>",highlightColor:"<span class='name'>#:name#</span><span class='value'><div class='binding-colorpicker-wrapper k-button' data-bind='events:{click:events.click}'><span class='ic ic-tool-colorfill'><span class='selected-color-line' data-bind='style: {backgroundColor:properties.color.items.highlightColor.value}'></span></span><span class='ic ic-arrow'></span></div></span>",count:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-type='numeric' data-min='#:min#' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-bind='value: properties.general.items.count.value, events: {spin: events.change, change : events.change}, disabled: properties.general.items.count.disabled' required style='width:100%;'/></span></span>",building:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='name' data-value-field='id' data-bind='value:properties.misc.items.building.value, source: properties.misc.items.building.dataSource, events:{change:events.change}, disabled:properties.misc.items.building.disabled'/></span>",hasButton:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.button.items.hasButton.value, source: properties.button.items.hasButton.dataSource, events:{change:events.change}, disabled:properties.button.items.hasButton.disabled'/></span>",controlValue:"<span class='name block'>#:name#</span><span class='value'><span data-role='commonvalidator' data-type='hmiValueMinMax' data-min='#:min#' data-max='#:max#' data-required='true'><input data-role='numerictextbox' type='number' class='k-input spinner' min='#:min#' max='#:max#' data-format='\\#' data-bind='value: properties.text.items.controlValue.value, events: {spin: events.change, change : events.change}, disabled: properties.text.items.controlValue.disabled' required style='width:100%;'/></span></span>",projection:"<span class='name block'>#:name#</span><span class='value'><input data-role='dropdownlist' data-text-field='text' data-value-field='value' data-bind='value:properties.misc.items.projection.value, source: properties.misc.items.projection.dataSource, events:{change:events.change}, disabled:properties.misc.items.projection.disabled'/></span>"}[e];return i=i?(i=I.template(i))(t):""},e=r.extend({options:{name:"HmiBinding",dataSource:null},events:["change"],init:function(e,t){var a,i=this;r.fn.init.call(i,e,t),i.element.addClass("hmi-binding"),i.element.html("<div class='hmi-binding-inner-wrapper'><ul class='hmi-binding-tabs'><li data-type='device' data-bind='css:{active:state.tab.device, disabled:state.tab.deviceDisabled}, events:{click:events.clickTab}'>"+(a=Y.I18N).prop("COMMON_MENU_DEVICE")+"</li><li data-type='property' data-bind='css:{active:state.tab.property, disabled:state.tab.propertyDisabled}, events:{click:events.clickTab}'>"+a.prop("HMI_PROPERTY")+"</li></ul><div class='hmi-binding-device-wrapper' data-bind='visible:state.tab.device'><div class='hmi-binding-filter-wrapper' data-bind='visible:state.isFilterOpen, css:{active:filter.active}'><ul class='hmi-binding-filter'><li class='hmi-binding-filter-item title' data-type='title' data-bind='events:{click:events.clickFilterItem}'><span class='title'>"+a.prop("HMI_BINDING_FILTER")+"<span><span class='clear' data-bind='css:{disabled:state.isFilterClearDisabled}'>"+a.prop("HMI_BINDING_FILTER_CLEAR")+"</span></li><li class='hmi-binding-filter-item building' data-type='building' data-bind='css:{disabled:filter.building.disabled, active:filter.building.active}'><div class='title' data-bind='events:{click:events.clickFilterItem}'><span class='building'><span class='label'>"+a.prop("HMI_BUILDING")+"<span class='comma'>,&nbsp;</span></span><span class='name' data-bind='attr:{data-id:filter.building.id}, hmiBindingFilterSelectedType: filter.building.name'></span><span class='ic' data-bind='css:{active:filter.building.active}'></span></div><div class='list' style='display:none;'><table class='building-list'></table></div></li><li class='hmi-binding-filter-item floor' data-type='floor' data-bind='css:{disabled:filter.floor.disabled, active:filter.floor.active}'><div class='title' data-bind='events:{click:events.clickFilterItem}'><span class='floor'><span class='label'>"+a.prop("HMI_FLOOR")+"<span class='comma'>,&nbsp;</span></span><span class='name' data-bind='attr:{data-id:filter.floor.id}, hmiBindingFilterSelectedType: filter.floor.name'></span><span class='ic' data-bind='css:{active:filter.floor.active}'></span></div><div class='list' style='display:none;'><table class='floor-list'></table></div></li><li class='hmi-binding-filter-item zone' data-type='zone' data-bind='css:{disabled:filter.zone.disabled, active:filter.zone.active}'><div class='title' data-bind='events:{click:events.clickFilterItem}'><span class='zone'><span class='label'>"+a.prop("HMI_ZONE")+"<span class='comma'>,&nbsp;</span></span><span class='name' data-bind='attr:{data-id:filter.zone.id}, hmiBindingFilterSelectedType: filter.zone.name'></span><span class='ic' data-bind='css:{active:filter.zone.active}'></span></div><div class='list' style='display:none;'><table class='zone-list'></table></div></li><li class='hmi-binding-filter-item device' data-type='device' data-bind='css:{disabled:filter.device.disabled, active:filter.device.active}'><div class='title' data-bind='events:{click:events.clickFilterItem}'><span class='device-type'><span class='label'>"+a.prop("HMI_TYPE")+"<span class='comma'>,&nbsp;</span></span><span class='name' data-bind='attr:{data-id:filter.device.id}, hmiBindingFilterSelectedType: filter.device.name'></span><span class='ic' data-bind='css:{active:filter.device.active}'></span></div><div class='list' style='display:none;'><table class='device-type-list'></table></div></li></ul></div><div class='hmi-binding-search-wrapper'><button class='k-button filter' data-bind='css:{active:state.isApplyingFilter}, events:{click:events.clickFilterBtn}'>"+a.prop("HMI_BINDING_FILTER")+"</button><span class='search-field-wrapper' data-bind='css:{searching:state.isSearching}'><input type='text' class='k-input search-field' placeholder='"+a.prop("HMI_DEVNAME")+"' data-bind='events:{keyup:events.keyupSearch}'/><button class='ic ic-bt-input-search' data-bind='events:{click:events.clickSearchBtn}'></button></span></div><div class='hmi-binding-list-wrapper'><table class='hmi-binding-list'></table></div><div class='hmi-binding-device-info-wrapper'><div class='title'>"+a.prop("HMI_SELECT_DEVICE")+"</div><table class='hmi-binding-device-info' data-bind='css:{invalid:device.invalid}'><tr class='row title device-id'><td class='device-id-cell' colspan='2'>"+a.prop("HMI_DEVID")+"</td></tr><tr class='row content'><td class='device-id-cell' colspan='2' data-bind='text : device.id, attr:{title:device.id}'></td></tr><tr class='row title'><td>"+a.prop("HMI_DEVNAME")+"</td><td data-bind='hmiInvisibleIndoor:state.isIndoorType'>"+a.prop("HMI_DEVTAGNAME")+"</td></tr><tr class='row content'><td data-bind='text : device.name, attr:{title:device.name}'></td><td data-bind='text : device.tagName, attr:{title:device.tagName}, hmiInvisibleIndoor:state.isIndoorType'></td></tr><tr class='row title'><td>"+a.prop("HMI_DEVTYPE")+"</td><td data-bind='hmiInvisibleIndoor:state.isIndoorType'>"+a.prop("HMI_VALUE")+"</td></tr><tr class='row content'><td data-bind='text : device.displayType, attr:{title:device.displayType}'></td><td data-bind='text : device.displayValue, attr:{title:device.displayValue}, hmiInvisibleIndoor:state.isIndoorType'></td></tr></table></div></div><div class='hmi-binding-property-wrapper' data-bind='visible:state.tab.property'><div class='hmi-binding-property-inner-wrapper'></div></div></div>"),i._bindingViewModel(),i._getElementFromTemplate(),i._initFilterList(),i._initDeviceList(),i._initProperty();var n=Y.CommonLoadingPanel;i.loadingPanel=new n(i.element),i.filterLoadingPanel=new n(i.filterWrapper),i.colorPicker=b("<div class='hmi-binding-color-picker'/>").kendoCommonColorPicker({activeSelector:".binding-colorpicker-wrapper",hasTransparent:!0,opacity:!0}).data("kendoCommonColorPicker")},_bindingViewModel:function(){var e=this,t=Y.I18N;e.viewModel={filter:{init:e._initFilter.bind(e),active:!1,building:{init:e._initFilter.bind(e,"building"),id:C,name:t.prop("HMI_ALL"),disabled:!1,active:!1},floor:{init:e._initFilter.bind(e,"floor"),id:C,name:t.prop("HMI_ALL"),disabled:!0,active:!1},zone:{init:e._initFilter.bind(e,"zone"),id:C,name:t.prop("HMI_ALL"),disabled:!0,active:!1},device:{init:e._initFilter.bind(e,"device"),id:null,name:t.prop("HMI_ALL"),disabled:!1,active:!1}},device:{id:null,name:null,type:null,displayType:null,mappedType:null,displayDetailType:null,value:null,displayValue:null,isApplyingFilter:!1},state:{tab:{device:!0,deviceDisabled:!1,property:!1,propertyDisabled:!1},isSearching:!1,isFilterOpen:!1,isFilterClearDisabled:!0,isSaveBtnDisabled:!0,isIndoorType:!1},events:{clickTab:e._clickTab.bind(e),clickSaveBtn:e._clickSaveBtn.bind(e),clickFilterBtn:e._clickFilterBtn.bind(e),clickFilterItem:e._clickFilterItem.bind(e),keyupSearch:e._keyupSearch.bind(e),clickSearchBtn:e._clickSearchBtn.bind(e)}},e.viewModel=I.observable(e.viewModel),I.bind(e.element,e.viewModel),e.viewModel.bind("change",e._viewModelChangeEvt.bind(e))},_isApplyFilter:function(){var e=this.viewModel.filter,t=e.building,a=e.floor,i=e.zone,n=e.device.id;return n=n.split(","),t.id!=C||a.id!=C||i.id!=C||1==n.length},_viewModelChangeEvt:function(e){var t=this.viewModel,a=t.filter,i=e.field;if(i)if(-1!=i.indexOf(".active")){var n=a.building.active||a.floor.active||a.zone.active||a.device.active;a.set("active",n)}else-1!=i.indexOf(".id")&&t.state.set("isApplyingFilter",this._isApplyFilter())},_getElementFromTemplate:function(){var e=this,t=e.element;e.tabs=t.find(".hmi-binding-tabs"),e.deviceWrapper=t.find(".hmi-binding-device-wrapper"),e.filterWrapper=t.find(".hmi-binding-filter-wrapper"),e.filterEl=e.filterWrapper.find(".hmi-binding-filter"),e.searchFieldWrapper=t.find(".search-field-wrapper"),e.searchField=e.searchFieldWrapper.find(".k-input.search-field"),e.searchBtn=e.searchFieldWrapper.find(".ic-bt-input-search"),e.propertyWrapper=t.find(".hmi-binding-property-wrapper"),e.propertyInnerWrapper=e.propertyWrapper.find(".hmi-binding-property-inner-wrapper")},_initFilter:function(e,t){var a=this,i=Y.I18N,n=a.viewModel,r=n.filter,l=n.state;if(r[e]){var s,d,o=!0;if(s=i.prop("HMI_ALL"),"device"==e){d=null;var p=a.deviceTypeGrid.dataSource.data();p[0]&&(d=p[0].id)}else d=C;"building"!=e&&"device"!=e||(o=!1),r[e].set("id",d),r[e].set("name",s),r[e].set("active",!1),r[e].set("disabled",o)}else{r.device.init(),r.zone.init(),r.floor.init(),r.building.init(),a.deviceTypeGrid.clearSelection();var c=a.deviceTypeGrid.dataSource.get(r.device.id);c&&c.set("selected",!0),l.set("isFilterClearDisabled",!0),a._updateFilterList("building").always(function(){a._selectBuildingFilter({item:{id:C}}).always(function(){})})}},_clickFilterBtn:function(e){var t=this,a=(b(e.target),!t.filterWrapper.is(":visible"));t.viewModel.state.set("isFilterOpen",a),t._onClickOutOfFilterBox||(t._onClickOutOfFilterBox=t._closeFilterBox.bind(t));var i=b("#main");i.off("click",t._onClickOutOfFilterBox),a&&i.on("click",t._onClickOutOfFilterBox)},_closeFilterBox:function(e){var t=b(e.target),a=t.closest(".hmi-binding-filter-wrapper"),i=t.closest(".k-button.filter");a.length<1&&i.length<1&&(this.viewModel.state.set("isFilterOpen",!1),b("#main").off("click",this._onClickOutOfFilterBox))},_clickFilterItem:function(e){var t=this,n=t.viewModel.filter,a=b(e.target).closest(".hmi-binding-filter-item"),r=a.data("type"),i=n[r];if(i){if(i.get("disabled"))return!1;if(i.get("active"))return a.find(".list").slideUp(200),i.set("active",!1),!1;t.filterEl.find(".hmi-binding-filter-item:not(.title)").each(function(e,t){var a=(t=b(t)).data("type");if(a!=r){b(t).find(".list").slideUp();var i=n[a];i&&i.set("active",!1)}});var l=a.find(".list"),s=b("body").outerHeight(),d=t.filterWrapper.offset(),o=a.outerHeight(),p=t.filterEl.find(".hmi-binding-filter-item").length,c=s-d.top-o*p-13;t._updateFilterList(r).always(function(){l.css("height",c),l.slideDown(200),i.set("active",!0)})}else t.filterEl.find(".hmi-binding-filter-item:not(.title)").each(function(e,t){var a=(t=b(t)).data("type"),i=b(t).find(".list");"device"!=a&&i.find("table[data-role='grid']").data("kendoGrid").setDataSource(new I.data.DataSource({data:[]}));i.slideUp()}),n.init()},_updateFilterList:function(i){var n=this,e=n.viewModel.filter,r=new b.Deferred;n.filterLoadingPanel.open();var l,t,a,s,d,o,p,c,u,v,m=e.building.id,h=e.floor.id,g=e.zone.id,f=e.device.id;return"building"==i?(v=Y.I18N,t=b.ajax({url:"/foundation/space/buildings"}).then(function(e){return e.sort(function(e,t){return e.sortOrder-t.sortOrder}),e.unshift({id:C,name:v.prop("HMI_ALL")}),e}),l=m):"floor"==i?(p=m,c=Y.I18N,u={foundation_space_buildings_id:p},t=b.ajax({url:"/foundation/space/floors",data:u}).then(function(e){var t=Y.Util;e.sort(function(e,t){return e.sortOrder-t.sortOrder});var a,i=e.length;for(a=0;a<i;a++)e[a].name=t.getFloorName(e[a]);return e.unshift({id:C,name:c.prop("HMI_ALL")}),e}),l=h):"zone"==i&&null!=h?(a=m,s=h,d=Y.I18N,(o={foundation_space_buildings_id:a,foundation_space_floors_id:s}).foundation_space_floors_id==C&&delete o.foundation_space_floors_id,t=b.ajax({url:"/foundation/space/zones",data:o}).then(function(e){return e.sort(function(e,t){return e.sortOrder-t.sortOrder}),e.unshift({id:0,name:d.prop("FACILITY_DEVICE_FILTER_SELECT_EMPTY_ZONE")}),e.unshift({id:C,name:d.prop("HMI_ALL")}),e}),l=g):"device"==i&&(n.filterLoadingPanel.close(),l=f,r.resolve(l)),t&&t.done(function(e){var t=n.filterEl.find(".hmi-binding-filter-item[data-type='"+i+"'] table[data-role='grid']").data("kendoGrid");t.setDataSource(new I.data.DataSource({data:e}));var a=t.dataSource.get(l);a&&a.set("selected",!0),n.filterLoadingPanel.close(),r.resolve()}),r.promise()},_clickTab:function(e){var t=b(e.target);if(t.hasClass("disabled")||t.hasClass("active"))return!1;var a=t.data("type"),i=this.viewModel.state.tab;"device"==a?i.set("property",!1):i.set("device",!1),i.set(a,!0),"device"==a&&this.deviceGrid&&this.deviceGrid.dataSource.fetch()},_keyupSearch:function(e){var t=this.viewModel.state;e.keyCode&&e.keyCode==I.keys.ENTER?this.search():t.get("isSearching")&&t.set("isSearching",!1)},_clickSearchBtn:function(e){this.viewModel.state.isSearching&&this.searchField.val(""),this.search()},search:function(){var e=this,t=e.viewModel,a=t.state,i=t.filter,n=e.deviceGrid,r=(n.dataSource,e.searchField.val());e._highlighSearchResult||(e._highlighSearchResult=e.highlighSearchResult.bind(e)),n.unbind("dataBound",e._highlighSearchResult),r?(a.set("isSearching",!0),n.bind("dataBound",e._highlighSearchResult)):a.set("isSearching",!1),e._selectDeviceTypeFilter({item:i.device})},highlighSearchResult:function(){var e=this.searchField.val();if(e){var t,a,i,n=this.deviceGrid.items(),r=n.length,l=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");for(i=0;i<r;i++)t=(t=(a=(a=b(n[i])).find("td")).html()).replace(l,s),a.html(t)}},_initFilterList:function(){var e=this,t=e.element;e.bindingFilter=t.find(".hmi-binding-filter");var a=b.extend(!0,{},i,{columns:[{field:"name",template:function(e){return"<div class='hmi-filter-name-wrapper'>"+e.name+"</div>"}}]});e.buildingGridEl=e.bindingFilter.find(".hmi-binding-filter-item[data-type='building'] .list > table"),e.buildingGrid=e.buildingGridEl.kendoGrid(a).data("kendoGrid"),e.buildingGrid.bind("change",e._selectBuildingFilter.bind(e)),e.floorGridEl=e.bindingFilter.find(".hmi-binding-filter-item[data-type='floor'] .list > table"),e.floorGrid=e.floorGridEl.kendoGrid(a).data("kendoGrid"),e.floorGrid.bind("change",e._selectFloorFilter.bind(e)),e.zoneGridEl=e.bindingFilter.find(".hmi-binding-filter-item[data-type='zone'] .list > table"),e.zoneGrid=e.zoneGridEl.kendoGrid(a).data("kendoGrid"),e.zoneGrid.bind("change",e._selectZoneFilter.bind(e)),a.dataSource=k([{id:"ControlPoint.AI"},{id:"ControlPoint.AO"},{id:"ControlPoint.DI"},{id:"ControlPoint.DO"},{id:"Sensor.Temperature"},{id:"Sensor.Humidity"}]),a.columns=[{field:"name",template:function(e){var t=Y.Util;return"<div class='hmi-filter-name-wrapper'>"+(-1!=e.id.indexOf("AirConditioner")?e.name:1<e.id.split(",").length?e.name:t.getDetailDisplayTypeDeviceI18N(e.id))+"</div>"}}],e.deviceTypeGridEl=e.bindingFilter.find(".hmi-binding-filter-item[data-type='device'] .list > table"),e.deviceTypeGrid=e.deviceTypeGridEl.kendoGrid(a).data("kendoGrid"),e.deviceTypeGrid.bind("change",e._selectDeviceTypeFilter.bind(e))},_initDeviceList:function(){var e=this,t=e.element,a=b.extend(!0,{},i,{columns:[{field:"name",template:function(e){return"<div class='device-name' title='"+e.name+"'>"+e.name+"</div>"}}],scrollable:{virtual:!0}});e.deviceGridEl=t.find("table.hmi-binding-list"),e.deviceGrid=e.deviceGridEl.kendoGrid(a).data("kendoGrid"),e.deviceGrid.bind("change",e._selectDevice.bind(e))},_selectBuildingFilter:function(e){var t=this.viewModel,a=t.filter,i=a.building,n=a.floor,r=a.zone,l=t.state,s=e.item,d=i.id;if(i.set("id",s.id),s.name)i.set("name",s.name);else{var o=this.buildingGrid.dataSource.get(s.id);o&&i.set("name",o.name)}if(l.set("isFilterClearDisabled",!1),d!=s.id&&(n.init(),r.init(),s.id&&s.id!=C&&n.set("disabled",!1)),!e.skipTrigger)return this._selectDeviceTypeFilter({item:a.device})},_selectFloorFilter:function(e){var t=this.viewModel,a=t.filter,i=a.floor,n=a.zone,r=t.state,l=e.item,s=i.id;if(i.set("id",l.id),l.name)i.set("name",l.name);else{var d=this.floorGrid.dataSource.get(l.id);d&&i.set("name",d.name)}if(r.set("isFilterClearDisabled",!1),s!=l.id&&(n.init(),l.id&&l.id!=C&&n.set("disabled",!1)),!e.skipTrigger)return this._selectDeviceTypeFilter({item:a.device})},_selectZoneFilter:function(e){var t=this.viewModel,a=t.filter,i=a.zone,n=t.state,r=e.item;if(i.set("id",r.id),void 0!==r.name&&null!==r.name)i.set("name",r.name);else{var l=this.zoneGrid.dataSource.get(r.id);l&&i.set("name",l.name)}if(n.set("isFilterClearDisabled",!1),!e.skipTrigger)return this._selectDeviceTypeFilter({item:a.device})},_selectDeviceTypeFilter:function(e){var a,i,n=this,r=n.viewModel,t=r.filter,l=r.state,s=t.building,d=t.floor,o=t.zone,p=t.device,c=e.item,u=new b.Deferred;if(c&&c.id){p.set("id",c.id),c.name?p.set("name",c.name):(a=n.floorGrid.dataSource,(i=a.get(c.id))&&p.set("name",i.name)),n.filterLoadingPanel.open(),n.loadingPanel.open();var v="";l.isSearching&&(v=n.searchField.val()),function(e,t,a,i,n){var s=new b.Deferred,r={registrationStatuses:"Registered",foundation_space_buildings_id:null,foundation_space_floors_id:null,foundation_space_zones_ids:null,types:null,contains:null,containsAttributes:null};for(var l in i&&(-1!=i.indexOf("ControlPoint")?(r.types=i,r.mappedTypes="ControlPoint"):"AI"==i||"AO"==i||"DI"==i||"DO"==i?(r.types="ControlPoint."+i,r.mappedTypes="ControlPoint"):-1!=i.indexOf("AirConditioner")&&1<i.split(",").length?r.types="AirConditioner.*":r.types=i),e==C?delete r.foundation_space_buildings_id:r.foundation_space_buildings_id=e,t==C?delete r.foundation_space_floors_id:(delete r.foundation_space_buildings_id,r.foundation_space_floors_id=t),a==C?delete r.foundation_space_zones_ids:j(a)&&(delete r.foundation_space_buildings_id,0!=a&&delete r.foundation_space_floors_id,r.foundation_space_zones_ids=a),n&&(r.contains=n,r.containsAttributes="name"),r)null===r[l]&&delete r[l];var d=[],o=[],p=[];return d.push(b.ajax({url:"/dms/devices",data:r}).done(function(e){o=e})),-1!=Y.HmiCommon.hasMappedTypes.indexOf(r.types)&&(r.mappedTypes=r.types,r.types="ControlPoint.*",d.push(b.ajax({url:"dms/devices",data:r}).done(function(e){p=e}))),b.when.apply(this,d).always(function(){var e,t,a,i,n,r,l=!1;for(a=o.length,i=p.length,e=0;e<i;e++){for(r=p[e],l=!1,t=0;t<a;t++)if(n=o[t],r.id==n.id){l=!0;break}l||o.push(r)}s.resolve(o)}),s.promise()}(s.id,d.id,o.id,p.id,v).done(function(e){n.deviceGrid.setDataSource(new I.data.DataSource({data:e}));var t=r.device;t.id&&(a=n.deviceGrid.dataSource,(i=a.get(t.id))&&i.set("selected",!0)),n.filterLoadingPanel.close(),n.loadingPanel.close(),u.resolve()})}else u.reject();return u.promise()},_selectDevice:function(e){var t=this,a=t.viewModel.device,i=e.item,n=Y.Util,r=Y.HmiUtil;if(null===e.item)a.set("id",null),a.set("name",null),a.set("tagName",null),a.set("type",null),a.set("mappedType",null),a.set("displayType",null),a.set("displayDetailType",null),a.set("value",null),a.set("displayValue",null);else if(e.item){a.set("id",i.id),a.set("name",i.name),a.set("invalid",r.isInvalidDevice(e.item));var l=r.getDeviceInfo(i,i.type);if(a.set("type",i.type),a.set("tagName",l.tagName),a.set("mappedType",i.mappedType),a.set("displayType",l.typeText),a.set("displayDetailType",l.displayType),-1!=i.type.indexOf("AirConditioner")?(a.set("value",null),a.set("displayValue","-"),a.set("airConditioner",i.airConditioner),a.set("temperatures",i.temperatures),a.set("operations",i.operations),a.set("modes",i.modes),a.set("configuration",i.configuration),a.set("winds",i.winds),a.set("alarms",i.alarms),a.set("representativeStatus",i.representativeStatus)):(a.set("value",l.value),a.set("displayValue",n.convertNumberFormat(l.value))),a.id){t.deviceGrid.clearSelection();var s=t.deviceGrid.dataSource.get(a.id);s&&s.set("selected",!0)}}var d=t._bindingData;if(d){var o=t.propertyViewModel.properties,p=d.type,c=d.categoryName;if(r.hasControlValueGraphic(p)||"Animation"==p&&"Alarm"==c){var u=o.text;if(u){var v=u.items.value,m=u.items.controlValue;if(j(a.get("displayValue"))&&(v&&v.set("value",a.get("displayValue")),m&&m.set("value",a.get("displayValue"))),"ExtLabel"==c)if(a.id){var h=t.propertyInnerWrapper.find("li.property[data-key='controlValue'] [data-role='commonvalidator']").data("kendoCommonValidator");v&&v.set("disabled",!0),m&&m.set("disabled",!0),h&&h.hideMessages()}else v&&v.set("disabled",!1),m&&m.set("disabled",!1)}}if(r.isMultiBindingType(c)){var g=o.minMax,f=g.items.minValue,b=g.items.maxValue,_=t.propertyInnerWrapper.find("li.property[data-key='minValue'] [data-role='commonvalidator']").data("kendoCommonValidator"),y=t.propertyInnerWrapper.find("li.property[data-key='maxValue'] [data-role='commonvalidator']").data("kendoCommonValidator");_.hideMessages(),y.hideMessages();var x=o.general,I=o.color,k=x.items.reverse,C=I.items.graphicColor,T=I.items.graphicColorOn,S=I.items.graphicColorOff;a.id?"AI"==a.displayType||"AO"==a.displayType?(f.set("disabled",!1),b.set("disabled",!1),k.set("disabled",!0),k.set("value",!1),C.set("disabled",!1),T.set("disabled",!0),S.set("disabled",!0)):(f.set("disabled",!0),b.set("disabled",!0),k.set("disabled",!1),C.set("disabled",!0),T.set("disabled",!1),S.set("disabled",!1)):(k.set("disabled",!1),f.set("disabled",!1),b.set("disabled",!1),C.set("disabled",!1),T.set("disabled",!1),S.set("disabled",!1))}}t.validateForSaveBtn()},_initProperty:function(){var e=this,t=e.propertyInnerWrapper;t.on("click",".hmi-binding-property-category .category-title",e._propertyExpandEvt.bind(e)),t.on("keyup",".hmi-binding-property-category .category-items .property .k-input",e._propertyKeyUpEvt.bind(e)),t.on("click",".hmi-binding-property-category .category-items .property .ic-btn-remove-sm",e._propertyRemoveBtnClickEvt.bind(e)),t.on("click",".hmi-binding-property-category .category-items .property .binding-colorpicker-wrapper",e._propertyColorPickerBtnClickEvt.bind(e)),t.on("click",".hmi-binding-property-category .category-items .property .hmi-binding-option-values .add-btn",e._propertyOptionValuesAdd.bind(e)),t.on("click",".hmi-binding-property-category .category-items .property .hmi-binding-option-values .remove-btn",e._propertyOptionValuesRemove.bind(e))},_propertyOptionValuesAdd:function(e){var t=Y.I18N,a=Y.HmiCommon,i=this,n=i.propertyViewModel.properties.optionValues.items.optionValues,r=n.value;if(!(b(e.target).hasClass("disabled")||r.length>=a.MAX_OPTIONS_SIZE)){var l=r[r.length-1],s=l?Number(l.value)+1:0,d=X.bind(i,"change"),o={name:t.prop("HMI_ITEM")+" "+(r.length+1),text:"",value:s,change:d};r.push(o);var p,c=r.length,u=!1,v=!0;for(c>=a.MAX_OPTIONS_SIZE&&(u=!0),1<c&&(v=!1),p=0;p<c;p++)r[p].set("name",t.prop("HMI_ITEM")+" "+(p+1)),r[p].set("removeBtnDisabled",v);n.set("addBtnDisabled",u),i.validateForSaveBtn(),i.propertyInnerWrapper.scrollTop(i.propertyInnerWrapper.get(0).scrollHeight)}},_propertyOptionValuesRemove:function(e){var t=Y.I18N,a=Y.HmiCommon,i=this.propertyViewModel.properties.optionValues.items.optionValues,n=i.value,r=b(e.target);if(!r.hasClass("disabled")){var l=r.closest(".hmi-binding-option-value-item").index();n.splice(l,1);var s,d=n.length,o=!0,p=!1;for(d<a.MAX_OPTIONS_SIZE&&(o=!1),1==d&&(p=!0),s=0;s<d;s++)n[s].set("name",t.prop("HMI_ITEM")+" "+(s+1)),n[s].set("removeBtnDisabled",p);i.set("addBtnDisabled",o),this.validateForSaveBtn()}},_propertyColorPickerBtnClickEvt:function(e){var t=b(e.target).closest(".binding-colorpicker-wrapper");t.hasClass("active")?this.closeColorPicker(t):this.openColorPicker(t)},closeColorPicker:function(e,t){var a=this;e.removeClass("active"),a._isColorPickerOpen=!1,a._activeCanvas&&a._activeCanvas.createView&&a._activeCanvas.createView.setColorPickerOpenState(!1),t||a.colorPicker.close()},openColorPicker:function(e){var t,a=this,i=a.propertyViewModel.properties,n=e.data("valueField"),r=e.closest(".property"),l=r.data("category"),s=r.data("key"),d=null,o=i[l];o&&(t=o.items[s])&&(d=n?t.value[n]:t.value),a._isColorPickerOpen&&a.closeColorPicker(e),a.colorPicker.unbind("change"),a.colorPicker.value(d),a.colorPicker.bind("change",a._changeColorPickerEvt.bind(a,o,t,n)),a.colorPicker.bind("close",a.closeColorPicker.bind(a,e,!0)),e.addClass("active"),a._isColorPickerOpen=!0,a.colorPicker.open(),a._activeCanvas&&a._activeCanvas.createView&&a._activeCanvas.createView.setColorPickerOpenState(!0);var p=e.offset(),c=p.top,u=p.left,v=a.colorPicker.element,m=v.outerHeight(),h=v.outerWidth(),g=b("body").outerHeight();p.left=u-h-10,g<c+m&&(c=c-m-10),p.top=c,a.colorPicker.position(p)},_changeColorPickerEvt:function(e,t,a,i){var n="transparent"==i.value?"":i.value;a?t.value.set(a,n):t.set("value",n),this.validateForSaveBtn()},_propertyExpandEvt:function(e){var t=this,a=b(e.target),i=!a.closest(".category-title").find(".ic").hasClass("expand"),n=a.closest(".hmi-binding-property-category"),r=n.data("key"),l=n.find(".category-items");i?l.slideDown(200,function(){t.propertyViewModel.properties[r].set("expanded",!0)}):l.slideUp(200,function(){t.propertyViewModel.properties[r].set("expanded",!1)})},_propertyRemoveBtnClickEvt:function(e){var t,a=b(e.target),i=a.siblings(".k-numerictextbox");(t=0<i.length?((t=i.find("input[data-role='numerictextbox']")).val(""),i.find("input.k-formatted-value")):a.siblings(".k-input")).val(""),t.trigger("keyup",{target:e.target})},_propertyKeyUpEvt:function(e){var t,a=this,i=b(e.target),n=i.val();t="numerictextbox"==i.attr("data-role")?i.closest(".k-numerictextbox").siblings(".ic-btn-remove-sm"):i.siblings(".ic-btn-remove-sm"),n?t.show():t.hide();var r,l=i.closest("li.property"),s=l.data("key"),d=l.data("category"),o=a.propertyViewModel.properties[d];if(o&&(r=o.items[s])){var p="value";if("optionValues"==s){var c=i.closest(".hmi-binding-option-value-item").index();r=r.value[c];var u=i.closest("p.hmi-binding-option-value-item-value");p=0<u.length?"value":"text"}else"svgTextOn"==s?(r=r.value,p="textOn"):"svgTextOff"==s&&(r=r.value,p="textOff");var v=!0,m=i.closest("[data-role='commonvalidator']");0<m.length&&(v=(m=m.data("kendoCommonValidator")).validate()),a._keyupTimeout&&clearTimeout(a._keyupTimeout),r&&v&&(a._keyupTimeout=setTimeout(function(){r.set(p,n),a.validateForSaveBtn(),a._keyupTimeout=null},1e3))}},validateForSaveBtn:function(e){var t=this,s=(t.viewModel,t.propertyViewModel.properties);t.propertyInnerWrapper.find("[data-role='commonvalidator']").each(function(e,t){var a=b(t).data("kendoCommonValidator");a&&a.validate()});var d=0;t.propertyInnerWrapper.find(".k-invalid").each(function(e,t){var a=b(t).closest("li.property"),i=a.data("category"),n=a.data("key"),r=s[i],l=r.items[n];r.visible&&l.visible&&d++}),d<1&&t._clickSaveBtn()},_clickSaveBtn:function(e){var t,a,i,n,r,l=this.propertyViewModel.properties,s=this._allowedField,d=this.viewModel.device,o=l.toJSON(),p={};for(a in o)for(n in i=o[a].items)-1!=s.indexOf(n)&&(r=i[n]).visible&&(t=r.value,"optionValues"==n?t=g(t):"sourceMarker"!=n&&"targetMarker"!=n||(t=f(t)),-1!=v.indexOf(n)&&(t=Number(t)),p[n]=t);var c=d.toJSON();c.id&&(p.device=c),this.trigger("save",{item:p})},updateBindingData:function(e){var t,a,i,n,r,l=this.propertyViewModel.properties,s=l.toJSON();for(a in s)for(n in i=l[a].items,e)(r=i[n])&&(t=e[n],r.set("value",t))},setBindingData:function(e){var t,a,i,n=this,r=Y.HmiCommon,l=Y.Util,s=Y.I18N,d="Null"===e.categoryName?e.type:e.categoryName,o=r.ControlPointValueAndStateMapping[d],p=n.viewModel,c=[];if(o){var u,v=o.valueType;for(a=v.length,t=0;t<a;t++)for(i in u=v[t])c.push({id:u[i],name:l.getDetailDisplayTypeDeviceI18N(i)})}else"Custom"==e.type?c="Multi"==e.custom.type?k([{id:"ControlPoint.AI"},{id:"ControlPoint.AO"},{id:"Sensor.Temperature"},{id:"Sensor.Humidity"}]):k([{id:"ControlPoint.DI"},{id:"ControlPoint.DO"}]):"Indoor"==e.type?c=[{id:"AirConditioner.Indoor",name:"Indoor"},{id:"AirConditioner.AHU",name:"AHU"},{id:"AirConditioner.Chiller",name:"DVM Chiller"},{id:"AirConditioner.EHS",name:"EHS"},{id:"AirConditioner.ERV",name:"ERV"},{id:"AirConditioner.ERVPlus",name:"ERV Plus"},{id:"AirConditioner.FCU",name:"FCU"},{id:"AirConditioner.DuctFresh",name:"Fresh Duct"}]:e.deviceTypeText&&c.push({id:e.deviceTypeText,name:l.getDetailDisplayTypeDeviceI18N(e.deviceTypeText)});var m=[];for(a=c.length,t=0;t<a;t++)m.push(c[t].id);c.unshift({id:m.join(","),name:s.prop("HMI_ALL")}),n.deviceTypeGrid.setDataSource(new I.data.DataSource({data:c})),p.state.set("isIndoorType","Indoor"==e.type),n.updatePropertyTab(e);var h=(p=n.viewModel).filter,g=h.device,f=h.building,b=e.device;if(b.id?(p.set("device",b),n._selectDevice({item:b})):(n._selectDevice({item:null}),n.deviceGrid.clearSelection()),g.id){var _=!1;for(a=c.length,t=0;t<a;t++)if(c[t].id==g.id){_=!0;break}if(!_){if(g.id.split(",").length<=1)r.toastPopup.show(s.prop("HMI_NOT_SUPPORTED_DEVICE_TYPE"));g.init(),n.clearDevice(),g.set("id",c[0].id),g.set("name",c[0].name);var y=f.id?f.id:C;n._updateFilterList("building").always(function(){n._selectBuildingFilter({item:{id:y}}).always(function(){})})}}else g.set("id",c[0].id),g.set("name",c[0].name),n._updateFilterList("building").always(function(){n._selectBuildingFilter({item:{id:C}}).always(function(){})});var x=n.deviceTypeGrid.dataSource.get(g.id);x&&x.set("selected",!0)},clear:function(){this.clearDevice(),this.clearProperty()},clearDevice:function(){var e=this._bindingData;e&&e.device&&e.device.id||this._selectDevice({item:null}),this.deviceGrid.setDataSource(new I.data.DataSource({data:[]}))},clearProperty:function(){var e=this,t=e.propertyInnerWrapper;e.propertyViewModel&&(I.unbind(t,e.propertyViewModel),e.propertyViewModel.unbind("change")),e.unbind("property"),t.empty(),e._bindingData=null,e._allowedField=null},updatePropertyTab:function(e){var t=this,a=t.propertyInnerWrapper;t.clearProperty();var i=e.type,n=e.device;-1!=u.indexOf(i)?(t.viewModel.state.tab.set("deviceDisabled",!0),t._clickTab({target:t.tabs.find("li[data-type='property']")})):(t.viewModel.state.tab.set("deviceDisabled",!1),n.id?t._clickTab({target:t.tabs.find("li[data-type='property']")}):t._clickTab({target:t.tabs.find("li[data-type='device']")})),t._bindingData=e;var r=function(e,t){var a=Y.I18N,i=Y.HmiCommon,n=Y.HmiUtil,r=Y.MAIN_WINDOW,l=t.type,s=t.categoryName,d=t.device,o=[{text:a.prop("HMI_DISABLE"),value:!1},{text:a.prop("HMI_ENABLE"),value:!0}],p=[{text:a.prop("HMI_BLUE"),value:"blue"},{text:a.prop("HMI_GREEN"),value:"green"},{text:a.prop("HMI_RED"),value:"red"},{text:a.prop("HMI_YELLOW"),value:"yellow"}],c=[{id:0,text:a.prop("HMI_GENERAL"),value:"gray",disabled:!1},{id:1,text:a.prop("HMI_RED"),value:"red",disabled:!1},{id:2,text:a.prop("HMI_BLUE"),value:"blue",disabled:!1},{id:3,text:a.prop("HMI_YELLOW"),value:"yellow",disabled:!1},{id:4,text:a.prop("HMI_GREEN"),value:"green",disabled:!1},{id:5,text:a.prop("HMI_TRANSPARENT"),value:"transparent",disabled:!1}],u=[{text:a.prop("HMI_NOT_SET"),value:"WRITE"},{text:a.prop("HMI_SET"),value:"READ"}],v=[{text:a.prop("HMI_MINUTE"),value:i.CHART_MINUTES.ONE.value},{text:a.prop("HMI_5_MINUTES"),value:i.CHART_MINUTES.FIVE.value},{text:a.prop("HMI_10_MINUTES"),value:i.CHART_MINUTES.TEN.value},{text:a.prop("HMI_15_MINUTES"),value:i.CHART_MINUTES.FIFTEEN.value},{text:a.prop("HMI_30_MINUTES"),value:i.CHART_MINUTES.THIRTEEN.value}],m=[{text:a.prop("HMI_NO_TEXT"),value:"empty"},{text:a.prop("HMI_MIDDLE"),value:"middle"},{text:a.prop("HMI_TOP"),value:"top"},{text:a.prop("HMI_BOTTOM"),value:"bottom"},{text:a.prop("HMI_LEFT"),value:"left"},{text:a.prop("HMI_RIGHT"),value:"right"}],h="right";"ProgressBar"==t.type&&"vertical"!=t.direction&&(h="bottom");var g,f=[{text:a.prop("HMI_GAUGE_1"),value:1},{text:a.prop("HMI_GAUGE_2"),value:2},{text:a.prop("HMI_GAUGE_3"),value:3},{text:a.prop("HMI_GAUGE_4"),value:4},{text:a.prop("HMI_GAUGE_5"),value:5},{text:a.prop("HMI_GAUGE_6"),value:6},{text:a.prop("HMI_GAUGE_7"),value:7},{text:a.prop("HMI_GAUGE_8"),value:8},{text:a.prop("HMI_GAUGE_9"),value:9},{text:a.prop("HMI_GAUGE_10"),value:10}],b=r.getCurrentBuildingList(),_=[{text:a.prop("HMI_BUTTON_DISPLAY"),value:!0},{text:a.prop("HMI_BUTTON_HIDDEN"),value:!1}],y=[{text:a.prop("HMI_PROJECTION_PERSPECTIVE"),value:"Perspective"},{text:a.prop("HMI_PROJECTION_TOP"),value:"Top"},{text:a.prop("HMI_PROJECTION_FRONT"),value:"Front"}];g="ExtLabel"==l?null:"#000000";var x=!1,I=i.DEFAULT_MIN_VALUE,k=i.DEFAULT_MAX_VALUE,C=i.DEFAULT_MAX,T=i.DEFAULT_MIN,S=!1,w=!1;"ExtLabel"==l?w=j(d.value)?!(S=!0):!(S=!1):n.hasControlValueGraphic(l)&&(w=!(S=!0));var E=j(t.textLocation)?t.textLocation:"empty",O=!0;"Button"!=l&&"RectangleGraphic"!=l||"empty"!=E||(O=!1);var M,L,D,H,N,F,A=!1,B=!1,R=!1;n.isMultiBindingType(s)&&d.id&&(n.isDigitalType(d.type)?R=x=!0:B=A=!0),L="Line"==l?t.height<i.GRAPHIC_MIN_HEIGHT?(M=i.GRAPHIC_MIN_WIDTH,0):t.width<i.GRAPHIC_MIN_HEIGHT?(M=0,i.GRAPHIC_MIN_HEIGHT):M=0:(M=i.GRAPHIC_MIN_WIDTH,i.GRAPHIC_MIN_HEIGHT),D=i.DEFAULT_CANVAS_WIDTH-t.locationX,H=i.DEFAULT_CANVAS_HEIGHT-t.locationY,N=i.DEFAULT_CANVAS_WIDTH-t.width,F=i.DEFAULT_CANVAS_HEIGHT-t.height,t.locationX>N&&(t.locationX=N),t.locationY>F&&(t.locationY=F),t.width>D&&(t.width=D),t.height>H&&(t.height=H);var P,V=!1;j(t.optionValues)?V=(P=Q.call(e,t.optionValues)).length>=i.MAX_OPTIONS_SIZE:P=Q.call(e,[{text:"",value:0}]);var G=!!j(t.reverse)&&t.reverse;G="true"==G||!0===G;var W=j(t.strokeDasharray)?t.strokeDasharray:"0",U=j(t.sourceMarker)?t.sourceMarker.points:"0,0",q=j(t.targetMarker)?t.targetMarker.points:"0,0",z=j(t.strokeWidth)?t.strokeWidth:i.DEFAULT_TEXT_STROKE;return{properties:{button:{visible:!0,expanded:!0,name:a.prop("HMI_PROPERTY_HAS_BUTTON"),items:{hasButton:{visible:!0,disabled:!1,name:a.prop("HMI_BUTTON_DISPLAY"),value:!j(t.hasButton)||t.hasButton,dataSource:_},buttonType:{name:a.prop("HMI_BUTTON_TYPE"),visible:!0,disabled:!1,value:j(t.buttonType)?t.buttonType:"Push"}}},hyperLink:{visible:!0,expanded:!0,name:a.prop("HMI_HYPER_LINK"),items:{file:{name:a.prop("HMI_FILE"),visible:!0,value:j(t.file)?t.file:{id:0,name:"-"}}}},general:{visible:!0,expanded:!0,name:a.prop("COMMON_GENERAL"),items:{reverse:{visible:!0,disabled:A,name:a.prop("HMI_REVERSE"),value:G,dataSource:o},propertyType:{visible:!0,disabled:!1,name:a.prop("HMI_READ_ONLY"),value:j(t.propertyType)?t.propertyType:"WRITE",dataSource:u},timeRange:{visible:!0,disabled:!1,name:a.prop("HMI_TIME_RANGE"),value:j(t.timeRange)?t.timeRange:1e3,dataSource:v},opacity:{visible:!0,disabled:!1,name:a.prop("HMI_OPACITY"),value:j(t.opacity)?t.opacity:100},count:{visible:!0,disabled:!1,min:1,max:30,name:a.prop("HMI_CHART_COUNT"),value:j(t.count)?t.count:1}}},location:{visible:!0,expanded:!0,name:a.prop("HMI_LOCATION"),items:{x:{visible:!0,disabled:!1,name:a.prop("HMI_LOCATION_X"),max:N,value:j(t.locationX)?t.locationX:0},y:{visible:!0,disabled:!1,name:a.prop("HMI_LOCATION_Y"),max:F,value:j(t.locationY)?t.locationY:0}}},size:{visible:!0,expanded:!0,name:a.prop("HMI_SIZE"),items:{width:{visible:!0,disabled:!1,min:M,max:D,name:a.prop("HMI_SIZE_WIDTH"),value:j(t.width)?t.width:i.GRAPHIC_MIN_WIDTH},height:{visible:!0,disabled:!1,min:L,max:H,name:a.prop("HMI_SIZE_HEIGHT"),value:j(t.height)?t.height:i.GRAPHIC_MIN_HEIGHT}}},line:{visible:!0,expanded:!0,name:a.prop("HMI_LINE"),items:{strokeDasharray:{visible:!0,disabled:!1,name:a.prop("HMI_LINE_DASH"),value:W,dataSource:Z(i.lineDashArrayDataSource,W)},sourceMarker:{visible:!0,disabled:!1,name:a.prop("HMI_LINE_ARROW_START"),value:U,dataSource:Z(i.lineMarkerDataSource,U)},targetMarker:{visible:!0,disabled:!1,name:a.prop("HMI_LINE_ARROW_END"),value:q,dataSource:Z(i.lineMarkerDataSource,q)},strokeWidth:{visible:!0,disabled:!1,name:a.prop("HMI_TOOLBAR_LINE_WIDTH"),value:j(t.strokeWidth)?t.strokeWidth:i.DEFAULT_TEXT_STROKE,dataSource:Z(i.lineWidthDataSource,z)}}},color:{visible:!0,expanded:!0,name:a.prop("HMI_CATEGORY_COLOR"),items:{fillColor:{visible:!0,disabled:!1,name:a.prop("HMI_FILL_COLOR"),value:j(t.fillColor)?t.fillColor:g},highlightColor:{visible:!0,disabled:!1,name:a.prop("HMI_HIGHLIGHT_COLOR"),value:j(t.highlightColor)?t.highlightColor:null},strokeColor:{visible:!0,disabled:!1,name:a.prop("HMI_TOOLBAR_LINE_COLOR"),value:j(t.strokeColor)?t.strokeColor:null},dataColor:{visible:!0,disabled:!1,name:a.prop("HMI_COLOR"),value:j(t.dataColor)?t.dataColor:"#0000FF"},buttonColor:{visible:!0,disabled:!1,name:a.prop("HMI_COLOR"),value:j(t.buttonColor)?t.buttonColor:"blue",dataSource:p},svgGraphicColorOn:{visible:!0,disabled:!1,name:a.prop("HMI_COLOR_ON"),value:j(t.svgGraphicColorOn)?t.svgGraphicColorOn:i.COLOR_STR_TO_HEX.red},svgGraphicColorOff:{visible:!0,disabled:!1,name:a.prop("HMI_COLOR_OFF"),value:j(t.svgGraphicColorOff)?t.svgGraphicColorOff:i.COLOR_STR_TO_HEX.gray},graphicColor:{visible:!0,disabled:R,name:a.prop("HMI_COLOR"),value:j(t.graphicColor)?t.graphicColor:"gray",dataSource:c},graphicColorOn:{visible:!0,disabled:B,name:a.prop("HMI_COLOR_ON"),value:j(t.graphicColorOn)?t.graphicColorOn:"red",dataSource:c},graphicColorOff:{visible:!0,disabled:B,name:a.prop("HMI_COLOR_OFF"),value:j(t.graphicColorOff)?t.graphicColorOff:"gray",dataSource:c}}},font:{visible:O,expanded:!0,name:a.prop("HMI_FONT"),items:{fontSize:{visible:!0,disabled:!1,name:a.prop("HMI_FONT_SIZE"),value:j(t.fontSize)?t.fontSize:16},fontColor:{visible:!0,disabled:!1,name:a.prop("HMI_FONT_COLOR"),value:j(t.fontColor)?t.fontColor:"#000000"},fontType:{visible:!0,disabled:!1,name:a.prop("HMI_FONT_TYPE"),value:j(t.fontType)?t.fontType:"Arial",dataSource:i.fontTypeDataSource},fontStyle:{visible:!0,disabled:!1,name:a.prop("HMI_FONT_STYLE"),value:j(t.fontStyle)?t.fontStyle:"Normal",dataSource:i.fontStyleDataSource}}},text:{visible:!0,expanded:!0,name:a.prop("HMI_TEXT_VALUE"),items:{label:{visible:!0,disabled:!1,name:a.prop("HMI_LABEL"),value:j(t.label)?t.label:""},value:{visible:!0,disabled:S,required:w,name:a.prop("HMI_VALUE"),value:j(t.value)?t.value:null},controlValue:{visible:!0,disabled:S,required:w,min:I,max:k,name:a.prop("HMI_VALUE"),value:j(t.value)?t.value:null},unit:{visible:!0,disabled:!1,name:a.prop("HMI_UNIT"),value:j(t.unit)?t.unit:null},prefix:{visible:!0,disabled:!1,name:a.prop("HMI_PREFIX"),value:j(t.prefix)?t.prefix:""},suffix:{visible:!0,disabled:!1,name:a.prop("HMI_SUFFIX"),value:j(t.suffix)?t.suffix:""},gauge:{name:a.prop("HMI_GUAGE_VALUE"),visible:!0,disabled:!1,value:j(t.gauge)?t.gauge:1,dataSource:f},checkboxLabel:{visible:!0,disabled:!1,name:a.prop("HMI_LABEL"),value:j(t.checkboxLabel)?t.checkboxLabel:""},svgTextOn:{visible:O,disabled:!1,name:a.prop("HMI_TEXT_ON"),value:{svgTextColorOn:j(t.svgTextColorOn)?t.svgTextColorOn:"#ffffff",textOn:j(t.textOn)?t.textOn:""}},svgTextOff:{visible:O,disabled:!1,name:a.prop("HMI_TEXT_OFF"),value:{svgTextColorOff:j(t.svgTextColorOff)?t.svgTextColorOff:"#000000",textOff:j(t.textOff)?t.textOff:""}},progressTextLocation:{visible:!0,disabled:!1,name:a.prop("HMI_TEXT_LOCATION"),value:j(t.progressTextLocation)?t.progressTextLocation:h,dataSource:m},textLocation:{visible:!0,disable:!1,name:a.prop("HMI_TEXT_LOCATION"),value:E,dataSource:m}}},optionValues:{visible:!0,expanded:!0,name:a.prop("HMI_ITEM_PROPERTY"),items:{optionValues:{visible:!0,disabled:!1,addBtnDisabled:V,name:a.prop("HMI_ITEM"),value:P}}},minMax:{visible:!0,expanded:!0,name:a.prop("HMI_MIN_MAX_VALUE"),items:{minValue:{visible:!0,disabled:x,name:a.prop("HMI_MINIMUM_VALUE"),value:j(t.minValue)?t.minValue:T,min:I,max:k},maxValue:{visible:!0,disabled:x,name:a.prop("HMI_MAXIMUM_VALUE"),value:j(t.minValue)?t.maxValue:C,min:I,max:k}}},misc:{visible:!0,expanded:!0,name:a.prop("HMI_ELEMENT_MISC"),items:{projection:{visible:!0,disabled:!1,name:a.prop("HMI_ICON_TYPE"),value:j(t.projection)?t.projection:"Perspective",dataSource:y},building:{visible:!0,disabled:!1,name:a.prop("HMI_BUILDING"),value:j(t.building)?t.building:{id:0,name:""},dataSource:b}}}},events:{validate:X.bind(e,"validate"),change:X.bind(e,"change"),click:X.bind(e,"click"),open:X.bind(e,"open"),select:X.bind(e,"select"),dataBound:X.bind(e,"dataBound")}}}(t,e),l=function(e){var t,a=e.type,i=e.categoryName,n={Group:["x","y","width","height"],Indoor:["projection","x","y"],Custom:["buttonType","x","y","width","height","reverse"],Zone:["x","y","width","height","strokeDasharray"],Statistics:["x","y","width","height","strokeDasharray","building"],BasicShape:["x","y","width","height","strokeDasharray"],Line:["x","y","width","height","strokeDasharray","sourceMarker","targetMarker"],Table:["x","y","width","height","strokeDasharray"],Label:["x","y","width","height","strokeDasharray"],HyperLink:["x","y","width","height","file","label","strokeDasharray"],Button:["buttonType","textLocation","reverse","graphicColorOff","graphicColorOn","svgTextOff","svgTextOn","state","x","y","width","height"],ProgressBar:["x","y","width","height","maxValue","minValue","textLocation","prefix","suffix","highlightColor","strokeDasharray"],ScaleBar:["propertyType","prefix","suffix","x","y","width","height","minValue","maxValue","textLocation","highlightColor","strokeDasharray"],ToggleButton:["propertyType","reverse","checkboxLabel","x","y","width","height","strokeDasharray","highlightColor"],Combobox:["propertyType","x","y","width","height","strokeDasharray","highlightColor","optionValues"],ExtLabel:["propertyType","hasButton","x","y","width","height","strokeDasharray","highlightColor","minValue","maxValue"],RadioButton:["propertyType","x","y","width","height","strokeDasharray","highlightColor","optionValues"],Animation:["state","gauge","reverse","fontSize","graphicColorOff","svgTextOff","graphicColorOn","svgTextOn","x","y","width","height","maxValue","minValue"],ImportImage:["x","y","width","height","strokeDasharray"],Image:["x","y","width","height","reverse","graphicColorOn","graphicColorOff"],Chart:["x","y","width","height","highlightColor","timeRange","count","maxValue","minValue","strokeDasharray"],RectangleGraphic:["buttonType","textLocation","reverse","x","y","width","height","svgGraphicColorOff","svgTextOff","svgGraphicColorOn","svgTextOn","strokeDasharray"]}[a],r=Y.HmiUtil;if(h(n,"graphicColor"),h(n,"graphicColorOn"),h(n,"graphicColorOff"),"Animation"==a)"Toggle"!=i&&"Selector"!=i&&"Exhaust"!=i&&"Generator"!=i&&"Wind"!=i&&"CoolingTower"!=i&&"Steam"!=i&&"LED"!=i&&"Blower"!=i&&"DIP"!=i&&"Coil"!=i&&"Pumps"!=i&&"Button"!=i&&h(n,"reverse"),h(n,"gauge"),h(n,"value"),h(n,"minValue"),h(n,"maxValue"),h(n,"svgTextOff"),h(n,"svgTextOn"),h(n,"fontSize"),r.isMultiBindingType(i)?(h(n,"state"),n.push("minValue"),n.push("maxValue"),n.push("reverse"),"Alarm"!=i&&(n.push("graphicColorOn"),n.push("graphicColorOff"),n.push("graphicColor"))):"Gauge"==i?(h(n,"state"),n.push("gauge"),n.push("minValue"),n.push("maxValue")):"Steam"!=i&&"Wind"!=i&&("AI"==(t=r.getGraphicCatergoryPointType(i))?(n.push("graphicColor"),r.isMultiLevelGraphic(i)&&(n.push("minValue"),n.push("maxValue"))):"DI"==t&&(n.push("reverse"),n.push("graphicColorOn"),n.push("graphicColorOff")));else if("Button"==a)n.push("graphicColorOn"),n.push("graphicColorOff"),n.push("svgTextOff"),n.push("svgTextOn"),"Button"!=i&&h(n,"buttonType");else if("ProgressBar"==a||"ScaleBar"==a)"vertical"!=e.direction&&"ScaleBar"==a&&(h(n,"progressTextLocation"),h(n,"fontSize"),h(n,"fontStyle"),h(n,"fontType"));else if("Image"==a)"basicImage"==i?h(n,"reverse"):(n.push("reverse"),n.push("graphicColorOn"),n.push("graphicColorOff"));else if("Statistics"==a)"Building"!=i&&h(n,"building");else if("Custom"==a){var l=e.custom.type;"Multi"==l?(h(n,"buttonType"),h(n,"reverse")):"Toggle"==l&&h(n,"buttonType")}return n}(e);t._allowedField=l;var s,d,o=r.properties,p="";for(s in o)d=o[s],p+=m(s,d,l);if(a.html(p),t.propertyViewModel){o=t.propertyViewModel.properties.toJSON();var c=r.properties;for(s in o)d=o[s],c[s].expanded=d.expanded;t.propertyViewModel=b.extend(!0,{},r,t.propertyViewModel)}t.propertyViewModel=I.observable(r),I.bind(a,t.propertyViewModel),t.propertyViewModel.bind("change",t._changePropertyViewModelEvt.bind(t)),t.unbind("property"),t.bind("property",t._propertyEvt.bind(t))},_changePropertyViewModelEvt:function(e){},_propertyEvt:function(e){var t,a,i,n,r,l=this,s=e.type,d=e.event,o=e.category,p=e.field,c=l.propertyViewModel.properties,u=c[o].items[p],v=e.sender,m=l._bindingData,h=Y.HmiCommon;if("textLocation"==p){if("change"==s&&v){t=u.value;var g=c.text.items.svgTextOn,f="empty"!=t;c.text.items.svgTextOff.set("visible",f),g.set("visible",f),c.font.set("visible",f)}}else if("graphicColorOn"!=p&&"graphicColorOff"!=p)if("fontSize"==p||"x"==p||"y"==p||"width"==p||"height"==p||"minValue"==p||"maxValue"==p||"count"==p||"optionValues"==p){if("validate"==s){var b=(a=(v=d.sender).element).find(".k-formatted-value");d.valid?(b.removeClass("k-invalid"),b.addClass("k-valid")):(b.removeClass("k-valid"),b.addClass("k-invalid"))}else if("change"==s){if((a=(v=d.sender).element).closest("[data-role='commonvalidator']").data("kendoCommonValidator").validate())if("optionValues"==p){var _,y=a.closest(".hmi-binding-option-value-item").index();_=0<a.closest("p.hmi-binding-option-value-item-value").length?"value":"text";var x=u.value[y];x&&x.set(_,v.value())}else u.set("value",v.value())}if("width"==p||"height"==p||"x"==p||"y"==p){var I,k,C,T,S=l.propertyInnerWrapper,w=S.find("li.property[data-key='width'][data-category='size']"),E=S.find("li.property[data-key='height'][data-category='size']"),O=S.find("li.property[data-key='x'][data-category='location']"),M=S.find("li.property[data-key='y'][data-category='location']"),L=".value [data-role='commonvalidator']",D=".value [data-role='numerictextbox']",H=w.find(L).data("kendoCommonValidator"),N=E.find(L).data("kendoCommonValidator"),F=w.find(D).data("kendoNumericTextBox"),A=E.find(D).data("kendoNumericTextBox"),B=O.find(L).data("kendoCommonValidator"),R=M.find(L).data("kendoCommonValidator"),P=O.find(D).data("kendoNumericTextBox"),V=M.find(D).data("kendoNumericTextBox");t=u.get("value"),a=(v=d.sender).element,"width"==p?("Line"==m.type&&(t<h.GRAPHIC_MIN_WIDTH?(N.setOptions({min:h.GRAPHIC_MIN_HEIGHT}),A.min(h.GRAPHIC_MIN_HEIGHT)):(N.setOptions({min:0}),A.min(0))),C=h.DEFAULT_CANVAS_WIDTH-t,P&&P.max(C),B&&(B.setOptions({max:C}),B.validate(null,null,!0))):"height"==p?("Line"==m.type&&(t<h.GRAPHIC_MIN_HEIGHT?(H.setOptions({min:h.GRAPHIC_MIN_HEIGHT}),F.min(h.GRAPHIC_MIN_HEIGHT)):(H.setOptions({min:0}),F.min(0))),T=h.DEFAULT_CANVAS_HEIGHT-t,V&&V.max(T),R&&(R.setOptions({max:T}),R.validate(null,null,!0))):"x"==p?(I=h.DEFAULT_CANVAS_WIDTH-t,F&&F.max(I),H&&(H.setOptions({max:I}),H.validate(null,null,!0))):"y"==p&&(k=h.DEFAULT_CANVAS_HEIGHT-t,A&&A.max(k),N&&(N.setOptions({max:k}),N.validate(null,null,!0)))}}else if(-1!=U.indexOf(p)){if("change"==s){var G=(v=d.sender).dataItem();for(r=(i=v.dataSource.data()).length,n=0;n<r;n++)i[n]===G?i[n].set("selected",!0):i[n].set("selected",!1)}}else if("file"==p&&"click"==s){var W=Y.HmiPopupConfig.hyperLinkPopup;t=u.value,l._onSaveHyperLinkEvt||(l._onSaveHyperLinkEvt=l._onSaveHyperLink.bind(l)),W.unbind("onSaved",l._onSaveHyperLinkEvt),W.bind("onSaved",l._onSaveHyperLinkEvt),W.setDataSource(t),W.open()}"change"==s&&l.validateForSaveBtn()},_onSaveHyperLink:function(e){var t=this.propertyViewModel.properties.hyperLink.items.file.value,a=e.result;t.set("id",a.id),t.set("name",""),t.set("name",a.name+""),this.validateForSaveBtn()},setActiveCanvas:function(e){this._activeCanvas=e}});I.ui.plugin(e)}(window,jQuery);