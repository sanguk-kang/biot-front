define("energy/consumptionandtarget/common/common",["energy/consumptionandtarget/common/widget"],function(t){var r=window.I18N,o=window.Util,n=t.msgDialog,i=window.moment;return{MSG:{TXT_SELECT_ALL:"Select All",TXT_UNSELECT_ALL:"Deselect All",TXT_CREATE_SCHEDULE:"Create New Schedule",TXT_EDIT_SCHEDULE:"Edit Schedule",TXT_DELETE_SCHEDULE:"Do you want to delete the selected Schedule?",TXT_DELETE_EXCEPTIONAL_DAY:"Do you want to delete the selected Exceptional Day?",TXT_DELETE_SCHEDULE_RESULT:"The selected Schedule has been deleted",TXT_DELETE_SCHEDULE_MULTI_RESULT:"The selected {0} Schedule has been deleted",TXT_DELETE_EXCEPTIONAL_DAY_RESULT:"The selected Exceptional Day has been deleted",TXT_DELETE_EXCEPTIONAL_DAY_MULTI_RESULT:"The selected {0} Exceptional Day has been deleted",TXT_CREATE_SCHEDULE_CONFIRM:"Do you want to Create schedule?",TXT_CREATE_SCHEDULE_CLOSE_CONFIRM:"Do you want to close this window?\nThe contents are canceled when you close this window.",TXT_EDIT_SCHEDULE_CONFIRM:"Do you want to Edit schedule?",COMMON_MESSAGE_CONFIRM_CANCEL:r.prop("COMMON_MESSAGE_CONFIRM_CANCEL"),COMMON_MESSAGE_NOTI_CHANGES_SAVED:r.prop("COMMON_MESSAGE_NOTI_CHANGES_SAVED"),ENERGY_TARGET_LESS:r.prop("ENERGY_TARGET_LESS")},TEXT:{FACILITY_DEVICE_OUTDOOR_TEMPERATURE:r.prop("FACILITY_DEVICE_OUTDOOR_TEMPERATURE"),COMMON_TIME:r.prop("COMMON_TIME"),ENERGY_GIRD_TOTAL:r.prop("ENERGY_GIRD_TOTAL"),ENERGY_GIRD_LIGHT:r.prop("ENERGY_GIRD_LIGHT"),ENERGY_GIRD_OTHER:r.prop("ENERGY_GIRD_OTHER"),ENERGY_SAC:r.prop("ENERGY_SAC"),ENERGY_LIGHT:r.prop("ENERGY_LIGHT"),ENERGY_OTHERS:r.prop("ENERGY_OTHERS"),COMMON_BTN_EDIT:r.prop("COMMON_BTN_EDIT"),COMMON_BTN_SAVE:r.prop("COMMON_BTN_SAVE"),COMMON_BTN_CANCEL:r.prop("COMMON_BTN_CANCEL"),ENERGY_TARGET_ENERGY_CONSUMPTION:r.prop("ENERGY_TARGET_ENERGY_CONSUMPTION"),ENERGY_DATE_JAN:r.prop("ENERGY_DATE_JAN"),ENERGY_DATE_FEB:r.prop("ENERGY_DATE_FEB"),ENERGY_DATE_MAR:r.prop("ENERGY_DATE_MAR"),ENERGY_DATE_APR:r.prop("ENERGY_DATE_APR"),ENERGY_DATE_MAY:r.prop("ENERGY_DATE_MAY"),ENERGY_DATE_JUN:r.prop("ENERGY_DATE_JUN"),ENERGY_DATE_JUL:r.prop("ENERGY_DATE_JUL"),ENERGY_DATE_AUG:r.prop("ENERGY_DATE_AUG"),ENERGY_DATE_SEP:r.prop("ENERGY_DATE_SEP"),ENERGY_DATE_OCT:r.prop("ENERGY_DATE_OCT"),ENERGY_DATE_NOV:r.prop("ENERGY_DATE_NOV"),ENERGY_DATE_DEC:r.prop("ENERGY_DATE_DEC"),ENERGY_REDUCTION:r.prop("ENERGY_REDUCTION"),COMMON_MENU_ENERGY_CONSUMPTION_AND_TARGET:r.prop("COMMON_MENU_ENERGY_CONSUMPTION_AND_TARGET"),ENERGY_AMOUNT_TARGET:r.prop("ENERGY_AMOUNT_TARGET"),COMMON_MENU_ENERGY_CONSUMPTION:r.prop("COMMON_MENU_ENERGY_CONSUMPTION"),ENERGY_ENERGY_CONSUMPTION:r.prop("ENERGY_ENERGY_CONSUMPTION"),ENERGY_ENERGY_CONSUMPTION_OF:r.prop("ENERGY_ENERGY_CONSUMPTION_OF"),ENERGY_DEVICE_GROUPS_EMPTY:r.prop("ENERGY_DEVICE_GROUPS_EMPTY"),ENERGY_TARGET_ENERGY_GRID:r.prop("ENERGY_TARGET_ENERGY_GRID"),ENERGY_TARGET_ENERGY:r.prop("ENERGY_TARGET_ENERGY"),FACILITY_DEVICE_TYPE_ALL_METER:r.prop("FACILITY_DEVICE_TYPE_ALL_METER"),COMMON_MENU_FACILITY_GROUP:r.prop("COMMON_MENU_FACILITY_GROUP"),ENERGY_METER_TYPE_WATTHOUR:r.prop("ENERGY_METER_TYPE_WATTHOUR"),ENERGY_METER_TYPE_GAS:r.prop("ENERGY_METER_TYPE_GAS"),ENERGY_METER_TYPE_WATER:r.prop("ENERGY_METER_TYPE_WATER"),ENERGY_ALL_GROUP:r.prop("ENERGY_ALL_GROUP"),ENERGY_ALL_DEVICE_GROUP:r.prop("ENERGY_ALL_DEVICE_GROUP"),ENERGY_ENERGY_METER_TYPE:r.prop("ENERGY_ENERGY_METER_TYPE"),ENERGY_INQUIRED_PERIOD:r.prop("ENERGY_INQUIRED_PERIOD"),ENERGY_INQUIRY_TARGET:r.prop("ENERGY_INQUIRY_TARGET"),ENERGY_NUMBER_OF_GROUP:r.prop("ENERGY_NUMBER_OF_GROUP")},groupFilterDataSource:function(){var a=[];return $.ajax({url:"/dms/groups"}).done(function(t){for(var e=0;e<t.length;e++)0<t[e].dms_devices_ids.length&&a.push({text:t[e].name,value:String(t[e].id)})}).fail(function(t){var e=o.parseFailResponse(t);n.message(e),n.open()}).always(function(){}),a},getChartXAxisLabel:function(t,e){var a,o,n=[];if("day"===t)if("24Hour"===window.GlobalSettings.getTimeDisplay())for(a=0;a<24;a++)n[a]=r.prop("ENERGY_CHART_TIME_HOUR",a);else n=["12 AM","1 AM","2 AM","3 AM","4 AM","5 AM","6 AM","7 AM","8 AM","9 AM","10 AM","11 AM","12 PM","1 PM","2 PM","3 PM","4 PM","5 PM","6 PM","7 PM","8 PM","9 PM","10 PM","11 PM"];else if("month"===t)for(o=i(e).daysInMonth(),a=1;a<=o;a++)n.push(i(a,"DD").format("Do"));else if("year"===t)for(o=12,a=1;a<=o;a++)n.push(i(a,"MM").format("MMM"));return n}}}),define("energy/consumptionandtarget/common/widget",[],function(){var t=$("<div/>"),e=$("<div/>");return{createNewWidget:function(t,e,a){return new e($("<div/>").attr("id",t),a)},msgDialog:t.kendoCommonDialog().data("kendoCommonDialog"),confirmDialog:e.kendoCommonDialog({type:"confirm"}).data("kendoCommonDialog")}}),define("energy/consumptionandtarget/template/consumption-template",[],function(){return{scheduleActivatedTemplate:function(t){return"<span class='panel-item-temp schedule-status'><span>"+(t.activated?"Operating":"Pause")+"</span></span>"}}}),define("energy/consumptionandtarget/template/target-template",[],function(){return{scheduleActivatedTemplate:function(t){return"<span class='panel-item-temp schedule-status'><span>"+(t.activated?"Operating":"Pause")+"</span></span>"}}}),define("energy/consumptionandtarget/view-model/consumption-vm",["energy/core","energy/consumptionandtarget/common/common"],function(t,e){for(var a=window.Util,o=e.TEXT,n=window.kendo,r=window.moment,i=a.getEnergyMeterTypeList(),l=[],s=e.groupFilterDataSource,d=0;d<s.length;d++){var c=s[d];l[d]={text:c[d].text,value:c[d].value}}return{MainViewModel:n.observable({graphBtn:{active:!1,disabled:!1,click:function(){}},listBtn:{active:!1,disabled:!1,click:function(){}},dayBtn:{active:!1,disabled:!1,click:function(){}},monthBtn:{active:!1,disabled:!1,click:function(){}},yearBtn:{active:!1,disabled:!1,click:function(){}},nextBtn:{active:!1,disabled:!1,click:function(){}},prevBtn:{active:!1,disabled:!1,click:function(){}},exportBtn:{active:!0,disabled:!1,click:function(){}},formattedDate:r().format("L").replace(/\./gi,"-"),filters:[{type:"dropdownlist",id:"device-type-list",disabled:!1,invisible:!1,options:{optionLabel:o.FACILITY_DEVICE_TYPE_ALL_METER,dataTextField:"text",dataValueField:"value",animation:!1,dataSource:i,open:function(){},close:function(){},change:function(){},select:function(){}}},{type:"dropdowncheckbox",id:"group-list",disabled:!1,invisible:!1,options:{optionLabel:!1,value:null,emptyText:o.COMMON_MENU_FACILITY_GROUP,showSelectAll:!0,selectAllText:o.ENERGY_ALL_GROUP,dataTextField:"name",dataValueField:"id",animation:!1,dataSource:l,cancelOption:!0,height:230,applyBox:!0,open:function(){},close:function(t){},change:function(){},select:function(t){}}}]}),Views:{graph:{view:null,widget:null,routeUrl:"/graph"},list:{view:null,widget:null,routeUrl:"/list"}},typeFilterDataSource:i,groupFilterDataSource:l,typeFilterText:{"Meter.WattHour":"WattHour","Meter.Gas":"Gas","Meter.Water":"Water","Meter.Calori":"Calori"},typeQuery:["Meter.*"]}}),define("energy/consumptionandtarget/view-model/comparison-vm",["energy/core","energy/consumptionandtarget/common/common"],function(t,e){for(var a=window.kendo,o=window.moment,n=window.Util,r=e.TEXT,i=n.getEnergyMeterTypeList(),l=[],s=e.groupFilterDataSource,d=0;d<s.length;d++){var c=s[d];l[d]={text:c[d].text,value:c[d].value}}return{MainViewModel:a.observable({exportBtn:{active:!1,disabled:!1,click:function(){}},graphBtn:{active:!1,disabled:!1,click:function(){}},dayBtn:{active:!1,disabled:!1,click:function(){}},monthBtn:{active:!1,disabled:!1,click:function(){}},yearBtn:{active:!1,disabled:!1,click:function(){}},nextBtn:{active:!1,disabled:!1,click:function(){}},prevBtn:{active:!1,disabled:!1,click:function(){}},chartLeftArrowBtn:{active:!0,disabled:!1,click:function(){}},chartRightArrowBtn:{active:!0,disabled:!1,click:function(){}},formattedDate:o().format("L").replace(/\./gi,"-"),filters:[{type:"dropdownlist",id:"comparison-device-type-list",disabled:!1,invisible:!1,options:{optionLabel:r.FACILITY_DEVICE_TYPE_ALL_METER,dataTextField:"text",dataValueField:"value",animation:!1,dataSource:i,open:function(){},close:function(){},change:function(){},select:function(){}}},{type:"dropdowncheckbox",id:"comparison-group-list",disabled:!1,invisible:!1,options:{optionLabel:!1,value:"Group",emptyText:r.COMMON_MENU_FACILITY_GROUP,showSelectAll:!1,dataTextField:"name",dataValueField:"id",animation:!1,dataSource:l,cancelOption:!0,height:230,applyBox:!0,restrictionNum:3,selectedText:"ellipsis",open:function(){},close:function(t){t&&t.sender.list.hasClass("k-state-border-up")&&0<this.preventCloseCnt&&(t.preventDefault(),this.preventCloseCnt--)},change:function(){},select:function(t){t&&t.item.hasClass("k-state-disabled")&&(t.preventDefault(),this.preventCloseCnt=2)}}}]}),Views:{graph:{view:null,widget:null,routeUrl:"/graph"},list:{view:null,widget:null,routeUrl:"/list"}},typeFilterDataSource:i,groupFilterDataSource:l,typeFilterText:{"Meter.WattHour":"WattHour","Meter.Gas":"Gas","Meter.Water":"Water","Meter.Calori":"Calori"},typeQuery:["Meter.*"]}}),define("energy/consumptionandtarget/view-model/target-vm",["energy/core","energy/consumptionandtarget/common/common"],function(t,e){var a=window.kendo,o=window.Util,n=e.TEXT,r=o.getEnergyMeterTypeList();return{MainViewModel:a.observable({graphBtn:{active:!1,disabled:!1,click:function(){}},listBtn:{active:!1,disabled:!1,click:function(){}},nextBtn:{active:!1,disabled:!1,click:function(){}},prevBtn:{active:!1,disabled:!1,click:function(){}},filters:[{type:"dropdownlist",id:"device-type-list2",disabled:!1,invisible:!1,options:{optionLabel:n.FACILITY_DEVICE_TYPE_ALL_METER,dataTextField:"text",dataValueField:"value",animation:!1,dataSource:r,open:function(){},close:function(){},change:function(){},select:function(){}}},{type:"dropdownlist",id:"group-list2",disabled:!1,invisible:!1,options:{optionLabel:n.COMMON_MENU_FACILITY_GROUP,dataTextField:"name",dataValueField:"id",animation:!1,dataSource:[],open:function(){},close:function(){},change:function(){},select:function(){}}}],actionMode:!0,actions:[{type:"button",id:"target-edit",text:"Edit",invisible:!0,disabled:!0,options:{click:function(){},dbclick:function(){},mouseover:function(){},mouseout:function(){}}},{type:"button",id:"target-cancel",text:"Cancel",invisible:!0,disabled:!1,options:{click:function(){},dbclick:function(){},mouseover:function(){},mouseout:function(){}}},{type:"button",id:"target-save",text:"Save",invisible:!0,disabled:!0,options:{click:function(){},dbclick:function(){},mouseover:function(){},mouseout:function(){}}}]}),typeFilterDataSource:r,typeFilterText:{"Meter.WattHour":"WattHour","Meter.Gas":"Gas","Meter.Water":"Water","Meter.Calori":"Calori"},typeQuery:["Meter.*"]}}),define("energy/consumptionandtarget/model/consumption-model",[],function(){"use strict";return{Model:window.kendo.data.Model.define({id:"id",fields:{name:{name:"Name"},description:{name:"Description"},activated:{name:"Activation",type:"boolean"},startDate:{name:"Start Date",type:"date"},endDate:{name:"End Date",type:"date"},daysOfWeek:{name:"Repeat Days",type:"object",defaultValue:[]},exceptionalDays:{name:"Execeptional Days",type:"object",defaultValue:[]},executionTimes:{name:"Execution Time",type:"object",defaultValue:[]},devices:{name:"Devices",type:"object",defaultValue:[]},control:{name:"Operations",type:"object",defaultValue:{}}}}),modelData:[],temperatureData:[],targetData:[],createDataSource:function(t){return t}}}),define("energy/consumptionandtarget/model/comparison-model",[],function(){"use strict";return{Model:window.kendo.data.Model.define({id:"id",fields:{name:{name:"Name"},description:{name:"Description"},activated:{name:"Activation",type:"boolean"},startDate:{name:"Start Date",type:"date"},endDate:{name:"End Date",type:"date"},daysOfWeek:{name:"Repeat Days",type:"object",defaultValue:[]},exceptionalDays:{name:"Execeptional Days",type:"object",defaultValue:[]},executionTimes:{name:"Execution Time",type:"object",defaultValue:[]},devices:{name:"Devices",type:"object",defaultValue:[]},control:{name:"Operations",type:"object",defaultValue:{}}}}),modelData:[],temperatureData:[],createDataSource:function(t){return t},reqTemperatureDataToServer:function(t){var e="/energy/temperature?"+t;return $.ajax({url:e})},reqEnergyDataToServer:function(t){var e="/energy/consumption/group?"+t;return $.ajax({url:e})},mockTemperatureData:function(){return{monthly:{monthly:[{month:1,degree:20},{month:2,degree:20},{month:3,degree:20},{month:4,degree:33},{month:5,degree:28},{month:6,degree:17},{month:7,degree:21},{month:8,degree:22},{month:9,degree:24},{month:10,degree:20},{month:11,degree:27},{month:12,degree:23}]},daily:{daily:[{day:1,degree:20},{day:2,degree:20},{day:3,degree:20},{day:4,degree:21},{day:5,degree:20},{day:6,degree:20},{day:7,degree:23},{day:8,degree:20},{day:9,degree:20},{day:10,degree:33},{day:11,degree:20},{day:12,degree:20},{day:13,degree:20},{day:14,degree:20},{day:15,degree:20},{day:16,degree:20},{day:17,degree:15},{day:18,degree:20},{day:19,degree:20},{day:20,degree:20},{day:21,degree:20},{day:22,degree:20},{day:23,degree:30},{day:24,degree:20},{day:25,degree:20},{day:26,degree:20},{day:27,degree:40},{day:28,degree:20},{day:29,degree:20},{day:30,degree:20},{day:31,degree:20}]},timely:{hourly:[{hour:"0",degree:20},{hour:1,degree:20},{hour:2,degree:15},{hour:3,degree:20},{hour:4,degree:25},{hour:5,degree:30},{hour:6,degree:20},{hour:7,degree:30},{hour:8,degree:20},{hour:9,degree:20},{hour:10,degree:20}]}}},mockEnergyData:function(){return{monthly:{monthly:[{group_name:"GroupAirConditioner1",monthly:[{month:1,total:812.24,sac:405.52,light:203.36,others:203.36},{month:2,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{month:3,total:862.5,sac:459.98,light:201.26,others:201.26},{month:4,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{month:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{month:6,total:953.5400000000001,sac:506.82,light:223.36,others:223.36},{month:7,total:640.38,sac:213.46,light:213.46,others:213.46},{month:8,total:640.38,sac:213.46,light:213.46,others:213.46},{month:9,total:640.38,sac:213.46,light:213.46,others:213.46},{month:10,total:640.38,sac:213.46,light:213.46,others:213.46},{month:11,total:640.38,sac:213.46,light:213.46,others:213.46},{month:12,total:640.38,sac:213.46,light:213.46,others:213.46}]},{group_name:"GroupAirconditionerOutdoor2",monthly:[{month:1,total:610.08,sac:203.36,light:203.36,others:203.36},{month:2,total:606.48,sac:202.16,light:202.16,others:202.16},{month:3,total:603.78,sac:201.26,light:201.26,others:201.26},{month:4,total:656.16,sac:218.72,light:218.72,others:218.72},{month:5,total:638.13,sac:212.71,light:212.71,others:212.71},{month:6,total:670.08,sac:223.36,light:223.36,others:223.36},{month:7,total:640.38,sac:213.46,light:213.46,others:213.46},{month:8,total:640.38,sac:213.46,light:213.46,others:213.46},{month:9,total:640.38,sac:213.46,light:213.46,others:213.46},{month:10,total:640.38,sac:213.46,light:213.46,others:213.46},{month:11,total:640.38,sac:213.46,light:213.46,others:213.46},{month:12,total:640.38,sac:213.46,light:213.46,others:213.46}]},{group_name:"GroupAirConditioner3",monthly:[{month:1,total:812.24,sac:405.52,light:203.36,others:203.36},{month:2,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{month:3,total:862.5,sac:459.98,light:201.26,others:201.26},{month:4,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{month:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{month:6,total:953.5400000000001,sac:506.82,light:223.36,others:223.36},{month:7,total:640.38,sac:213.46,light:213.46,others:213.46},{month:8,total:640.38,sac:213.46,light:213.46,others:213.46},{month:9,total:640.38,sac:213.46,light:213.46,others:213.46},{month:10,total:640.38,sac:213.46,light:213.46,others:213.46},{month:11,total:640.38,sac:213.46,light:213.46,others:213.46},{month:12,total:640.38,sac:213.46,light:213.46,others:213.46}]}],unit:"kWh"},daily:{daily:[{group_name:"GroupAirConditioner1",daily:[{day:1,total:812.24,sac:405.52,light:203.36,others:203.36},{day:2,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:3,total:862.5,sac:459.98,light:201.26,others:201.26},{day:4,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:6,total:953.5400000000001,sac:506.82,light:223.36,others:223.36},{day:7,total:640.38,sac:213.46,light:213.46,others:213.46},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:9,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:10,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:11,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71}]},{group_name:"GroupAirconditionerOutdoor2",daily:[{day:1,total:812.24,sac:405.52,light:203.36,others:203.36},{day:2,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:3,total:862.5,sac:459.98,light:201.26,others:201.26},{day:4,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:6,total:953.5400000000001,sac:506.82,light:223.36,others:223.36},{day:7,total:640.38,sac:213.46,light:213.46,others:213.46},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:9,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:10,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:11,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71}]},{group_name:"GroupAirConditioner3",daily:[{day:1,total:812.24,sac:405.52,light:203.36,others:203.36},{day:2,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:3,total:862.5,sac:459.98,light:201.26,others:201.26},{day:4,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:6,total:953.5400000000001,sac:506.82,light:223.36,others:223.36},{day:7,total:640.38,sac:213.46,light:213.46,others:213.46},{day:5,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71},{day:9,total:807.7399999999999,sac:403.41999999999996,light:202.16,others:202.16},{day:10,total:918.87,sac:481.42999999999995,light:218.72,others:218.72},{day:11,total:911.4900000000001,sac:486.07000000000005,light:212.71,others:212.71}]}],unit:"kWh"},timely:{hourly:[{group_name:"GroupAirConditioner1",hourly:[{hour:0,total:610.08,sac:203.36,light:203.36,others:203.36},{hour:1,total:808.64,sac:404.32,light:202.16,others:202.16},{hour:2,total:805.04,sac:402.52,light:201.26,others:201.26},{hour:3,total:914.8800000000001,sac:477.44000000000005,light:218.72,others:218.72},{hour:4,total:900.84,sac:475.41999999999996,light:212.71,others:212.71},{hour:5,total:943.44,sac:496.72,light:223.36,others:223.36},{hour:6,total:923.84,sac:496.91999999999996,light:213.46,others:213.46},{hour:7,total:808.64,sac:404.32,light:202.16,others:202.16},{hour:8,total:805.04,sac:402.52,light:201.26,others:201.26},{hour:9,total:914.8800000000001,sac:477.44000000000005,light:218.72,others:218.72},{hour:10,total:900.84,sac:475.41999999999996,light:212.71,others:212.71},{hour:11,total:808.64,sac:404.32,light:202.16,others:202.16},{hour:12,total:805.04,sac:402.52,light:201.26,others:201.26},{hour:13,total:914.8800000000001,sac:477.44000000000005,light:218.72,others:218.72},{hour:14,total:900.84,sac:475.41999999999996,light:212.71,others:212.71},{hour:15,total:465.64,sac:240.04,light:43.51,others:176.17},{hour:16,total:465.64,sac:240.04,light:43.51,others:136.17},{hour:17,total:465.64,sac:240.04,light:43.51,others:176.17},{hour:18,total:465.64,sac:240.04,light:43.51,others:76.17},{hour:19,total:465.64,sac:240.04,light:43.51,others:176.17},{hour:20,total:465.64,sac:240.04,light:43.51,others:76.17},{hour:21,total:465.64,sac:240.04,light:43.51,others:176.17},{hour:22,total:465.64,sac:240.04,light:43.51,others:76.17},{hour:23,total:465.64,sac:240.04,light:43.51,others:176.17}]},{group_name:"GroupAirconditionerOutdoor2",hourly:[{hour:0,total:610.08,sac:203.36,light:203.36,others:203.36},{hour:1,total:606.48,sac:202.16,light:202.16,others:202.16},{hour:2,total:603.78,sac:201.26,light:201.26,others:201.26},{hour:3,total:656.16,sac:218.72,light:218.72,others:218.72},{hour:4,total:638.13,sac:212.71,light:212.71,others:212.71},{hour:5,total:670.08,sac:223.36,light:223.36,others:223.36},{hour:6,total:640.38,sac:213.46,light:213.46,others:213.46}]}],unit:"kWh"}}},data:{}}}),define("energy/consumptionandtarget/model/target-model",function(){"use strict";return{Model:window.kendo.data.Model.define({id:"id",fields:{name:{name:"Name"},description:{name:"Description"},activated:{name:"Activation",type:"boolean"},startDate:{name:"Start Date",type:"date"},endDate:{name:"End Date",type:"date"},daysOfWeek:{name:"Repeat Days",type:"object",defaultValue:[]},exceptionalDays:{name:"Execeptional Days",type:"object",defaultValue:[]},executionTimes:{name:"Execution Time",type:"object",defaultValue:[]},devices:{name:"Devices",type:"object",defaultValue:[]},control:{name:"Operations",type:"object",defaultValue:{}}}}),targetData:{},lastYearData:{},thisYearData:{},createDataSource:function(t){return t}}}),define("energy/consumptionandtarget/comparison",["energy/core","energy/consumptionandtarget/view-model/comparison-vm","energy/consumptionandtarget/model/comparison-model","energy/consumptionandtarget/common/common","energy/consumptionandtarget/common/widget"],function(t,e,I,C,i){var d,c,B=window.moment,U=window.kendo,a=window.CommonLoadingPanel,F=window.Util,u=window.I18N,g=new a,O=e.MainViewModel,h=e.Views,V=C.TEXT,o=new U.Router,n=new U.Layout("<div id='comparison-main-view-content' class='comparison-main-view-content'></div>",{wrap:!1}),p=i.msgDialog,r=$("#comparison-main-view"),l=null,P={"Meter.WattHour":["(kWh)",V.ENERGY_METER_TYPE_WATTHOUR],"Meter.Gas":["(\u33a5)",V.ENERGY_METER_TYPE_GAS],"Meter.Water":["(L)",V.ENERGY_METER_TYPE_WATER],"Meter.Calori":["",V.ENERGY_METER_TYPE_CALORI],none:["",""]},s=function(){g.open(),$.ajax({url:"/dms/groups"}).done(function(t){$(".graphTopBox").remove(),$("#comparison-main-view-content").prepend(Y()),O.dayBtn.click(),O.exportBtn.set("disabled",!0),O.filters[1].options.set("dataSource",t)}).fail(function(t){var e=F.parseFailResponse(t);p.message(e),p.open()}).always(function(){$("#comparison-group-list").data("kendoDropDownCheckBox").unselectAll(),$("#comparison-group-list").data("kendoDropDownCheckBox").options.cancelOption=!0,$("#comparison-group-list").data("kendoDropDownCheckBox").options.isAbleUnselectAll=!0,O.nextBtn.set("disabled",!0),g.close()})},m=function(){o.bind("init",f);var t=I.createDataSource(I.modelData);h.graph.widget=R(t,[]),h.graph.view=new U.View(h.graph.widget.wrapper,{wrap:!1}),o.route(h.graph.routeUrl,E.bind(o,h.graph.view)),t=I.createDataSource(I.modelData),o.start()},f=function(){n.render(r)},E=function(t){n.showIn("#comparison-main-view-content",t)},v=function(){O.set("setDateView",B().format(O.formattedDate)),l.bind("activate",y),O.exportBtn.set("click",function(){!function(){var t,e,a,o,n,r,i,l,s,d=[],c={rows:[]},u=I.data,g=u.allList.dateUnit,h=[],p=[],m={};"hourly"==g?(t="hour",e=0):"daily"==g?(t="day",e=-1):"monthly"==g&&(t="month",e=-1);var f=[],E=[],v=F.getDisplayType(u.meterType);v=v?P[u.meterType][1]:"";var y,_=u.timeInfo,b=[];u.originData.energy&&(f=u.originData.energy[g]),u.originData.temperature&&(E=u.originData.temperature[g]),c.rows.push({cells:[]});var T=c.rows[0];T.cells.push({value:V.COMMON_TIME}),u.originData.temperature,T.cells.push({value:V.FACILITY_DEVICE_OUTDOOR_TEMPERATURE}),b.push(E.length);var N,w=$("#comparison-group-list").data("kendoDropDownCheckBox"),D=$("#comparison-group-list").val(),R=0<D.indexOf(",")?D.split(","):[D];if(D)for(a=0;a<w.dataSource._data.length;a++){var Y=w.dataSource._data[a].id,A=w.dataSource._data[a].name;for(o=0;o<R.length;o++)R[o]==Y&&(T.cells.push({value:v+"-"+A+":"+V.ENERGY_SAC}),T.cells.push({value:v+"-"+A+":"+V.ENERGY_LIGHT}),T.cells.push({value:v+"-"+A+":"+V.ENERGY_OTHERS}),h.push(A))}if(u.originData.energy&&f&&0<f.length)for(a=0;a<f.length;a++){var x=f[a];b.push(x[g].length)}for(y=Math.max.apply(null,b),a=0;a<y;a++){c.rows.push({cells:[]}),N=c.rows[a+1].cells;var G="";if("hourly"==g)G=new Date(_.year,_.month-1,_.day,a,0),N.push({value:B(G).format("LLL").replace(/\./g,"-")});else if("daily"==g)G=new Date(_.year,_.month-1,a+1),N.push({value:B(G).format("YYYY-MM-DD")});else if("monthly"==g){var M=new Date(_.year,a+1).getDate();G=new Date(_.year,a,M),N.push({value:B(G).format("YYYY-MM")})}}for(a=0;a<y;a++){N=c.rows[a+1].cells;var C="";for(o=0;o<E.length;o++)if(Number(E[o][t])+e==a){C=E[o].degree;break}N.push({value:C})}if(u.originData.energy&&f&&0<f.length){for(a=0;a<h.length;a++)for(o=1;o<y;o++)(N=c.rows[o].cells).push({value:""}),N.push({value:""}),N.push({value:""});var O,S;for(a=0;a<f.length;a++){for(p=f[a][g],S=!1,n=0;n<h.length;n++)f[a].dms_group_name==h[n]&&(S=!0,O=n);for(o=0;o<y;o++)if(s=l=i="",S)for(r=0;r<p.length;r++){m=p[r];var k=Number(p[r][t])+e;N=c.rows[k+1].cells,m&&m.sac&&(i=m.sac),m&&m.light&&(l=m.light),m&&m.others&&(s=m.others),N[1+3*O+1]={value:i},N[1+3*O+2]={value:l},N[1+3*O+3]={value:s}}}}if(u.originData.energy&&f&&0<f.length)for(a=0;a<h.length;a++){for(o=0;o<y;o++)(N=c.rows[o+1].cells).push({value:""}),N.push({value:""}),N.push({value:""});for(o=0;o<y;o++)if(f[a]&&f[a][t])for(p=f[a][t],n=0;n<p.length;n++)N=c.rows[o+1].cells,p[n][t]+e==o?(s=l=i="",(m=p[n])&&m.sac&&(i=m.sac),m&&m.light&&(l=m.light),m&&m.others&&(s=m.others),N[o+2]={value:i},N[o+2]={value:l},N[o+2]={value:s}):(N[o+2]={value:""},N[o+2]={value:""},N[o+2]={value:""})}d.push(c);var L=new U.ooxml.Workbook({sheets:d});U.saveAs({dataURI:L.toDataURL(),fileName:"data.csv"})}()}),O.dayBtn.set("click",function(){O.monthBtn.set("active",!1),O.yearBtn.set("active",!1),1!=O.monthBtn.get("active")&&(O.set("formattedDate",B().format(_("day"))),O.dayBtn.set("active",!0),T(),w())}),O.monthBtn.set("click",function(){O.dayBtn.set("active",!1),O.yearBtn.set("active",!1),1!=O.monthBtn.get("active")&&(O.monthBtn.set("active",!0),O.set("formattedDate",B().format(_("month"))),T(),w())}),O.yearBtn.set("click",function(){O.dayBtn.set("active",!1),O.monthBtn.set("active",!1),1!=O.monthBtn.get("active")&&(O.set("formattedDate",B().format(_("year"))),O.yearBtn.set("active",!0),T(),w())}),O.nextBtn.set("click",function(){var t=N(O.formattedDate,1);O.set("formattedDate",B().format(t)),T(),b(),w()}),O.prevBtn.set("click",function(){var t=N(O.formattedDate,-1);O.set("formattedDate",B().format(t)),T(),b(),w()}),$("#comparison-device-type-list").on("change",function(){d=$(this).val();var t=$("#comparison-group-list").data("kendoDropDownCheckBox");d?(g.open(),$.ajax({url:"/dms/groups?dms_devices_types="+d}).done(function(t){O.filters[1].options.set("dataSource",t)}).fail(function(){}).always(function(){t.unselectAll(),t.enable(!0),g.close()})):(t.unselectAll(),t.enable(!1))}),$("#main-sidebar-menu").find(".btn-util").on("click",".btn",function(t){h.graph.widget.setOptions({chartArea:{width:r.width()}})}),$("#comparison-group-list").data("kendoDropDownCheckBox").bind("selectionChanged",function(t){c=t.newValue,w()})},y=function(t){"consumption-common-tab-2"==$(t.contentElement).prop("id")&&h.graph.widget.setOptions({chartArea:{width:r.width(),height:r.height()-68-61}})},_=function(t){var e="",a=O.setDateView.split("-"),o=B().format("DD");return"year"==t&&(e=a[0]),"month"==t&&(e=a[0]+"-"+a[1]),"day"==t&&(e=a[0]+"-"+a[1]+"-"+o,B(e).isValid()||(o=B(a[0]+"-"+a[1]).daysInMonth(),e=a[0]+"-"+a[1]+"-"+o)),e},b=function(){var t,e=O.formattedDate.split("-"),a=O.setDateView.split("-");1<=e.length&&(a[0]=e[0]),2<=e.length&&(a[1]=e[1]),3<=e.length&&(a[2]=e[2]),t=a[0]+"-"+a[1]+"-"+a[2],O.set("setDateView",B().format(t))},T=function(){var t,e,a,o,n,r,i=O.formattedDate.split("-"),l=new Date,s=i.length,d={year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()},c={year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()};String(c.month).length<2&&(c.month="0"+c.month),String(c.day).length<2&&(c.day="0"+c.day);var u=O.get("setDateView"),g=null;1<=s&&(t=Number(i[0]),r=d.year,o=Number(String(c.year)),Number(t)==o?O.nextBtn.set("disabled",!0):Number(t)>o?(O.nextBtn.set("disabled",!0),O.set("formattedDate",r),O.set("setDateView",r)):O.nextBtn.set("disabled",!1)),2<=s&&(r=d.year+"-"+(1<String(d.month).length?d.month:"0"+d.month),e=Number(i[1]),String(e).length<2&&(e="0"+e),o=Number(String(c.year)+String(c.month)),(n=Number(String(t)+String(e)))==o?O.nextBtn.set("disabled",!0):o<=n?(O.nextBtn.set("disabled",!0),O.set("formattedDate",r),g=u.split("-")[2],O.set("setDateView",r+"-"+g)):O.nextBtn.set("disabled",!1)),3<=s&&(r=d.year+"-"+(1<String(d.month).length?d.month:"0"+d.month)+"-"+(1<String(d.day).length?d.day:"0"+d.day),a=Number(i[2]),String(a).length<2&&(a="0"+a),o=Number(String(c.year)+String(c.month)+String(c.day)),(n=Number(String(t)+String(e)+String(a)))==o?O.nextBtn.set("disabled",!0):o<=n?(O.nextBtn.set("disabled",!0),O.set("formattedDate",r),O.set("setDateView",r)):O.nextBtn.set("disabled",!1))},N=function(t,e){var a,o,n,r,i,l,s,d,c=t.split("-"),u=c.length;if(s=["01","02","03","04","05","06","07","08","09","10","11","12"],1<=u&&(a=Number(c[0]),r="year"),2<=u&&(r="month",d=g(a,o=Number(c[1]))),3<=u&&(n=Number(c[2]),r="day"),"year"==r)return a+=e,String(a);if("month"==r)return s.length<(o+=e)||o<=0?a+e+"-"+(i=0<o?s[0]:s[11]):a+"-"+s[o-1];if("day"==r)return(n+=e)>d.length||n<=0?0<n?s.length<(o+=e)||o<=0?(d=0<o?(i=s[0],g(a+e,1)):(i=s[11],g(a+e,12)),a+e+"-"+i+"-"+(l=d[0])):(l=(d=g(a,o))[0],a+"-"+s[o-1]+"-"+l):(l=d[d.length-1],s.length<(o+=e)||o<=0?(d=0<o?(i=s[0],g(a+e,1)):(i=s[11],g(a+e,12)),a+e+"-"+i+"-"+(l=d[d.length-1])):(l=(d=g(a,o))[d.length-1],a+"-"+s[o-1]+"-"+l)):a+"-"+s[o-1]+"-"+d[n-1];function g(t,e){for(var a=new Date(t,e,0).getDate(),o=[],n=1;n<=a;n++)1==String(n).length?o.push("0"+n):o.push(n);return o}},w=function(){var t,a,e,o,n,r,i=O.formattedDate.split("-"),l=null,s=null;if(1==i.length?t="year="+i[0]:2==i.length?t="year="+i[0]+"&month="+Number(i[1]):3==i.length&&(t="year="+i[0]+"&month="+Number(i[1])+"&day="+Number(i[2])),I.data.timeInfo={year:Number(i[0]),month:Number(i[1])?Number(i[1]):null,day:Number(i[2])?Number(i[2]):null},e=t,d?$("#comparison-group-list").data("kendoDropDownCheckBox").enable(!0):$("#comparison-group-list").data("kendoDropDownCheckBox").enable(!1),t=t+"&dms_meter_type="+d,I.data.meterType=d,!c||c.length<1)return a=D(null,null),void h.graph.widget.setOptions({categoryAxis:{categories:a.categories,axisCrossingValues:[0,0,100,100],select:!1},series:[]});o=t=t+"&dms_group_ids="+c,n=I.reqTemperatureDataToServer(e),r=I.reqEnergyDataToServer(o),g.open(),n.then(function(t){l=t,O.exportBtn.set("disabled",!1)},function(t){p.message(t.statusText+" "+t.status),p.open()}),n.always(function(){r.then(function(t){s=t,O.exportBtn.set("disabled",!1)},function(t){p.message(t.statusText+" "+t.status),p.open()}),r.always(function(){g.close(),a=D(s,l),s||l||O.exportBtn.set("disabled",!0),h.graph.widget.setOptions({selectionTooltip:{rowGroupNames:function(){var t,e,a=$("#comparison-group-list").data("kendoDropDownCheckBox")._data();for(t=0,e=[];t<a.length;t++)e.push(a[t].name);return e}(),rowTemplate:function(t){var e={groupName:"",content:"",priority:0};switch("temperature"!=t.series.name&&(t.data=U.toString(t.data,"n1")),t.series.name){case"temperature":e.content+="<span class='energy-comparison-graph-tooltip-legend-line'><em class='energy-comparison-graph-tooltip-legend-circle'></em></span><span class='energy-comparison-graph-tooltip-content-name'>"+u.prop("FACILITY_DEVICE_OUTDOOR_TEMPERATURE")+"</span><span class='energy-comparison-graph-tooltip-content-data'>"+t.data+"("+a.dataUnit.temperature+")</span>",e.priority=1;break;case"sac":e.content+="<span class='energy-comparison-graph-tooltip-legend-square' style='background-color:#0081c6'></span><span class='energy-comparison-graph-tooltip-content-name'>"+u.prop("ENERGY_SAC")+"</span><span class='energy-comparison-graph-tooltip-content-data'>"+t.data+"("+a.dataUnit.energy+")</span>";break;case"light":e.content+="<span class='energy-comparison-graph-tooltip-legend-square' style='background-color:#4ca7d7'></span><span class='energy-comparison-graph-tooltip-content-name'>"+u.prop("ENERGY_LIGHT")+"</span><span class='energy-comparison-graph-tooltip-content-data'>"+t.data+"("+a.dataUnit.energy+")</span>";break;case"others":e.content+="<span class='energy-comparison-graph-tooltip-legend-square' style='background-color:#99cde8'></span><span class='energy-comparison-graph-tooltip-content-name'>"+u.prop("ENERGY_OTHERS")+"</span><span class='energy-comparison-graph-tooltip-content-data'>"+t.data+"("+a.dataUnit.energy+")</span>";break;default:e.content="",e.priority=0,e.groupName=""}return e.groupName="temperature"==t.series.name?"":t.series.stack,e}},axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:$("#comparison-main-view-content").height()-31,width:$("#comparison-main-view").width()},plotArea:{background:"#f7f7f8"},legend:{visible:!1},xAxis:{border:{color:"#444"}},labels:{position:"top"},series:a.setSeries,valueAxes:a.setValueAxes,categoryAxis:{categories:a.categories,axisCrossingValues:[0,0,100,100],select:!1}}),h.graph.widget.dataSource.sync(),$(".graphTopBox").remove(),$("#comparison-main-view-content").prepend(Y(a.dataUnit.energy,a.dataUnit.temperature))})})},D=function(t,e){var a,o,n,r,i,l,s,d,c,u,g,h,p,m=O.formattedDate.split("-"),f=[];3==(g=m.length)&&(a="hourly",o="hour",n=C.getChartXAxisLabel("day")),2==g&&(a="daily",o="day",n=function(t,e){var a=new Date(t,e,0),o=a.getDate(),n=[];for(h=1;h<=o;h++)n.push(B(a.setDate(h)).format("Do"));return n}(m[0],m[1])),1==g&&(a="monthly",o="month",n=B().localeData().monthsShort()),!t||!t[a]||t[a].length<1?(r=!1,l=1,c=""):(c=(r=t).unit,l=G(t,a).max,i=G(t,a).min),d=!e||!e[a]||e[a].length<1?(e=!1,s=-15,35):(e=e,0<(s=Math.floor(1.2*M(e).min))&&(s=0),Math.floor(1.2*M(e).max));var E=window.GlobalSettings.getTemperature().unit;u=F.CHAR[E];var v={},y=n.length,_=null;if(v.dateUnit=a,r)for(v.groupConfig={groupCnt:r[a].length,dateUnit:a},v.tooltipConfig={category:n,dateUnit:a,dataSource:r},h=0;h<r[a].length;h++){var b=r[a][h],T=b.dms_group_name,N=b[a];for(v[T]={},v[T][a]=[],v[T].totalList=[],v[T].sacList=[],v[T].lightList=[],v[T].othersList=[],p=0;p<y;p++)v[T][a].push(null),v[T].totalList.push(null),v[T].sacList.push(null),v[T].lightList.push(null),v[T].othersList.push(null);for(p=0;p<N.length;p++)_=3!=g?N[p][o]-1:N[p][o],v[T][a][_]=N[p][o],v[T].totalList[_]=N[p].total,v[T].sacList[_]=N[p].sac,v[T].lightList[_]=N[p].light,v[T].othersList[_]=N[p].others}if(v.temperatureList=[],e){for(h=0;h<y;h++)v.temperatureList.push(null);for(h=0;h<e[a].length;h++){var w=e[a][h];_=3!=g?w[o]-1:w[o],v.temperatureList[_]=e[a][h].degree}}I.data.allList=v,I.data.originData={energy:t,temperature:e};var D,R=Object.keys(v);for(h=0;h<R.length;h++){var Y=R[h],A=v[R[h]];if("temperatureList"==Y)f.push({type:"line",data:A,name:"temperature",color:"#888",axis:"temperature",markers:{size:6,background:"#808080",border:{width:0,color:"#808080"},highlight:{line:{width:0}}}});else{var x=Object.keys(A);for(p=0;p<x.length;p++)"othersList"==x[p]&&f.push({type:"column",data:A.othersList,stack:Y,groupConfig:v.groupConfig,tooltipConfig:v.tooltipConfig,name:"others",color:"#99cde8",labels:!1}),"sacList"==x[p]&&f.push({type:"column",data:A.sacList,stack:Y,tooltipConfig:v.tooltipConfig,name:"sac",color:"#0081c6"}),"lightList"==x[p]&&f.push({type:"column",data:A.lightList,stack:Y,tooltipConfig:v.tooltipConfig,name:"light",color:"#4ca7d7"})}}function G(t,e){var a=[],o=[];for(h=0;h<t[e].length;h++){var n=t[e][h];a.push(n.max),o.push(n.min)}return{max:1.2*(Math.ceil(Math.max.apply(null,a))||12e3),min:0}}function M(t){var e=t.max,a=t.min;return{max:e=e||50,min:a=a||-50}}return{setSeries:f,setValueAxes:[{name:c,min:i,max:F.getChartOptionsForFiveChartSection(l,0).newMax,majorGridLines:{visible:!1},majorUnit:F.getChartOptionsForFiveChartSection(l,0).newMajorUnit,labels:{template:function(t){return 1<t.value?Math.floor(t.value):t.value}}},{majorGridLines:{visible:!1},visible:!1},{name:"temperature",min:s,max:d,axis:"temperature",majorGridLines:{visible:!1},majorUnit:(D=(d-s)/5,F.convertNumberFormat(D)),labels:{template:function(t){return F.convertNumberFormat(t.value)}}}],categories:n,dataUnit:{energy:c,temperature:u},dateType:a}},R=function(t,e){for(var a=D(t,e),o=[],n=0;n<a.categories.length;n++)o.push(0);var r={selectionTooltip:{isVisible:!0,width:300,seriesKeysForRowName:["name","stack"],rowGroupNames:[]},axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:$("#comparison-main-view").height()-61,width:$("#comparison-main-view").width()},plotArea:{border:{},background:"#f7f7f8"},legend:{visible:!1},xAxis:{border:{color:"#444"}},series:o,valueAxes:a.setValueAxes,categoryAxis:{categories:a.categories,axisCrossingValues:[0,0,100,100]}};return $("#comparison-main-view-content").prepend(Y()),i.createNewWidget("comparison-chart",U.dataviz.ui.Chart,r)},Y=function(t,e){var a="",o="";return t&&(a="("+t+")"),e&&(o="("+e+")"),'<div class="graphTopBox"><span class="graph-unit-symbol energy">'+a+'</span><div class="right"><ul><li><span class="line" style="background-color:#808080"><em class="circle" style="background-color:#808080"></em></span>'+u.prop("FACILITY_DEVICE_OUTDOOR_TEMPERATURE")+'</li><li><span class="square" style="background-color:#0081c6"></span>'+u.prop("ENERGY_SAC")+'</li><li><span class="square" style="background-color:#4ca7d7"></span>'+u.prop("ENERGY_LIGHT")+'</li><li><span class="square" style="background-color:#99cde8"></span>'+u.prop("ENERGY_OTHERS")+'</li></ul></div><span class="graph-unit-symbol temperature">'+o+"</span></div>"};return{init:function(t){var e=t.contentElement(1);l=t,m(),U.bind($(e),O),v(),s()}}}),define("energy/consumptionandtarget/target",["energy/core","energy/consumptionandtarget/view-model/target-vm","energy/consumptionandtarget/model/target-model","energy/consumptionandtarget/template/target-template","energy/consumptionandtarget/common/common","energy/consumptionandtarget/common/widget"],function(t,e,a,o,n,r){var d,c,u,l,v,y,g,h=window.kendo,p=window.moment,i=window.GlobalSettings,s=window.CommonLoadingPanel,m=window.Util,_=e.groupFilterDataSource,f=new s,b=e.MainViewModel,E=$("#target-list-template").html(),T={},N=[],w=$("#target-main-view"),D=r.msgDialog,R=r.confirmDialog,Y=n.MSG,A=n.TEXT,x=a.targetData,G=a.lastYearData,M=a.thisYearData,C="",O=[],S=[],k=i.getTemperature().unit,L={"Meter.WattHour":["kWh",m.CHAR[k]],"Meter.Gas":["\u33a5",m.CHAR[k]],"Meter.Water":["(L)",m.CHAR[k]],"Meter.Calori":["",m.CHAR[k]],none:["",""]},I=function(){},B=function(){b.nextBtn.set("click",function(t){z(1);var e=b.formmatedDate;b.set("lastYearDataNum",e-1),c=e,W()}),b.prevBtn.set("click",function(t){z(-1);var e=b.formmatedDate;b.set("lastYearDataNum",e-1),c=e-2,W()}),$("#device-type-list2").on("change",function(t){if(v=$(this).val())b.filters[1].set("disabled",!1),f.open(),$.ajax({url:"/dms/groups?dms_devices_types="+v}).done(function(t){0<t.length?$("#group-list2").data("kendoDropDownList").setOptions({optionLabel:A.ENERGY_ALL_GROUP}):$("#group-list2").data("kendoDropDownList").setOptions({optionLabel:A.COMMON_MENU_FACILITY_GROUP}),t.sort(function(t,e){return t.id-e.id}),b.filters[1].options.set("dataSource",t);var e,a=t.length;for(_=[],e=0;e<a;e++)_.push({text:t[e].name,value:String(t[e].id)})}).fail(function(){}).always(function(){f.close();var t=b.formmatedDate;b.set("lastYearDataNum",t-1);var e=$("#group-list2");e.data("kendoDropDownList").value(""),e.trigger("change")});else{b.filters[1].set("disabled",!0);var e,a=[],o=a.length;for(_=[],e=0;e<o;e++)_.push({text:a[e].name,value:String(a[e].id)});var n=b.formmatedDate;b.set("lastYearDataNum",n-1);var r=$("#group-list2");r.data("kendoDropDownList").value(""),r.trigger("change"),W(),$("#group-list2").data("kendoDropDownList").setOptions({optionLabel:A.COMMON_MENU_FACILITY_GROUP})}}),$("#target-main-view").on("keydown",".target-content-row .input-val",function(t){var e=window.event;110!=e.keyCode&&190!=e.keyCode||(e.returnValue=!1)}),$("#target-main-view").on("keyup",".target-content-row .input-val",function(t){var e,a,o,n,r,i=b.formmatedDate;$('.button_list button[data-action="Save"]').attr("disabled",!1);var l,s=9999999;if(0<$(this).val().indexOf(".")&&$(this).val(Math.trunc($(this).val())),$(this).hasClass("allValue")){var d=Math.abs($(this).val()),c=0;e=$('.target-content-row .input-val:not(".allValue").dimInput'),a=$('.target-content-row .input-val:not(".allValue"):not(".dimInput")'),o=$('.target-content-row .normal-val:not(".allValue"):not(".dimText")'),e.each(function(){c+=Number($(this).val())}),l=0,$('.target-content-row .input-val:not(".allValue")').each(function(){l+=Number($(this).val())}),s<d&&(d=s,D.message(Y.ENERGY_TARGET_LESS),D.open()),n=Math.floor((d-c)/a.length),r=(d-c)%a.length,n<0&&(r=n=0),a.val(n),o.text(n),a.eq(a.length-1).val(n+r),o.eq(a.length-1).text(n+r),$(this).val(d)}else{var u=Math.abs($(this).val()),g=$(".target-content-row .input-val.allValue"),h=$(".target-content-row .normal-val.allValue");l=0,$('.target-content-row .input-val:not(".allValue")').each(function(){l+=Number($(this).val())}),s<l||s<u?(D.message(Y.ENERGY_TARGET_LESS),D.open(),$(this).val(s-(l-u)),g.val(s),h.text(s)):(g.val(Number(l)),h.text(Number(l)))}var p=$('.target-content-row .input-val:not(".allValue")');S={dms_meter_type:v,dms_group_id:C,year:i,target:[]},O={dms_meter_type:v,dms_group_id:C,year:i,target:[]};for(var m=0;m<p.length;m++){var f=Number($('.target-content-row .input-val:not(".allValue")').eq(m).val()),E=$('.target-content-row .input-val:not(".allValue")').eq(m).attr("data-change");x.target||(x.target=[]),x.target[m]={month:m+1,value:f},"true"==E&&(0<S.target?(S.target[m].month=m+1,S.target[m].value=f):S.target.push({month:m+1,value:f})),"false"==E&&(0<S.target?(O.target[m].month=m+1,O.target[m].value=f):O.target.push({month:m+1,value:f}))}T.target=[],T.lastYear=[],T.thisYear=[],x&&(T.target=x.target),T.thisYear.push(M.monthly),T.lastYear.push(G.monthly),function(t){var e,a=0,o=0;if(t.lastYear&&t.lastYear[0])for(e=0;e<t.lastYear[0].length;e++)a+=t.lastYear[0][e].total;if(t.target)for(e=0;e<t.target.length;e++)o+=t.target[e].value;y=100*(1-Number(o)/Number(a)),y=isFinite(y)?y.toFixed(0):0;w.find(".Reduction").html(y)}(T),K(T)});var a='<div class="button_list"><button class="k-button" data-action="Edit">'+A.COMMON_BTN_EDIT+'</button><button class="k-button" data-action="Save" style="display:none;">'+A.COMMON_BTN_SAVE+'</button><button class="k-button" data-action="Cancel" style="display:none;">'+A.COMMON_BTN_CANCEL+"</button></div>";$("#group-list2").on("change",function(t){C=$(this).val(),$(".consumption-tab-target .consumption-tab-top-content .button_list").remove(),C?($(".targetTab01").hide(),$(".targetTab02").show(),$(".consumption-tab-target .consumption-tab-top-content").append(a)):($(".targetTab01").show(),$(".targetTab02").hide()),Q(),$(".button_list button").on("click",function(){var t,e=$(this).attr("data-action"),a=[];if("Edit"==e&&(b.set("actionMode",!1),P(),F()),"Save"==e){H(),V();var o=$(".target-content-row"),n=o.find(".two-line .input-val").val();o.find(".two-line .normal-val").text(n),f.open(),0<O.target.length&&a.push($.ajax({url:"/energy/target/",method:"POST",data:O})),0<S.target.length&&a.push($.ajax({url:"/energy/target/",method:"PATCH",data:S})),$.when.apply(this,a).done(function(){D.message(Y.COMMON_MESSAGE_NOTI_CHANGES_SAVED),D.open(),W()}).fail(function(t){var e=m.parseFailResponse(t);D.message(e),D.open()}).always(function(){t=b.formmatedDate,b.set("lastYearDataNum",t-1),f.close(),b.set("actionMode",!0),W()})}"Cancel"==e&&($('.button_list .k-button[data-action="Save"]').prop("disabled")?(b.set("actionMode",!0),j(),V(),t=b.formmatedDate,b.set("lastYearDataNum",t-1),W()):(R.setConfirmActions({yes:function(){b.set("actionMode",!0),j(),V(),t=b.formmatedDate,b.set("lastYearDataNum",t-1),W()}}),R.message(Y.COMMON_MESSAGE_CONFIRM_CANCEL),R.open()))});var e=b.formmatedDate;b.set("lastYearDataNum",e-1),W()}),b.actions[0].options.set("click",function(t){console.info(t),W()}),b.actions[1].options.set("click",function(t){console.info(t),W()}),b.actions[2].options.set("click",function(t){console.info(t),W()}),$("#main-sidebar-menu .btn-box").off("click",".btn",U).on("click",".btn",U),l.bind("show",function(t){"target"===$(t.item).data("role")&&U()})},U=function(t){var e=$("#targetGraph").data("kendoChart");e&&e.setOptions({chartArea:{width:w.width()}})},F=function(){var t=new Date,e=t.getMonth();$(".target-content-row").find(".input-val").show(),$(".target-content-row").find(".normal-val").hide();var a=t.getFullYear();$(".table-row").find('li:not(".first")').each(function(){$(this).index()<=e&&b.formmatedDate==a?($(this).find(".input-val").attr("disabled",!0).addClass("dimInput"),$(this).find(".normal-val").addClass("dimText")):b.formmatedDate<a&&($(".target-content-row").find(".input-val").attr("disabled",!0).addClass("dimInput"),$(".target-content-row").find(".normal-val").addClass("dimText"))})},V=function(){$(".target-content-row").find(".input-val").hide(),$(".target-content-row").find(".normal-val").show()},P=function(){b.filters[0].set("disabled",!0),b.filters[1].set("disabled",!0),$(".button_list").find('[data-action="Save"]').css({display:"inline-block"}).attr("disabled",!0),$(".button_list").find('[data-action="Edit"]').css({display:"none"}),$(".button_list").find('[data-action="Cancel"]').css({display:"inline-block"}).attr("disabled",!1)},H=function(){$(".button_list").find('[data-action="Save"]').css({display:"none"}).attr("disabled",!0),$(".button_list").find('[data-action="Edit"]').css({display:"inline-block"}).attr("disabled",!1),$(".button_list").find('[data-action="Cancel"]').css({display:"none"}).attr("disabled",!1),b.filters[0].set("disabled",!1),b.filters[1].set("disabled",!1)},j=function(){$(".button_list").find('[data-action="Save"]').css({display:"none"}).attr("disable",!0),$(".button_list").find('[data-action="Edit"]').css({display:"inline-block"}).attr("disable",!0),$(".button_list").find('[data-action="Cancel"]').css({display:"none"}).attr("disable",!1),b.filters[0].set("disabled",!1),b.filters[1].set("disabled",!1)},W=function(t){g=t,v=$("#device-type-list2").val();var e=b.formmatedDate,s=[],d=[],a=[],o="",n="";if(b.filters[1].get("disabled")&&b.actionMode)J([]);else{var c=!1;if(f.open(),g=g||Number(e)-1,C)s.push($.ajax({url:"/energy/consumption?year="+e+"&dms_meter_type="+v+"&dms_group_ids="+C,method:"GET"})),d.push($.ajax({url:"/energy/consumption?year="+g+"&dms_meter_type="+v+"&dms_group_ids="+C,method:"GET"})),a.push($.ajax({url:"/energy/target?year="+e+"&dms_meter_type="+v+"&dms_group_ids="+C,method:"GET"}));else if(v){c=!0,a.push($.ajax({url:"/energy/target/group?year="+e+"&dms_meter_type="+v,method:"GET"}).then(function(t){return t.targetEnergyByMeters&&(t=t.targetEnergyByMeters),t}));for(var r=0;r<_.length;r++)0<r&&(n=","),o+=n+_[r].value;s.push($.ajax({url:"/energy/consumption/group?year="+e+"&dms_meter_type="+v+"&dms_group_ids="+o,method:"GET"})),d.push($.ajax({url:"/energy/consumption/group?year="+g+"&dms_meter_type="+v+"&dms_group_ids="+o,method:"GET"}))}$.when.apply(this,s).done(function(t){M=t}).fail(function(t){var e;e=400==t.status?A.ENERGY_DEVICE_GROUPS_EMPTY:m.parseFailResponse(t),D.message(e),D.open()}).always(function(){$.when.apply(this,d).done(function(t){G=t}).fail(function(t){var e;e=400==t.status?A.ENERGY_DEVICE_GROUPS_EMPTY:m.parseFailResponse(t),D.message(e),D.open()}).always(function(){$.when.apply(this,a).done(function(t){x=t}).fail(function(t){var e;e=400==t.status?A.ENERGY_DEVICE_GROUPS_EMPTY:m.parseFailResponse(t),D.message(e),D.open(),x={}}).always(function(){var t,e;if(x||M||G){if(T.lastYear=[],T.thisYear=[],x&&(T.target=x),c&&x&&$.isArray(x)){var a,o,n,r,i=x.length;for(x.sort(function(t,e){return t.dms_group_id-e.dms_group_id}),t=i-1;0<=t;t--){for(r=(a=x[t]).dms_group_id,n=!1,o=_.length,e=0;e<o;e++)if(_[e].value==r){n=!0;break}n||x.splice(t,1)}for(i=x.length,t=0;t<i;t++)for(o=(a=(a=x[t]).target).length,e=0;e<o;e++)a[e].total=a[e].value;i=T.thisYear.length,o=s.length,x&&(T.target=x)}if(M)for(t=0;t<s.length;t++)T.thisYear.push(M.monthly);if(G)for(t=0;t<d.length;t++)T.lastYear.push(G.monthly);var l=function(t){var e,a,o,n=0,r=0,i=0;N=[];var l,s,d,c,u={},g=new Date,h=g.getMonth()+1,p=g.getFullYear(),m=b.formmatedDate;for(s=0;s<_.length;s++){for(u={},d=r=n=0;d<12;d++)u["lastYear"+d]=0,u["thisYear"+d]=0,u["target"+d]=0;if(t.thisYear&&t.thisYear[0]&&!t.thisYear[0].month)for(c=0;c<t.thisYear[0].length;c++)if(_[s]&&_[s].text==t.thisYear[0][c].dms_group_name&&t.thisYear[0][c].monthly){for(d=n=0;d<t.thisYear[0][c].monthly.length;d++)l=Number(t.thisYear[0][c].monthly[d].month)-1,a=Math.round(t.thisYear[0][c].monthly[d].total),u["thisYear"+l]=tt(a),n+=a;n=tt(n)}if(t.thisYear&&t.thisYear[0]&&t.thisYear[0][0].month)for(d=n=0;d<t.thisYear[0].length;d++)n+=a=(a=Math.round(t.thisYear[0][d].total))||0,u["thisYear"+(t.thisYear[0][d].month-1)]=a;if(t.lastYear&&t.lastYear[0]&&!t.lastYear[0].month)for(c=r=0;c<t.lastYear[0].length;c++)if(_[s]&&_[s].text==t.lastYear[0][c].dms_group_name&&t.lastYear[0][c].monthly)for(d=0;d<t.lastYear[0][c].monthly.length;d++)l=Number(t.lastYear[0][c].monthly[d].month)-1,o=Math.round(t.lastYear[0][c].monthly[d].total),u["lastYear"+l]=tt(o),r+=o;if(t.lastYear&&t.lastYear[0]&&t.lastYear[0][0].month)for(d=r=0;d<t.lastYear[0].length;d++)r+=o=(o=Math.round(t.lastYear[0][d].total))||0,u["lastYear"+(t.lastYear[0][d].month-1)]=o;if(!$("#group-list2").val())for(var f in u)if(-1<f.indexOf("thisYear")){var E=Number(f.split("thisYear")[1]);p==m&&h<=E&&(u[f]=0)}if(t.target&&0<t.target.length&&!t.target[0].value)for(c=i=0;c<t.target.length;c++)if(_[s]&&_[s].value==t.target[c].dms_group_id&&t.target[c].target)for(d=0;d<t.target[c].target.length;d++)l=Number(t.target[c].target[d].month)-1,e=Math.round(t.target[c].target[d].value),p==m&&h-1<t.target[c].target[d].month&&(u["thisYear"+l]=tt(e)),i+=u["target"+(t.target[c].target[d].month-1)]=e;if(t.target&&t.target.target&&0<t.target.target.length)for(d=i=0;d<t.target.target.length;d++)i+=e=(e=Math.round(t.target.target[d].value))||0,u["target"+(t.target.target[d].month-1)]=e;u.thisYearTotal=n,u.lastYearTotal=r,u.targetTotal=i,u.groupName=_[s].text,N.push(u),y=100*(1-Number(i)/Number(r)),y=isFinite(y)?y.toFixed(0):0}return N}(T);J(l),b.actionMode||(P(),F()),Q(),f.close()}})})});var i=0;$(".target-content-row").find("li").each(function(){0==$(this).hasClass("first")&&(i+=Number($(this).find(".normal-val").text()))}),g&&b.set("dateDropBox",g),$(".target-content-row .two-line").find(".normal-val").text(i),$(".target-content-row .two-line").find(".input-val").val(i)}},q='<div class="target-box"><div class=""><div class="target-head"><div class="embossBar"></div><ul class="target-head-list"><li class="first">'+A.ENERGY_TARGET_ENERGY_CONSUMPTION+"</li><li>"+A.ENERGY_DATE_JAN+"</li><li>"+A.ENERGY_DATE_FEB+"</li><li>"+A.ENERGY_DATE_MAR+"</li><li>"+A.ENERGY_DATE_APR+"</li><li>"+A.ENERGY_DATE_MAY+"</li><li>"+A.ENERGY_DATE_JUN+"</li><li>"+A.ENERGY_DATE_JUL+"</li><li>"+A.ENERGY_DATE_AUG+"</li><li>"+A.ENERGY_DATE_SEP+"</li><li>"+A.ENERGY_DATE_OCT+"</li><li>"+A.ENERGY_DATE_NOV+"</li><li>"+A.ENERGY_DATE_DEC+'</li></ul></div><div id="target-content" class="target-content-row"></div></div></div>',X='<div class="target-box"><div class="target-title"></div><div class=""><div class="target-head"><div class="embossBar"></div><ul class="target-head-list"><li class="first"></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div><div id="target-content"><div class="target-content-row"><ul class="table-row bg-color"><li class="first"></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div></div></div></div>',J=function(t){var r=b.formmatedDate;$(".targetTab01").empty(),$(".targetTab02").empty();var i=t,e=new h.data.DataSource({data:t});0==$("#target-main-view").hasClass("made")&&$("#target-main-view").append('<div class="targetTab01"></div><div class="targetTab02"></div>').addClass("made"),$(".targetTab01").append(q);var a=$("#device-type-list2").val(),l=L[a=a||"none"][0];0<i.length&&($(".targetTab01 #target-content").kendoListView({dataSource:e,selectable:"multiple",template:h.template(E)}),$(".targetTab01 #target-content").find(".first .unit").html(l),$(".target-content-row").find(".last-year-view").text(A.ENERGY_ENERGY_CONSUMPTION_OF+" "+(r-1)));var o=$(X),n=$(X),s=[A.ENERGY_DATE_JAN,A.ENERGY_DATE_FEB,A.ENERGY_DATE_MAR,A.ENERGY_DATE_APR,A.ENERGY_DATE_MAY,A.ENERGY_DATE_JUN,A.ENERGY_DATE_JUL,A.ENERGY_DATE_AUG,A.ENERGY_DATE_SEP,A.ENERGY_DATE_OCT,A.ENERGY_DATE_NOV,A.ENERGY_DATE_DEC];o.find(".target-title").text(A.ENERGY_TARGET_ENERGY_CONSUMPTION),o.find(".target-head .target-head-list li").each(function(){var t=$(this).index();$(this).html(s[t-1])}),o.find(".target-content-row .table-row li").each(function(){var t,e,a,o=$(this).index();t=i[0]?i[0].targetTotal:0;var n='<div class="left">'+r+'</div><div class="right"><div class="two-line"><span class="num normal-val allValue">'+tt(t)+'</span><input type="number" class="k-input input-val allValue" value="'+t+'"><span>'+l+'<span></div><div class="two-line"><span class="Reduction">'+y+"</span>% "+A.ENERGY_REDUCTION+"</div></div>";$(this).hasClass("first")?$(this).html(n):(a=i[0]&&i[0]["target"+(o-1)]?(e=i[0]["target"+(o-1)],!0):(e=0,!1),$(this).html('<span class="normal-val"  data-change="'+a+'">'+tt(e)+'</span><input type="number" data-change="'+a+'" class="k-input input-val" value="'+e+'">'))}),n.find(".target-title").text(A.ENERGY_ENERGY_CONSUMPTION),n.find(".target-head .target-head-list li").each(function(){var t,e=$(this).index(),a='<div class="left"><input class="yearSelect"></div><div class="right"><div class="normal-box"><span class="num">'+tt(i[0]?i[0].lastYearTotal:0)+"</span><span>"+l+"</span></div></div>";d=b.formmatedDate,$(this).hasClass("first")?($(this).html(a),(u=$(this).find(".yearSelect").kendoDropDownList({dataValueField:"value",dataTextField:"text",animation:!1,dataSource:[{text:d-1,value:d-1},{text:d-2,value:d-2},{text:d-3,value:d-3},{text:d-4,value:d-4},{text:d-5,value:d-5},{text:d-6,value:d-6},{text:d-7,value:d-7},{text:d-8,value:d-8},{text:d-9,value:d-9},{text:d-10,value:d-10}]}).data("kendoDropDownList")).search(c),u._old=String(c),$(this).find("input.yearSelect").on("change",function(){var t=$(this).val();b.set("dateDropBox",t),$(".graphTopBox ul li").find(".text").text(c+" Consumption"),W(c=t)})):(t=i[0]&&i[0]["lastYear"+(e-1)]?i[0]["lastYear"+(e-1)]:0,$(this).html(tt(t))),0==b.filters[1].get("disabled")&&f.close(),Q()}),n.find(".target-content-row .table-row li").each(function(){var t,e,a=$(this).index();if($(this).hasClass("first")){t=i[0]&&i[0].thisYearTotal?i[0].thisYearTotal:0;var o='<div class="left">'+r+'</div><div class="right"><div><span class="num">'+tt(t)+"</span><span>"+l+"<span></div></div>";$(this).html(o)}else i[0]&&i[0]["thisYear"+(a-1)]?(e=i[0]["thisYear"+(a-1)],i[0]&&"number"==typeof i[0]["target"+(a-1)]&&(e=e>i[0]["target"+(a-1)]?'<span class="targetColor01">'+tt(e)+"</span>":e<i[0]["target"+(a-1)]?'<span class="targetColor02">'+tt(e)+"</span>":'<span class="targetColor03">'+tt(e)+"</span>")):i[e=0]&&i[0]["target"+(a-1)]&&(e=e>i[0]["target"+(a-1)]?'<span class="targetColor01">'+e+"</span>":e<i[0]["target"+(a-1)]?'<span class="targetColor02">'+e+"</span>":'<span class="targetColor03">'+e+"</span>"),$(this).html(e)}),$(".targetTab02").append(o),$(".targetTab02").append(n),$(".targetTab02").append('<div id="targetGraph"></div>'),!G||Object.keys(G).length<1?$(".target-content-row").find(".Reduction").closest(".two-line").hide():$(".target-content-row").find(".Reduction").closest(".two-line").show(),K(T)},Q=function(){var t,e,a,o=[b.formmatedDate],n=new Date,r={year:n.getFullYear()},i={year:n.getFullYear()};String(i.month).length<2&&(i.month="0"+i.month),String(i.day).length<2&&(i.day="0"+i.day),t=Number(o[0]),a=r.year,e=Number(String(i.year)),Number(t)!=e||C?Number(t)>e&&!C?(b.nextBtn.set("disabled",!0),b.set("formmatedDate",a),b.set("setDateView",a)):b.nextBtn.set("disabled",!1):b.nextBtn.set("disabled",!0)},z=function(t){var e;e=b.formmatedDate+t,b.set("formmatedDate",e)},K=function(t){var e=b.formmatedDate,a={};a.target=t.target,a.target&&a.target.target&&(a.target=a.target.target);var o,n,r=[],i=[],l=[],s=0;for(o=0;o<12;o++)r.push(null),i.push(null),l.push(null);for(n=0;n<12;n++)a.target&&a.target[n]&&s<a.target[n].value&&(s=a.target[n].value),t.lastYear&&t.lastYear[0]&&t.lastYear[0][n]&&s<t.lastYear[0][n].total&&(s=t.lastYear[0][n].total),t.thisYear&&t.thisYear[0]&&t.thisYear[0][n]&&s<t.thisYear[0][n].total&&(s=t.thisYear[0][n].total);if(s?s*=1.2:s=1,t.thisYear[0])for(n=0;n<t.thisYear[0].length;n++)r[Number(t.thisYear[0][n].month)-1]=t.thisYear[0][n].total;if(t.lastYear[0])for(n=0;n<t.lastYear[0].length;n++)i[Number(t.lastYear[0][n].month)-1]=t.lastYear[0][n].total;if(t.target&&t.target.target&&t.target.target.length)for(n=0;n<t.target.target.length;n++)l[Number(t.target.target[n].month)-1]=t.target.target[n].value;if(t.target&&0<t.target.length)for(n=0;n<t.target.length;n++)l[Number(t.target[n].month)-1]=t.target[n].value;for(o=0;o<12;o++);a.thisYear=r,a.lastYear=i,a.target=l;var d;d=p().localeData().monthsShort(),$("#targetGraph").empty(),$("#targetGraph").kendoChart({axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:470,width:w.width()},plotArea:{background:"#ebebeb"},legend:{visible:!1},xAxis:{border:{color:"#444"}},series:[{type:"column",data:a.lastYear,stack:"beforeYear",name:"beforeYear",color:"#B5B5B5"},{type:"column",data:a.thisYear,stack:"thisYear",name:"thisYear",color:"#0081c6"},{type:"column",data:a.target,stack:"target",name:"target",color:"#99cde8"}],valueAxes:{name:"kWh",min:0,max:m.getChartOptionsForFiveChartSection(s,0).newMax,majorGridLines:{visible:!1},majorUnit:m.getChartOptionsForFiveChartSection(s,0).newMajorUnit},categoryAxis:{categories:d,axisCrossingValues:[0,0,100,100]}}),$("#targetGraph").prepend(Z);var c=$("#device-type-list2").val();c=c||"none",$(".graphTopBox").find(".left .graph-unit").html(L[c][0]),g=g||Number(e)-1,$("#targetGraph").find(".graphTopBox ul li").eq(0).find(".text").text(g+" "+A.COMMON_MENU_ENERGY_CONSUMPTION),$("#targetGraph").find(".graphTopBox ul li").eq(1).find(".text").text(e+" "+A.COMMON_MENU_ENERGY_CONSUMPTION),$("#targetGraph").find(".graphTopBox ul li").eq(2).find(".text").text(e+" "+A.ENERGY_AMOUNT_TARGET)},Z='<div class="graphTopBox"><div class="left"><span class="graph-unit"></span></div><div class="right"><ul><li><span class="square" style="background-color:#B5B5B5"></span><span class="text">'+A.COMMON_MENU_ENERGY_CONSUMPTION+'</span></li><li><span class="square" style="background-color:#0081c6"></span> <span class="text">'+A.COMMON_MENU_ENERGY_CONSUMPTION+'</span></li><li><span class="square" style="background-color:#99cde8"></span> <span class="text">'+A.ENERGY_AMOUNT_TARGET+"</span></li></ul></div></div>";function tt(t){return void 0===t?t:("number"==typeof t&&(t=t.toString()),t.replace(/\B(?=(\d{3})+(?!\d))/g,","))}return{init:function(t){l=t,I();var e=l.contentElement(2),a=(new Date).getFullYear();b.set("formmatedDate",a),b.set("lastYearData",a-1),c=a-1,h.bind($(e),b);var o=[],n=$("#device-type-list2").data("kendoDropDownList");v=n.value(),b.filters[1].options.set("dataSource",o);var r,i=o.length;for(_=[],r=0;r<i;r++)_.push({text:o[r].name,value:String(o[r].id)});for(T.target=[],T.lastYear=[],T.thisYear=[],T.target=x.target,r=0;r<_.length;r++)T.lastYear.push(G.monthly),T.thisYear.push(M.monthly);B(),b.filters[1].set("disabled",!0),b.nextBtn.set("disabled",!0),W()}}}),define("energy/consumptionandtarget/consumption",["energy/core","energy/consumptionandtarget/view-model/consumption-vm","energy/consumptionandtarget/model/consumption-model","energy/consumptionandtarget/template/consumption-template","energy/consumptionandtarget/common/common","energy/consumptionandtarget/common/widget","energy/consumptionandtarget/comparison","energy/consumptionandtarget/target"],function(a,t,r,f,x,s,e,o){function E(t){var e="?";return(t=t||d.getCurrentFloor()).building.id!=d.FLOOR_NAV_BUILDING_TOTAL_ID&&(e+="foundation_space_buildings_id="+t.building.id+"&"),t.floor.id!=d.FLOOR_NAV_FLOOR_ALL_ID&&(e+="foundation_space_floors_id="+t.floor.id),e}var n,v,y,G=window.moment,_=window.kendo,i=window.GlobalSettings,l=window.CommonLoadingPanel,M=window.Util,b=window.I18N,d=window.MAIN_WINDOW,T=new l,C=t.MainViewModel,N=t.Views,w=t.typeFilterDataSource,O=x.TEXT,c=new _.Router,u=new _.Layout("<div id='consumption-main-view-content' class='consumption-main-view-content'></div>",{wrap:!1}),g=$("#consumption-main-view"),h=$("#consumption-common-tab"),D=s.msgDialog,S=!1,R=i.getTemperature().unit,Y={"Meter.WattHour":["(kWh)","("+M.CHAR[R]+")"],"Meter.Gas":["(\u33a5)","("+M.CHAR[R]+")"],"Meter.Water":["(L)","("+M.CHAR[R]+")"],"Meter.Calori":["","("+M.CHAR[R]+")"],none:["",""]},k={"Meter.WattHour":O.ENERGY_METER_TYPE_WATTHOUR,"Meter.Gas":O.ENERGY_METER_TYPE_GAS,"Meter.Water":O.ENERGY_METER_TYPE_WATER,"Meter.Calori":"",none:""},L={normal:"#0081c6",warning:"#ea0303"},I={normal:"#4ca7d7",warning:"#f47c7c"},B={normal:"#99cde8",warning:"#fbcdcd"},p=function(t){var e=E(t);Q(e)},m=function(){n=h.kendoCommonTabStrip().data("kendoCommonTabStrip"),o.init(n),e.init(n)},A=function(){c.bind("init",U);var t,e=C.formattedDate.split("-"),a=r.createDataSource(r.modelData),o=[],n=[];N.graph.widget=Z(a,o,n),N.graph.view=new _.View(N.graph.widget.wrapper,{wrap:!1}),c.route(N.graph.routeUrl,F.bind(c,N.graph.view)),a=r.createDataSource(r.modelData),3==e.length&&(t="hourly"),2==e.length&&(t="daily"),1==e.length&&(t="monthly"),N.list.widget=et(a[t],o,n),N.list.view=new _.View(N.list.widget.wrapper,{wrap:!1}),c.route(N.list.routeUrl,F.bind(c,N.list.view)),c.start(),C.dayBtn.set("active",!0)},U=function(){u.render(g)},F=function(t){u.showIn("#consumption-main-view-content",t)},V=function(){C.set("setDateView",G().format(C.formattedDate)),n.bind("activate",P),C.graphBtn.set("click",function(t){if(1!=C.graphBtn.get("active")){H(),Q(),$(".energy-consumption-graphTopBox").remove(),$("#consumption-main-view-content").prepend(tt);var e=$("#device-type-list").val();e=e||"none",$(".energy-consumption-graphTopBox").find(".right .graph-unit").html(Y[e][1]),$(".energy-consumption-graphTopBox").find(".left .graph-unit").html(Y[e][0]),C.dayBtn.active&&$(".energy-consumption-graphTopBox").find(".checkLabel").hide()}}),C.listBtn.set("click",function(){1!=C.listBtn.get("active")&&($(".energy-consumption-graphTopBox").remove(),j(),Q())}),$("#consumption-main-view").on("click","#targetEnergy",function(){var t=$(this).prop("checked");S=!t,Q()}),C.dayBtn.set("click",function(t){C.monthBtn.set("active",!1),C.yearBtn.set("active",!1),1!=C.monthBtn.get("active")&&(C.set("formattedDate",G().format(W("day"))),C.dayBtn.set("active",!0),q(),Q())}),C.exportBtn.set("click",function(t){$(N.list.widget.wrapper).find(".k-grid-excel").trigger("click")}),C.monthBtn.set("click",function(t){C.dayBtn.set("active",!1),C.yearBtn.set("active",!1),1!=C.monthBtn.get("active")&&(C.monthBtn.set("active",!0),C.set("formattedDate",G().format(W("month"))),q(),Q())}),C.yearBtn.set("click",function(t){C.dayBtn.set("active",!1),C.monthBtn.set("active",!1),1!=C.yearBtn.get("active")&&(C.set("formattedDate",G().format(W("year"))),C.yearBtn.set("active",!0),q(),Q())}),C.nextBtn.set("click",function(t){var e=J(C.formattedDate,1);C.set("formattedDate",G().format(e)),X(),Q(),q()}),C.prevBtn.set("click",function(t){var e=J(C.formattedDate,-1);C.set("formattedDate",G().format(e)),X(),Q(),q()}),$("#main-sidebar-menu").find(".btn-util").on("click",".btn",function(t){0!=g.width()&&N.graph.widget.setOptions({chartArea:{width:g.width()}})}),$("#device-type-list").on("change",function(t){v=$(this).val();var e=$("#group-list"),a=[];v?(C.filters[1].set("disabled",!1),T.open(),$.ajax({url:"/dms/groups?dms_devices_types="+v}).done(function(t){a=t}).fail(function(){}).always(function(){T.close(),C.filters[1].options.set("dataSource",a),0<a.length?($("#group-list").data("kendoDropDownCheckBox").selectAll(),$("#group-list").data("kendoDropDownCheckBox").options.showSelectAll=!0):($("#group-list").data("kendoDropDownCheckBox").unselectAll(),$("#group-list").data("kendoDropDownCheckBox").options.showSelectAll=!1),e.trigger("change");var t=$("#device-type-list").val();t=t||"none",$(".energy-consumption-graphTopBox").find(".right .graph-unit").html(Y[t][1]),$(".energy-consumption-graphTopBox").find(".left .graph-unit").html(Y[t][0]),Q()})):(C.filters[1].set("disabled",!0),e.val(""),e.trigger("change"),Q())}),$("#group-list").on("change",function(t){y=$(this).val(),Q()}),T.close()},P=function(t){"consumption-common-tab-1"==$(t.contentElement).prop("id")&&N.graph.widget.setOptions({chartArea:{width:g.width()}})},H=function(t){C.graphBtn.set("active",!0),C.listBtn.set("active",!1),c.navigate(N.graph.routeUrl)},j=function(t){C.listBtn.set("active",!0),C.graphBtn.set("active",!1),c.navigate(N.list.routeUrl)},W=function(t){var e="",a=C.setDateView.split("-"),o=G().format("DD");return"year"==t&&(e=a[0]),"month"==t&&(e=a[0]+"-"+a[1]),"day"==t&&(e=a[0]+"-"+a[1]+"-"+o,G(e).isValid()||(o=G(a[0]+"-"+a[1]).daysInMonth(),e=a[0]+"-"+a[1]+"-"+o)),e},q=function(){var t,e,a,o,n,r,i=C.formattedDate.split("-"),l=new Date,s=i.length,d={year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()},c={year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()};String(c.month).length<2&&(c.month="0"+c.month),String(c.day).length<2&&(c.day="0"+c.day);var u=C.get("setDateView"),g=null;1<=s&&(t=Number(i[0]),r=d.year,o=Number(String(c.year)),Number(t)==o?C.nextBtn.set("disabled",!0):Number(t)>o?(C.nextBtn.set("disabled",!0),C.set("formattedDate",r),C.set("setDateView",r)):C.nextBtn.set("disabled",!1)),2<=s&&(r=d.year+"-"+(1<String(d.month).length?d.month:"0"+d.month),e=Number(i[1]),String(e).length<2&&(e="0"+e),o=Number(String(c.year)+String(c.month)),(n=Number(String(t)+String(e)))==o?C.nextBtn.set("disabled",!0):o<=n?(C.nextBtn.set("disabled",!0),C.set("formattedDate",r),g=u.split("-")[2],C.set("setDateView",r+"-"+g)):C.nextBtn.set("disabled",!1)),3<=s&&(r=d.year+"-"+(1<String(d.month).length?d.month:"0"+d.month)+"-"+d.day,a=Number(i[2]),String(a).length<2&&(a="0"+a),o=Number(String(c.year)+String(c.month)+String(c.day)),(n=Number(String(t)+String(e)+String(a)))==o?C.nextBtn.set("disabled",!0):o<=n?(C.nextBtn.set("disabled",!0),C.set("formattedDate",r),C.set("setDateView",r)):C.nextBtn.set("disabled",!1))},X=function(){var t,e=C.formattedDate.split("-"),a=C.setDateView.split("-");1<=e.length&&(a[0]=e[0]),2<=e.length&&(a[1]=e[1]),3<=e.length&&(a[2]=e[2]),t=a[0]+"-"+a[1]+"-"+a[2],C.set("setDateView",G().format(t))},J=function(t,e){var a,o,n,r,i,l,s,d,c=t.split("-"),u=c.length;if(s=["01","02","03","04","05","06","07","08","09","10","11","12"],1<=u&&(a=Number(c[0]),r="year"),2<=u&&(r="month",d=g(a,o=Number(c[1]))),3<=u&&(n=Number(c[2]),r="day"),"year"==r)return a+=e,String(a);if("month"==r)return s.length<(o+=e)||o<=0?a+e+"-"+(i=0<o?s[0]:s[11]):a+"-"+s[o-1];if("day"==r)return(n+=e)>d.length||n<=0?0<n?s.length<(o+=e)||o<=0?(d=0<o?(i=s[0],g(a+e,1)):(i=s[11],g(a+e,12)),a+e+"-"+i+"-"+(l=d[0])):(l=(d=g(a,o))[0],a+"-"+s[o-1]+"-"+l):(l=d[d.length-1],s.length<(o+=e)||o<=0?(d=0<o?(i=s[0],g(a+e,1)):(i=s[11],g(a+e,12)),a+e+"-"+i+"-"+(l=d[d.length-1])):(l=(d=g(a,o))[d.length-1],a+"-"+s[o-1]+"-"+l)):a+"-"+s[o-1]+"-"+d[n-1];function g(t,e){for(var a=new Date(t,e,0).getDate(),o=[],n=1;n<=a;n++)1==String(n).length?o.push("0"+n):o.push(n);return o}},Q=function(t){var e;t=t||E();var a,o,n,r,i,l,s,d,c="",u=$("#device-type-list").val(),g=Y[u]?" "+Y[u][0]:"",h=Y[u]?" "+Y[u][1]:"",p=C.formattedDate.split("-");if(3==p.length&&(s="hourly"),2==p.length&&(s="daily"),1==p.length&&(s="monthly"),3==p.length&&(d="hour"),2==p.length&&(d="day"),1==p.length&&(d="month"),l=C.dayBtn.active?[{field:d,title:O.COMMON_TIME,footerTemplate:O.COMMON_TIME,footerAttributes:{class:"table-footer-cell1"},attributes:{"data-name":"month"},width:100,format:"",editable:!1,template:f.time},{field:"degree",title:"Fahrenheit"==R?b.prop("ENERGY_OUTDOOR_TEMPERATURE_FAHRENHEIT"):b.prop("ENERGY_OUTDOOR_TEMPERATURE_CELSIUS"),footerTemplate:f.temperatureAverage,footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"temperature"},width:100,format:"",editable:!1,template:f.temperature},{field:"total",title:O.ENERGY_GIRD_TOTAL+g,footerTemplate:f.totalSum,footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"total"},width:100,format:"",editable:!1,template:f.total},{field:"sac",title:O.ENERGY_SAC+g,footerTemplate:f.sacSum,footerAttributes:{class:"table-footer-cell3"},attributes:{"data-name":"sac"},width:100,format:"",editable:!1,template:f.sac},{field:"light",title:O.ENERGY_LIGHT+g,footerTemplate:f.lightSum,footerAttributes:{class:"table-footer-cell4"},attributes:{"data-name":"light"},width:100,format:"",editable:!1,template:f.light},{field:"others",title:O.ENERGY_OTHERS+g,footerTemplate:f.othersSum,footerAttributes:{class:"table-footer-cell5"},attributes:{"data-name":"others"},width:100,format:"",editable:!1,template:f.others}]:[{field:d,title:O.COMMON_TIME,footerTemplate:O.COMMON_TIME,footerAttributes:{class:"table-footer-cell1"},attributes:{"data-name":"month"},width:100,format:"",editable:!1,template:f.time},{field:"degree",title:"Fahrenheit"==R?b.prop("ENERGY_OUTDOOR_TEMPERATURE_FAHRENHEIT"):b.prop("ENERGY_OUTDOOR_TEMPERATURE_CELSIUS"),footerTemplate:f.temperatureAverage,footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"temperature"},width:100,format:"",editable:!1,template:f.temperature},{field:"target",title:O.ENERGY_TARGET_ENERGY+g,footerTemplate:f.targetSum,footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"temperature"},width:100,format:"",editable:!1,template:f.target},{field:"total",title:O.ENERGY_GIRD_TOTAL+g,footerTemplate:f.totalSum,footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"total"},width:100,format:"",editable:!1,template:f.total},{field:"sac",title:O.ENERGY_SAC+g,footerTemplate:f.sacSum,footerAttributes:{class:"table-footer-cell3"},attributes:{"data-name":"sac"},width:100,format:"",editable:!1,template:f.sac},{field:"light",title:O.ENERGY_LIGHT+g,footerTemplate:f.lightSum,footerAttributes:{class:"table-footer-cell4"},attributes:{"data-name":"light"},width:100,format:"",editable:!1,template:f.light},{field:"others",title:O.ENERGY_OTHERS+g,footerTemplate:f.othersSum,footerAttributes:{class:"table-footer-cell5"},attributes:{"data-name":"others"},width:100,format:"",editable:!1,template:f.others}],!$("#device-type-list").val()||!$("#group-list").val())return n={},$("#device-type-list").val()||(o={},a={}),S&&(a={}),(i=z(n,o,a))[s]||(i[s]=[]),N.list.widget.setOptions({columns:l,dataSource:i[s],height:"100%",scrollable:!0,groupable:!1,sortable:!0,filterable:!1,pageable:!1,hasCheckedModel:!1,excel:{allPages:!0},setCheckedAttribute:!1}),r=K(n,o,a),void N.graph.widget.setOptions({selectionTooltip:{rowTemplate:function(t){var e={groupName:"",content:"",priority:0};if("temperature"!=t.series.name&&(null===t.data.value||void 0===t.data.value))return null;switch("temperature"!=t.series.name&&(t.data.value=_.toString(t.data.value,"n1")),t.series.name){case"temperature":e.content="<span class='energy-consumption-graph-tooltip-legend-line'><em class='energy-consumption-graph-tooltip-legend-circle'></em></span><span class='energy-consumption-graph-tooltip-content-name'>"+b.prop("FACILITY_DEVICE_OUTDOOR_TEMPERATURE")+"</span><span class='energy-consumption-graph-tooltip-content-data'>"+t.data+h+"</span>";break;case"SAC":e.content="<span class='energy-consumption-graph-tooltip-legend-square' style='background-color:"+t.data.valueColor+"'></span><span class='energy-consumption-graph-tooltip-content-name'>"+b.prop("ENERGY_SAC")+"</span><span class='energy-consumption-graph-tooltip-content-data'>"+t.data.value+g+"</span>";break;case"Light":e.content="<span class='energy-consumption-graph-tooltip-legend-square' style='background-color:"+t.data.valueColor+"'></span><span class='energy-consumption-graph-tooltip-content-name'>"+b.prop("ENERGY_LIGHT")+"</span><span class='energy-consumption-graph-tooltip-content-data'>"+t.data.value+g+"</span>";break;case"Others":e.content="<span class='energy-consumption-graph-tooltip-legend-square' style='background-color:"+t.data.valueColor+"'></span><span class='energy-consumption-graph-tooltip-content-name'>"+b.prop("ENERGY_OTHERS")+"</span><span class='energy-consumption-graph-tooltip-content-data'>"+t.data.value+g+"</span>";break;default:e.content="",e.priority=0,e.groupName=""}return e}},axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:$("#consumption-main-view-content").height()-34,width:$("#consumption-main-view").width()},plotArea:{border:{},background:"#f7f7f8"},legend:{visible:!1},xAxis:{border:{color:"#444"}},series:r.setSeries,valueAxes:r.setValueAxes,categoryAxis:{categories:r.categories,axisCrossingValues:[0,0,100,100],select:!1}});if(1==p.length?(s="monthly",e="year="+p[0]):2==p.length?(s="daily",e="year="+p[0]+"&month="+Number(p[1])):3==p.length&&(s="hourly",e="year="+p[0]+"&month="+Number(p[1])+"&day="+Number(p[2])),!v){v=c="";for(var m=0;m<w.length;m++)0<m&&(c=","),v=v+c+w[m].value}y=y||$("#group-list").val(),T.open(),$.ajax({url:"/energy/target/?year="+p[0]+"&dms_meter_type="+v+"&dms_group_ids="+y}).done(function(t){t||(a=[]),a=t}).fail(function(t){500==t.statusCode().status&&T.close()}).always(function(){$.ajax({url:"/energy/temperature?"+e}).done(function(t){t||(o=[]),o=t}).fail(function(t){var e=M.parseFailResponse(t);D.message(e),D.open()}).always(function(){y?$.ajax({url:"/energy/consumption?"+e+"&dms_meter_type="+v+"&dms_group_ids="+y}).done(function(t){t||(n=[]),n=t}).fail(function(t){var e=M.parseFailResponse(t);D.message(e),D.open()}).always(function(){$(".energy-consumption-graphTopBox").remove(),r=K(n,o,a),i=z(n,o,a),N.graph.widget.setOptions({axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:$("#consumption-main-view-content").height()-34,width:$("#consumption-main-view").width()},plotArea:{border:{},background:"#f7f7f8"},legend:{visible:!1},xAxis:{border:{color:"#444"}},series:r.setSeries,valueAxes:r.setValueAxes,categoryAxis:{categories:r.categories,axisCrossingValues:[0,0,100,100],select:!1}}),i[s]||(i[s]=[]),N.list.widget.setOptions({columns:l,dataSource:{data:i[s],aggregate:ot},height:"100%",scrollable:!0,groupable:!1,sortable:!0,filterable:!1,pageable:!1,hasCheckedModel:!1,excel:{allPages:!0},setCheckedAttribute:!1}),N.graph.widget.dataSource.sync(),N.list.widget.dataSource.sync(),$("#consumption-chart").hasClass("k-chart")&&($("#consumption-main-view-content").prepend(tt),u=(u=$("#device-type-list").val())||"none",$(".energy-consumption-graphTopBox").find(".left .graph-unit").html(Y[u][0]),$(".energy-consumption-graphTopBox").find(".right .graph-unit").html(Y[u][1])),S&&$(".energy-consumption-graphTopBox").find("#targetEnergy").prop("checked",!1),C.dayBtn.active&&$(".energy-consumption-graphTopBox").find(".checkLabel").hide(),$('path[stroke-linecap="butt"]').css({transform:" translateY(-1px)"}),T.close()}):T.close()})})},z=function(t,e,a){var o,n,r,i,l,s,d,c={},u=C.formattedDate.split("-");for(3==u.length&&(r="hourly",n="hour",o=24),2==u.length&&(r="daily",n="day",o=function(t,e){for(var a=new Date(t,e,0).getDate(),o=[],n=1;n<=a;n++)1==String(n).length?o.push("0"+n):o.push(n);return o}(u[0],u[1]).length),1==u.length&&(r="monthly",n="month",o=12),c=t,(c={})[r]=[],l=0;l<o;l++){if((i={degree:null,light:null,others:null,sac:null,total:null,target:null})[n]=null,e&&e[r])for(s=0;s<e[r].length;s++)"hourly"==r&&l==e[r][s][n]&&(i[n]=l,i.degree=e[r][s].degree),"hourly"!==r&&l==e[r][s][n]-1&&(i[n]=l+1,i.degree=e[r][s].degree);if(a&&a.target&&"hourly"!==r)if("daily"==r)for(d=0;d<a.target.length;d++)a.target[d].month==Number(u[1])&&(i[n]=l+1,i.target=a.target[d].value/o);else for(d=0;d<a.target.length;d++)"hourly"!==r&&l==a.target[d].month-1&&(i[n]=l+1,i.target=a.target[d].value);if(t&&t[r])for(d=0;d<t[r].length;d++)"hourly"==r&&l==t[r][d][n]&&(i[n]=l,i.light=t[r][d].light,i.others=t[r][d].others,i.sac=t[r][d].sac,i.total=t[r][d].total),"hourly"!==r&&l==t[r][d][n]-1&&(i[n]=l+1,i.light=t[r][d].light,i.others=t[r][d].others,i.sac=t[r][d].sac,i.total=t[r][d].total);if(0==i[n]||i[n]){var g={};g[n]=i[n],g.degree=i.degree,g.target=i.target,g.light=i.light,g.others=i.others,g.sac=i.sac,g.total=i.total,c[r].push(g)}}return c},K=function(t,e,a){var o,n,r,i,l,s={},d=C.formattedDate.split("-"),c=[],u="",g=0,h=0;i=!(!t||t.length<1)&&t,e=!(!e||e.length<1)&&e,a=!(!a||a.length<1)&&a;var p,m,f,E,v,y,_={temperatureList:[],totalList:[],sacList:[],lightList:[],othersList:[]};for(3==d.length&&(o="hourly",n="hour",r=x.getChartXAxisLabel("day"),u=1e3),2==d.length&&(o="daily",n="day",r=function(t,e){for(var a=new Date(t,e,0),o=a.getDate(),n=[],r=1;r<=o;r++)n.push(G(a.setDate(r)).format("Do"));return n}(d[0],d[1]),a&&a.max&&(g=a.max/r.length*1.2)),1==d.length&&(o="monthly",n="month",r=G().localeData().monthsShort(),a&&a.max&&(g=1.2*a.max)),_.totalList=[],_.sacList=[],_.lightList=[],_.othersList=[],_.targetList=[],s.sacListColor=[],s.lightListColor=[],s.othersListColor=[],i&&i.max&&(h=1.2*i.max),u=h<g?g:g<h?h:h==g?h:500,p=0;p<r.length;p++)_.totalList.push(null),_.sacList.push({value:null,valueColor:L.normal}),_.lightList.push({value:null,valueColor:I.normal}),_.othersList.push({value:null,valueColor:B.normal}),_.temperatureList.push(null),_.targetList.push(null);if(i[o]&&0<i[o].length)for(f=0;f<i[o].length;f++)if(y=Number(i[o][f][n]),"hourly"==o)_.totalList[y]=i[o][f].total,_.sacList[y].value=i[o][f].sac,_.lightList[y].value=i[o][f].light,_.othersList[y].value=i[o][f].others;else{_.totalList[y-1]=i[o][f].total,_.sacList[y-1].value=i[o][f].sac,_.lightList[y-1].value=i[o][f].light,_.othersList[y-1].value=i[o][f].others;var b=null;if(a&&a.target){for(E=0;E<a.target.length;E++)if((v=a.target[E]).month==Number(d[1])){b=v.value;break}}else a={target:[]};if(a&&"daily"==o&&0<Object.keys(a).length&&b&&(l=Number((b/r.length).toFixed(1)),i[o][f]&&l)){var T=i[o][f][n]-1;l<i[o][f].total&&(_.sacList[T].valueColor=L.warning,_.lightList[T].valueColor=I.warning,_.othersList[T].valueColor=B.warning)}if(a&&"monthly"==o&&0<Object.keys(a).length)for(var N=0;N<a.target.length;N++){if(a.target[N].month==y){var w=a.target[N].month-1;a.target[N].value<i[o][f].total&&0!==a.target[N].value&&(_.sacList[w].valueColor=L.warning,_.lightList[w].valueColor=I.warning,_.othersList[w].valueColor=B.warning)}}}if(a&&"daily"==o&&0<Object.keys(a).length){var D;for(E=0;E<a.target.length;E++)if((v=a.target[E]).month==Number(d[1])){D=E;break}if(a.target[D]){for(l=Number((a.target[D].value/r.length).toFixed(1)),m=0;m<r.length;m++)_.targetList[m]={open:l,high:l,low:l,close:l};S&&(_.targetList=[])}}if(a&&"monthly"==o&&0<Object.keys(a).length){for(m=0;m<a.target.length;m++)_.targetList[a.target[m].month-1]={open:a.target[m].value,high:a.target[m].value,low:a.target[m].value,close:a.target[m].value};S&&(_.targetList=[])}if(e[o]&&0<e[o].length)for(f=0;f<e[o].length;f++)y=Number(e[o][f][n]),"hourly"==o?_.temperatureList[y]=e[o][f].degree:_.temperatureList[y-1]=e[o][f].degree;var R,Y,A=Object.keys(_);for(m=0;m<A.length;m++)"temperatureList"==A[m]&&c.push({type:"line",missingValues:"gap",data:_.temperatureList,name:"temperature",color:"#888",axis:"temperature",markers:{size:6,background:"#808080",border:{width:0,color:"#808080"},highlight:{line:{width:0}}}}),"othersList"==A[m]&&c.push({type:"column",data:_.othersList,stack:"time",name:"Others",colorField:"valueColor"}),"sacList"==A[m]&&c.push({type:"column",data:_.sacList,stack:"time",name:"SAC",colorField:"valueColor"}),"lightList"==A[m]&&c.push({type:"column",data:_.lightList,stack:"time",name:"Light",colorField:"valueColor"}),"targetList"==A[m]&&c.push({type:"ohlc",data:_.targetList,color:"#ee392f",gap:0,highlight:{line:{width:1}},zIndex:10});return{setSeries:c,setValueAxes:[{name:"kWh",min:0,max:M.getChartOptionsForFiveChartSection(u,0).newMax,majorGridLines:{visible:!1},majorUnit:M.getChartOptionsForFiveChartSection(u,0).newMajorUnit,labels:{template:function(t){return 1<t.value?Math.floor(t.value):t.value}}},{majorGridLines:{visible:!1},visible:!1},{name:"temperature",min:void 0!==e.min?e.min:-15,max:void 0!==e.max?1.2*e.max:35,axis:"temperature",majorGridLines:{visible:!1},majorUnit:(Y=void 0!==e.min?e.min:-15,R=((void 0!==e.max?1.2*e.max:35)-Y)/5,M.convertNumberFormat(R)),labels:{template:function(t){return M.convertNumberFormat(t.value)}}}],categories:r}},Z=function(t,e,a){var o=K(t,e,a),n={selectionTooltip:{isVisible:!0,width:300,seriesKeysForRowName:["name"],rowGroupNames:[]},axisDefaults:{line:{visible:!1},majorGridLines:{color:"#d6d6d6"}},seriesDefaults:{spacing:.1,gap:.2,overlay:{gradient:"none"},border:{width:0}},chartArea:{background:"#fbfbfb",height:$("#consumption-main-view-content").height()-34,width:$("#consumption-main-view").width()},plotArea:{border:{},background:"#f7f7f8"},legend:{visible:!1},xAxis:{border:{color:"#444"}},series:o.setSeries,valueAxes:o.setValueAxes,categoryAxis:{categories:o.categories,axisCrossingValues:[0,0,100,100]}};$("#consumption-main-view-content").prepend(tt);var r=$("#device-type-list").val();return r=r||"none",$(".energy-consumption-graphTopBox").find(".left .graph-unit").html(Y[r][0]),$(".energy-consumption-graphTopBox").find(".right .graph-unit").html(Y[r][1]),s.createNewWidget("consumption-chart",_.dataviz.ui.Chart,n)},tt='<div class="energy-consumption-graphTopBox"><div class="left"><span class="graph-unit"></span><span class="checkLabel"><input type="checkbox" class="k-checkbox" id="targetEnergy" checked="checked"><label for="targetEnergy" class="k-checkbox-label">'+O.ENERGY_TARGET_ENERGY+'</label>\t\t\t</span></div><div class="right"><span class="graph-unit"></span><ul><li><span class="line" style="background-color:#808080"><em class="circle" style="background-color:#808080"></em></span>'+b.prop("FACILITY_DEVICE_OUTDOOR_TEMPERATURE")+'</li><li><span class="square" style="background-color:#0081c6"></span>'+b.prop("ENERGY_SAC")+'</li><li><span class="square" style="background-color:#4ca7d7"></span>'+b.prop("ENERGY_LIGHT")+'</li><li><span class="square" style="background-color:#99cde8"></span>'+b.prop("ENERGY_OTHERS")+"</li></ul></div></div>";f={time:function(t){var e,a=C.formattedDate.split("-");return 0==t.month||t.month?(e=String(t.month).length<2?a[0]+"-0"+t.month:a[0]+"-"+t.month,String(e)):0==t.hour||t.hour?(e=String(t.hour).length<2?String(t.hour+1).length<2?"0"+t.hour+":00 ~ 0"+(t.hour+1)+":00":"0"+t.hour+":00 ~ "+(t.hour+1)+":00":t.hour+":00 ~ "+(t.hour+1)+":00",String(e)):0==t.day||t.day?(e=String(t.day).length<2?a[0]+"-"+a[1]+"-0"+t.day:a[0]+"-"+a[1]+"-"+t.day,String(e)):"-"},temperature:function(t){return 0==t.degree||t.degree?'<span class="text-box">'+t.degree.toFixed(1)+"</span>":'<span class="text-box">-</span>'},total:function(t){var e="none";return(t.day||t.month)&&t.target&&t.total&&t.total>t.target&&(e="up"),0==t.total||t.total?'<span class="text-box '+e+'">'+t.total+"</span>":'<span class="text-box">-</span>'},sac:function(t){return 0==t.sac||t.sac?'<span class="text-box">'+t.sac+"</span>":'<span class="text-box">-</span>'},light:function(t){return 0==t.light||t.light?'<span class="text-box">'+t.light+"</span>":'<span class="text-box">-</span>'},others:function(t){return 0==t.others||t.others?'<span class="text-box">'+t.others+"</span>":'<span class="text-box">-</span>'},target:function(t){return 0==t.target||t.target?'<span class="text-box">'+Number(t.target).toFixed(1)+"</span>":'<span class="text-box">-</span>'},temperatureAverage:function(t){return t.degree&&t.degree.average?t.degree.average.toFixed(1):t.degree&&0==t.degree.sum?t.degree.sum:"-"},totalSum:function(t){return t.total&&t.total.sum?Number(t.total.sum).toFixed(0):t.total&&0==t.total.sum?t.total.sum:"-"},targetSum:function(t){return t.target&&t.target.sum?Number(t.target.sum).toFixed(1):t.target&&0==t.target.sum?Number(t.target.sum).toFixed(1):"-"},sacSum:function(t){return t.sac&&t.sac.sum?t.sac.sum.toFixed(0):t.sac&&0==t.sac.sum?t.sac.sum:"-"},lightSum:function(t){return t.light&&t.light.sum?t.light.sum.toFixed(0):t.light&&0==t.light.sum?t.light.sum:"-"},othersSum:function(t){return t.others&&t.others.sum?t.others.sum.toFixed(0):t.others&&0==t.others.sum?t.others.sum:"-"}};var et=function(t,e,a){var o,n=C.formattedDate.split("-"),r=$("#device-type-list").val(),i=Y[r]?" "+Y[r][0]:"";t=z(t,e,a),3==n.length&&(o="hour"),2==n.length&&(o="day"),1==n.length&&(o="month");var l={columns:[{field:o,title:O.COMMON_TIME,footerTemplate:O.COMMON_TIME,footerAttributes:{class:"table-footer-cell1"},attributes:{"data-name":"month"},width:100,format:"",editable:!1,template:f.time},{field:"temperature",title:"Fahrenheit"==R?b.prop("ENERGY_OUTDOOR_TEMPERATURE_FAHRENHEIT"):b.prop("ENERGY_OUTDOOR_TEMPERATURE_CELSIUS"),footerTemplate:"-",footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"temperature"},width:100,format:"",editable:!1,template:f.temperature},{field:"total",title:O.ENERGY_GIRD_TOTAL+i,footerTemplate:"-",footerAttributes:{class:"table-footer-cell2"},attributes:{"data-name":"total"},width:100,format:"",editable:!1,template:f.total},{field:"sac",title:O.ENERGY_SAC+i,footerTemplate:"-",footerAttributes:{class:"table-footer-cell3"},attributes:{"data-name":"sac"},width:100,format:"",editable:!1,template:f.sac},{field:"light",title:O.ENERGY_LIGHT+i,footerTemplate:"-",footerAttributes:{class:"table-footer-cell4"},attributes:{"data-name":"light"},width:100,format:"",editable:!1,template:f.light},{field:"others",title:O.ENERGY_OTHERS+i,footerTemplate:"-",footerAttributes:{class:"table-footer-cell5"},attributes:{"data-name":"others"},width:100,format:"",editable:!1,template:f.others}],dataSource:t,height:650,scrollable:!0,groupable:!1,sortable:!0,filterable:!1,pageable:!1,hasCheckedModel:!1,toolbar:["excel"],excel:{allPages:!0},excelExport:at,setCheckedAttribute:!1};return s.createNewWidget("consumption-grid",_.ui.Grid,l)},at=function(t){var e,a,o=C.formattedDate.split("-"),n=0,r=new Date(Number(o[0]),Number(o[1]),0).getDate();3==o.length&&(a="hour",e=o[0]+"."+o[1]+"."+o[2]+" 00:00~"+o[0]+"."+o[1]+"."+o[2]+" 24:00"),2==o.length&&(a="day",e=o[0]+"."+o[1]+".01~"+o[0]+"."+o[1]+"."+r),1==o.length&&(a="month",e=o[0]+".01.01~"+o[0]+".12.31");var i,l,s="",d="",c="";if(c="",s=(i=$("#device-type-list").val())?k[i]:O.ENERGY_ENERGY_METER_TYPE+" ",c="",(l=$("#group-list").data("kendoDropDownCheckBox")._getSelectedItemsText()).length==$("#group-list").data("kendoDropDownCheckBox").dataSource._data.length)d=O.ENERGY_ALL_DEVICE_GROUP,0==l.length&&(d="No Group");else for(var u=0;u<l.length;u++)0<u&&(c=","),d+=c+l[u];for(var g,h,p,m,f,E,v,y,_=[{cells:[{background:"#fff",colSpan:3,color:"#333",rowSpan:1,value:""}],type:"header"},{cells:[{background:"#fff",colSpan:2,color:"#333",rowSpan:1,value:s+" - "+d}],type:"header"},{cells:[{background:"#7a7a7a",colSpan:1,color:"#fff",rowSpan:2,value:O.ENERGY_INQUIRY_TARGET},{background:"#fff",colSpan:2,color:"#333",rowSpan:1,value:O.ENERGY_NUMBER_OF_GROUP+" : "+l.length}],type:"header"},{cells:[{background:"#7a7a7a",colSpan:1,color:"#fff",rowSpan:1,value:O.ENERGY_INQUIRED_PERIOD},{background:"#fff",colSpan:2,color:"#333",rowSpan:1,value:e}],type:"header"}],b=0,T=0,N=0,w=0,D=0,R=0,Y=0;Y<t.data.length;Y++){y=Y+1;var A=t.workbook.sheets[0].rows[y].cells;"data"==t.workbook.sheets[0].rows[y].type&&(t.data[Y][a]||0==t.data[Y][a]?("hour"==a&&(v=String(t.data[Y][a]).length<2?String(t.data[Y][a]+1).length<2?"0"+t.data[Y][a]+":00 ~ 0"+(t.data[Y][a]+1)+":00":"0"+t.data[Y][a]+":00 ~ "+(t.data[Y][a]+1)+":00":t.data[Y][a]+":00 ~ "+(t.data[Y][a]+1)+":00"),"day"==a&&(v=String(t.data[Y][a]).length<2?o[0]+"-"+o[1]+"-0"+t.data[Y][a]:o[0]+"-"+o[1]+"-"+t.data[Y][a]),"month"==a&&(v=String(t.data[Y][a]).length<2?o[0]+"-0"+t.data[Y][a]:o[0]+"-"+t.data[Y][a])):v="-",t.data[Y].degree||0==t.data[Y].degree?(g=t.data[Y].degree.toFixed(1),n++):g="-",h=t.data[Y].total||0==t.data[Y].total?t.data[Y].total:"-",p=t.data[Y].sac||0==t.data[Y].sac?t.data[Y].sac:"-",f=t.data[Y].light||0==t.data[Y].light?t.data[Y].light:"-",E=t.data[Y].others||0==t.data[Y].others?t.data[Y].others:"-","hour"==a?(A[0].value=v,A[1].value=g,A[2].value=h,A[3].value=p,A[4].value=f,A[5].value=E):(t.data[Y].target||0==t.data[Y].target?(m=t.data[Y].target.toFixed(1),N+=Number(t.data[Y].target)):m="-",A[0].value=v,A[1].value=g,A[2].value=m,A[3].value=h,A[4].value=p,A[5].value=f,A[6].value=E),"-"!==g&&(b+=Number(g)),"-"!==h&&(T+=Number(h)),"-"!==p&&(w+=Number(p)),"-"!==f&&(D+=Number(f)),"-"!==E&&(R+=Number(E)))}var x=t.workbook.sheets[0].rows[t.workbook.sheets[0].rows.length-1].cells;"hour"==a?(x[1].value=0==b?b="-":(b/n).toFixed(1),x[2].value=0==T?T="-":T,x[3].value=0==w?w="-":w,x[4].value=0==D?D="-":D,x[5].value=0==R?R="-":R):(x[1].value=0==b?b="-":(b/n).toFixed(1),x[2].value=0==N?N="-":N.toFixed(1),x[3].value=0==T?T="-":T,x[4].value=0==w?w="-":w,x[5].value=0==D?D="-":D,x[6].value=0==R?R="-":R);for(var G=0;G<_.length;G++)t.workbook.sheets[0].rows.unshift(_[G])},ot=[{field:"degree",aggregate:"average"},{field:"target",aggregate:"sum"},{field:"total",aggregate:"sum"},{field:"sac",aggregate:"sum"},{field:"light",aggregate:"sum"},{field:"others",aggregate:"sum"}];!function(){m();var t=n.contentElement(0);T.open(),A();var e=h.find(".k-tabstrip-items");_.bind(e,C),_.bind($(t),C),V(),C.graphBtn.click(),$.ajax({url:"/dms/groups"}).done(function(t){C.filters[1].options.set("dataSource",t),0===t.length&&$("#group-list").data("kendoDropDownCheckBox").unselectAll()}).fail(function(t){var e=M.parseFailResponse(t);D.message(e),D.open()}).always(function(){$("#device-type-list").val()?C.filters[1].set("disabled",!1):C.filters[1].set("disabled",!0),a.on("onfloorchange",p);var t=window.localStorage.getItem("dashboardShortcut");if(t){window.localStorage.removeItem("dashboardShortcut");var e=h.find(".k-tabstrip-items .k-item[data-role='"+t+"']").index();n.select(e)}}),$("#group-list").data("kendoDropDownCheckBox").options.cancelOption=!0,C.nextBtn.set("disabled",!0)}()});